<!DOCTYPE html>
<html lang="id">
<head>
	
  <!-- Charset & Viewport -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Judul -->
  <title>Mutaba'ah Tahfidz Digital</title>

  <!-- Favicon untuk browser -->
  <link rel="icon" href="./icon-192.png" type="image/png" sizes="192x192" />
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/mrdickymiswardi/web/refs/heads/main/logo.png" />

  <!-- Open Graph Meta Tags (untuk WhatsApp, FB, Telegram) -->
  <meta property="og:title" content="Portal Mutaba'ah Tahfidz" />
  <meta property="og:description" content="Mudah, simpel, akurat. Sesuai halaman Mushaf Madinah. Dilengkapi laporan otomatis." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://mrdickymiswardi.netlify.app/" />

  <!-- Gunakan gambar 512x512 -->
  <meta property="og:image" content="https://raw.githubusercontent.com/mrdickymiswardi/web/refs/heads/main/logo.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="512" />
  <meta property="og:image:height" content="512" />

  <!-- Warna tema untuk mobile browser -->
  <meta name="theme-color" content="#2563eb" />
	
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f4f6f8;
  font-size: 12px; /* ini akan kecilkan semua font */
}

    button.lihat-quran-btn {
  all: unset; /* reset semua style bawaan */
  display: inline-block;
  font-weight: 600;
  font-size: 12px;
  letter-spacing: 0.3px;
  color: #1E88E5;
  padding: 2px 4px;
  cursor: pointer;
  position: relative;
  transition: color 0.00s ease;
}

/* underline animasi halus */
button.lihat-quran-btn::after {
  content: "";
  position: absolute;
  left: 0;
  bottom: -2px;
  width: 0%;
  height: 2px;
  background-color: currentColor;
  transition: width 0.00s ease;
}

button.lihat-quran-btn:hover {
  color: #ffffff;
}

button.lihat-quran-btn:hover::after {
  width: 100%;
}

#santri-table th:first-child,
#santri-table td:first-child {
  position: sticky;
  left: 0;
  background: white;
  z-index: 5;
  border-right: 1px solid #ccc; /* opsional, biar ada garis pembatas */
}

	  /* ----- Sticky header umum (baris judul tetap di atas) ----- */
#santri-table thead th {
  position: sticky;
  top: 0;
  z-index: 3;              /* di atas sel body biasa */
  background: #1e88e5;     /* ulangi background agar tidak transparan */
  color: #fff;
}

/* ----- Sudut kiri atas: header kolom pertama ----- */
#santri-table thead th:first-child {
  position: sticky;
  left: 0;                 /* sudah ada, tambahkan top agar tak ketutup */
  top: 0;
  z-index: 6;              /* paling tinggi agar tidak ketiban apa pun */
  background: #1e88e5;     /* samakan warna header */
}

/* ----- Kolom pertama di body ikut sticky kiri ----- */
#santri-table tbody td:first-child {
  position: sticky;
  left: 0;
  background: #fff;        /* wajib: kalau transparan, akan ‚Äòtembus‚Äô */
  z-index: 5;              /* di bawah th:first-child, di atas sel lain */
  border-right: 1px solid #ccc;
}

    .password-wrapper {
  position: relative;
  width: 100%;
}

.password-wrapper input {
  width: 100%;
  padding-right: 40px; /* ruang untuk icon üëÅ */
  box-sizing: border-box;
}

.toggle-password {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  user-select: none;
  font-size: 12px;
}

    .password-login-group {
  display: flex;
  align-items: center;
  gap: 8px; /* jarak antara password dan tombol login */
}

.password-login-group button {
  white-space: nowrap; /* biar tulisan "Login" nggak pecah */
}

    #username {
  width: 314px; /* atur lebar sesuai kebutuhan */
  max-width: 100%; /* biar tetap responsif di layar kecil */
  box-sizing: border-box; /* supaya padding ikut hitung lebar */
}


   .modal {
  position: fixed;
  z-index: 999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 10px; /* Tambahan: agar konten modal tidak nempel di tepi */
  box-sizing: border-box;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 10px;
  width: 100%;
  max-width: 300px; /* Batasi ukuran maksimum di desktop */
  box-sizing: border-box;
}

/* Responsif tambahan (opsional) */
@media (max-width: 400px) {
  .modal-content {
    padding: 15px;
    font-size: 12px;
  }
}

    .login-actions {
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 15px;
}

@media (max-width: 600px) {
  .login-actions {
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
  }

  .login-actions button {
    width: 100%;
  }
}

.dashboard-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.dashboard-header-row {
  display: flex;
  flex-direction: row;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
  justify-content: center;
}

.dashboard-header label {
  font-size: 12px;
}

.dashboard-header select,
.dashboard-header input[type="date"] {
  padding: 8px;
  font-size: 12px;
  border-radius: 6px;
  border: 1px solid #ccc;
  min-width: 140px;
}

/* üåê Tambahkan ini untuk mobile */
@media (max-width: 600px) {
  .dashboard-header-row {
    flex-direction: column;
    align-items: stretch;
  }

  .dashboard-header label {
    text-align: left;
    width: 100%;
  }
}
    
    .total-all-juz span {
  font-weight: bold;
  background: #e0f2f1;
  border-radius: 4px;
  padding: 1px 4px;
}
    .container {
  max-width: 1400px;
  margin: 0;               /* tidak ada margin sama sekali */
  padding: 0;              /* tidak ada padding sama sekali */
}

	  /* Bedakan login card */
#login-card {
  max-width: 400px;
  margin: 80px auto;   /* naik turun 80px, horizontal auto */
  padding: 20px;
  box-sizing: border-box;
}

/* Atur agar konten login tetap center di layar */
@media (min-height: 600px) {
  #login-card {
    margin-top: 10vh;  /* 10% dari tinggi layar, lebih responsif */
  }
}
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-top: 0px;
    }
    h1, h2 {
      text-align: center;
    }
    form, .dashboard-header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      margin-top: 0px;
    }
    input, select, button {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 12px;
    }
    button {
      background: #1e88e5;
      color: white;
      cursor: pointer;
      margin: 2px;
    }
    button:hover {
      background: #1565c0;
    }
    .logout-btn {
      background: #e53935;
    }
    .logout-btn:hover {
      background: #b71c1c;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #1e88e5;
      color: white;
    }
    .actions {
      text-align: center;
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .password-group {
      display: flex;
      gap: 5px;
      align-items: center;
    }
    .toggle-btn {
      background: #6c757d;
      font-size: 12px;
      padding: 10px 14px;
    }
    .toggle-btn:hover {
      background: #495057;
    }

	  
/* Overlay Loading */
#overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  z-index: 1000;

  /* DEFAULT: sembunyi (jangan ditimpa lagi) */
  display: none;

  /* centering saat AKTIF (lihat aturan .is-active di bawah) */
  align-items: center;
  justify-content: center;
}

/* TAMPILKAN overlay dengan menambah class .is-active */
#overlay.is-active {
  display: flex;
}

/* kotak putih dengan ukuran bisa diatur */
#overlay span {
  background: #fff;
  width: 60px;                  /* atur lebar kotak */
  height: 68px;                 /* atur tinggi kotak */
  border-radius: 8px;
  color: #333;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);

  display: flex;
  align-items: center;
  justify-content: center;
}

/* GIF dengan ukuran bisa diatur */
#overlay img {
  width: 48px;                  /* atur lebar GIF */
  height: 54px;                 /* atur tinggi GIF */
  object-fit: contain;          /* jaga proporsi GIF */
  display: block;
}

@media (max-width: 768px) {
  .dashboard-header { flex-direction: column; align-items: stretch; }
  table { display: block; overflow-x: auto; white-space: nowrap; }
  .actions { flex-direction: column; }
  .password-group { flex-direction: row; }
}

	  
	  /* === OVERRIDE: samakan mobile dengan desktop untuk area tombol login === */
@media (max-width: 600px) {
  .login-actions {
    display: flex;
    flex-direction: row;   /* jangan kolom */
    flex-wrap: wrap;       /* turun baris kalau sempit */
    justify-content: center;
    gap: 10px;
  }
  .login-actions button {
    width: auto;           /* jangan full width */
    min-width: 150px;      /* biar konsisten seperti desktop */
  }

  /* pastikan input password + tombol Login tetap sejajar */
  .password-login-group {
    flex-direction: row;
    flex-wrap: nowrap;
  }
  .password-wrapper { flex: 1; }   /* input melar, tombol tetap di kanan */
}
  </style>
</head>
<body>

<!-- HAPUS inline style="display:flex" agar tidak muncul saat awal load -->
<div id="overlay"><span>
<img src="https://raw.githubusercontent.com/mrdickymiswardi/web/main/Stopwatch.gif"></span>
</div>

<div class="container"> 
  <!-- Halaman Login -->
  <div id="login-card" class="card">
    <h1>Mutaba'ah Tahfidz Online</h1>
    <form id="login-form">
      <input type="text" id="username" placeholder="Username" required />
      <div class="password-group" style="display: flex; align-items: center;">
   <div class="password-wrapper">
    <input type="password" id="password" placeholder="Password" required />
    <span id="toggle-password" class="toggle-password">üëÅ</span>
  </div>
  <button type="submit">Masuk</button>
</div>



      <div class="login-actions">
        <button type="button" onclick="toggleChangePassword()">Ganti Password</button>
        <button type="button" onclick="munculkanModalDaftarAdmin()">Daftar Admin</button>
        <button type="button" onclick="munculkanValidasiAdmin()">Daftar User Kelas</button>
		<button type="button" onclick="bukaModalTambahKelas()">Tambah Kelas</button>
		<button type="button" onclick="munculkanValidasiAdminNIS()">Daftar User NIS</button>
      </div>
    </form>



	  <!-- Overlay Ganti Password -->
<div id="change-password-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; width:300px; position:relative;">
    <h3 style="margin-top:0;">Ganti Password</h3>
    <input type="text" id="change-username" placeholder="Username" required style="width:80%; margin-bottom:8px;" />
    <input type="password" id="old-password" placeholder="Password Lama" required style="width:80%; margin-bottom:8px;" />
<input type="password" id="new-password" placeholder="Password Baru" required style="width:80%; margin-bottom:8px;" />

<label style="display:block; margin-bottom:10px;">
  <input type="checkbox" onclick="togglePasswordVisibility()"> Lihat Password
</label>
    <button id="save-password-btn" type="button" onclick="submitPasswordChange()" style="width:90%;">Simpan</button>
    <p id="change-password-msg" style="color:red; margin-top:10px;"></p>
    <button onclick="toggleChangePassword()" style="position:absolute; top:5px; right:10px;">‚úñ</button>
  </div>
</div>

    <p id="login-error" style="color: red; display: none;">Username atau password salah!</p>
    
  </div>
</div>

	<script>
  function toggleChangePassword() {
    const overlay = document.getElementById("change-password-overlay");
    const isOpen = overlay.style.display === "flex";
    overlay.style.display = isOpen ? "none" : "flex";
    const msg = document.getElementById("change-password-msg");
    msg.textContent = "";
    msg.style.color = ""; // reset warna
    if (!isOpen) {
      // optional: bersihkan input saat buka
      ["change-username","old-password","new-password"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
    }
  }

  async function submitPasswordChange() {
    const username = document.getElementById("change-username").value.trim();
    const oldPassword = document.getElementById("old-password").value;
    const newPassword = document.getElementById("new-password").value;
    const msgEl = document.getElementById("change-password-msg");
    const saveBtn = document.getElementById("save-password-btn");

    if (!username || !oldPassword || !newPassword) {
      msgEl.style.color = "red";
      msgEl.textContent = "Semua kolom wajib diisi.";
      return;
    }

    saveBtn.disabled = true;
    saveBtn.textContent = "Menyimpan...";

    try {
      const res = await fetch("/api/changePassword", {
        method: "POST",
        headers: { "Content-Type": "application/json" }, // PENTING
        body: JSON.stringify({ username, oldPassword, newPassword })
      });

      // Coba parse JSON; kalau gagal, fallback ke text untuk lihat error asli
      let data = null;
      const raw = await res.text();
      try { data = raw ? JSON.parse(raw) : null; } catch { /* bukan JSON */ }

      if (res.ok) {
        msgEl.style.color = "green";
        msgEl.textContent = (data && data.message) || "Berhasil mengganti password.";
        setTimeout(() => toggleChangePassword(), 1000);
      } else {
        msgEl.style.color = "red";
        // Tampilkan detail bantu-diagnosa (source/step/status dari server kita)
        const detail =
          data?.message ||
          data?.error ||
          raw ||
          `Gagal (${res.status} ${res.statusText})`;

        msgEl.textContent = detail;
      }
    } catch (err) {
      msgEl.style.color = "red";
      msgEl.textContent = "Terjadi kesalahan jaringan.";
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = "Simpan";
    }
  }

  function togglePasswordVisibility() {
    const oldPass = document.getElementById("old-password");
    const newPass = document.getElementById("new-password");
    const type = oldPass.type === "password" ? "text" : "password";
    oldPass.type = type;
    newPass.type = type;
  }

  // Opsional: submit dengan Enter di field password baru
  document.addEventListener("DOMContentLoaded", () => {
    const np = document.getElementById("new-password");
    if (np) {
      np.addEventListener("keydown", (e) => {
        if (e.key === "Enter") submitPasswordChange();
      });
    }
  });
</script>


<!-- Daftar Admin -->
<!-- Modal Validasi Admin -->
<div id="modalAdminDaftar" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Masukkan Password Admin</h3>
    <label>Password Admin: <input type="password" id="adminPasswordInputDaftar"></label>
    <p id="adminErrorDaftar" style="color:red;"></p>
    <button onclick="cekPasswordAdminDaftar()">Submit</button>
    <button onclick="tutupModal('modalAdminDaftar')">Close</button>
  </div>
</div>

<!-- Modal Form Daftar Admin -->
<div id="modalDaftarAdmin" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Daftar Admin</h3>

    <label>Username: <input type="text" id="usernameAdmin"></label><br>
    <label>Password: <input type="password" id="passwordAdmin"></label><br>
    <label><input type="checkbox" onclick="toggleLihatPasswordAdmin()"> Lihat Password</label><br><br>

    <button onclick="buatAdminBaru()">Create Admin</button>
    <button onclick="tutupModal('modalDaftarAdmin')">Close</button>

    <p id="daftarAdminError" style="color:red;"></p>
    <p id="daftarAdminSuccess" style="color:green;"></p>
  </div>
</div>

	<script>
function munculkanModalDaftarAdmin() {
  document.getElementById("modalAdminDaftar").style.display = "flex";
}

// Toggle password
function toggleLihatPasswordAdmin() {
  const input = document.getElementById("passwordAdmin");
  input.type = input.type === "password" ? "text" : "password";
}

// Validasi password admin
async function cekPasswordAdminDaftar() {
  const password = document.getElementById("adminPasswordInputDaftar").value.trim();
  const errorEl = document.getElementById("adminErrorDaftar");
  errorEl.textContent = "";

  if (!password) {
    errorEl.textContent = "Password admin wajib diisi.";
    return;
  }

  try {
    const res = await fetch("/api/cek-admin", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password }),
    });

    const data = await res.json();
    if (!res.ok) {
      errorEl.textContent = data.message || "Password admin salah.";
      return;
    }

    // Sembunyikan modal validasi dan tampilkan modal daftar admin
    tutupModal("modalAdminDaftar");
    document.getElementById("modalDaftarAdmin").style.display = "flex";

  } catch (err) {
    console.error(err);
    errorEl.textContent = "Terjadi kesalahan saat menghubungi server.";
  }
}

// Fungsi membuat admin baru
async function buatAdminBaru() {
  const username = document.getElementById("usernameAdmin").value.trim();
  const password = document.getElementById("passwordAdmin").value;
  const errorEl = document.getElementById("daftarAdminError");
  const successEl = document.getElementById("daftarAdminSuccess");

  errorEl.textContent = "";
  successEl.textContent = "";

  if (!username || !password) {
    errorEl.textContent = "Username dan password wajib diisi.";
    return;
  }

  const konfirmasi = confirm(`Yakin ingin mendaftar admin baru: ${username}?`);
  if (!konfirmasi) return;

  try {
    const res = await fetch("/api/daftar-user", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password, role: "admin" }),
    });

    const hasil = await res.json();

    if (res.ok) {
      successEl.textContent = "üéâ Pendaftaran berhasil! Silakan login.";
      document.getElementById("usernameAdmin").value = "";
      document.getElementById("passwordAdmin").value = "";
    } else {
      errorEl.textContent = hasil.message || "Gagal mendaftar.";
    }

  } catch (err) {
    console.error(err);
    errorEl.textContent = "Terjadi kesalahan saat menghubungi server.";
  }
}

// Fungsi tutup modal
function tutupModal(id) {
  document.getElementById(id).style.display = "none";
}
</script>



	<!-- Daftar User Kelas -->
<div id="modalAdmin" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Masukkan Password Admin</h3>
     <label>Password Admin: <input type="password" id="adminPasswordInput"></label>
    <p id="adminError" style="color:red;"></p>
    <button onclick="cekPasswordAdmin()">Submit</button>
    <button onclick="tutupModal('modalAdmin')">Close</button>
  </div>
</div>

<!-- Modal Form Daftar Akun -->
<div id="modalDaftar" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Daftar User Kelas</h3>
    <label>Username: <input type="text" id="newUsername"></label><br>
    <label>Password: <input type="password" id="newPassword"></label>
    <br></br>
    <label><input type="checkbox" onclick="toggleLihatPassword()"> Lihat Password</label><br><br>

    <div id="kelasCheckboxContainer">üîÑ Memuat daftar kelas...</div><br>

    <button onclick="buatAkunBaru()">Create Account</button>
    <button onclick="tutupModal('modalDaftar')">Close</button>
    <p id="daftarError" style="color:red;"></p>
    <p id="daftarSuccess" style="color:green;"></p>
  </div>
</div>

	<script>
function munculkanValidasiAdmin() {
  document.getElementById("modalAdmin").style.display = "flex";
  document.getElementById("adminPasswordInput").value = "";
  document.getElementById("adminError").textContent = "";
}

// Fungsi untuk cek password admin
async function cekPasswordAdmin() {
  const password = document.getElementById("adminPasswordInput").value;

  if (!password) {
    document.getElementById("adminError").textContent = "Password wajib diisi.";
    return;
  }

  const response = await fetch('/api/cek-admin', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ password })
  });

  const result = await response.json();

  if (response.status === 200) {
    tutupModal("modalAdmin");
    bukaFormDaftar(password); // password disimpan sementara
  } else {
    document.getElementById("adminError").textContent = result.message || "Gagal validasi.";
  }
}

// Buka modal daftar setelah validasi admin sukses
let adminPasswordGlobal = "";
function bukaFormDaftar(adminPass) {
  adminPasswordGlobal = adminPass;
  document.getElementById("modalDaftar").style.display = "flex";
  document.getElementById("daftarError").textContent = "";
  document.getElementById("daftarSuccess").textContent = "";
  ambilDaftarKelas(); // Load daftar kelas dari GitHub
}

// Tutup modal
function tutupModal(id) {
  document.getElementById(id).style.display = "none";
}

// Toggle lihat password
function toggleLihatPassword() {
  const pwField = document.getElementById("newPassword");
  pwField.type = pwField.type === "password" ? "text" : "password";
}
</script>

  <script>
async function ambilDaftarKelas() {
  const container = document.getElementById("kelasCheckboxContainer");
  container.innerHTML = "üîÑ Memuat daftar kelas...";

  try {
    const res = await fetch("https://api.github.com/repos/mrdickymiswardi/server/contents");
    const data = await res.json();

    // Filter nama file seperti: kelas_1.json
    const kelasFiles = data.filter(file => /^kelas_\d+\.json$/.test(file.name));

    if (kelasFiles.length === 0) {
      container.innerHTML = "‚ùå Tidak ada file kelas_{}.json ditemukan.";
      return;
    }

    container.innerHTML = ""; // Bersihkan

    kelasFiles.forEach(file => {
      const kelas = file.name.replace(".json", ""); // contoh: kelas_1
      const label = document.createElement("label");
      label.innerHTML = `<input type="checkbox" value="${kelas}"> ${kelas}<br>`;
      container.appendChild(label);
    });
  } catch (err) {
    container.innerHTML = "‚ùå Gagal memuat kelas.";
    console.error("Gagal fetch kelas:", err);
  }
}
</script>
  
  <script>
    async function ambilDaftarKelas() {
  const container = document.getElementById("kelasCheckboxContainer");
  container.innerHTML = "üîÑ Memuat daftar kelas...";

  try {
    const res = await fetch("/api/ambil-kelas");
    const kelasList = await res.json();

    if (!Array.isArray(kelasList) || kelasList.length === 0) {
      container.innerHTML = "‚ùå Tidak ada kelas ditemukan.";
      return;
    }

    container.innerHTML = ""; // Bersihkan

    kelasList.forEach(kelas => {
      const label = document.createElement("label");
      label.innerHTML = `<input type="checkbox" value="${kelas}"> ${kelas}<br>`;
      container.appendChild(label);
    });
  } catch (err) {
    container.innerHTML = "‚ùå Gagal memuat kelas.";
    console.error("Gagal fetch kelas:", err);
  }
}
  </script>

  <script>
async function buatAkunBaru() {
  const username = document.getElementById("newUsername").value.trim();
  const password = document.getElementById("newPassword").value.trim();
  const kelasChecked = Array.from(
    document.querySelectorAll('#kelasCheckboxContainer input:checked')
  ).map(cb => cb.value);

  const errorEl = document.getElementById("daftarError");
  const successEl = document.getElementById("daftarSuccess");

  errorEl.textContent = "";
  successEl.textContent = "";

  if (!username || !password || kelasChecked.length === 0) {
    errorEl.textContent = "Semua kolom dan kelas wajib diisi.";
    return;
  }

  const payload = {
    username,
    password,
    kelas: kelasChecked,
    adminPassword: adminPasswordGlobal
  };

  try {
    const res = await fetch('/api/daftar-khusus', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const result = await res.json();

    if (res.status === 200) {
      successEl.textContent = "‚úÖ Akun berhasil dibuat.";
      // Reset form
      document.getElementById("newUsername").value = "";
      document.getElementById("newPassword").value = "";
      document.querySelectorAll('#kelasCheckboxContainer input:checked')
              .forEach(cb => cb.checked = false);
    } else {
      errorEl.textContent = result.message || "‚ùå Gagal membuat akun.";
    }
  } catch (err) {
    console.error("Gagal kirim data:", err);
    errorEl.textContent = "Terjadi kesalahan jaringan.";
  }
}
</script>


<!-- Tambah Kelas -->
    <div id="modalTambahKelasPassword" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Verifikasi Admin</h3>
    <label>Password Admin: <input type="password" id="inputPasswordTambahKelas"></label>
    <p id="statusPasswordTambahKelas" style="color:red;"></p>
    <button onclick="verifikasiAdminTambahKelas()">Submit</button>
    <button onclick="tutupModal('modalTambahKelasPassword')">Close</button>
  </div>
</div>


    <div id="modalFormTambahKelas" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Tambah Kelas Baru</h3>
    <p>Kelas yang sudah ada:</p>
    <ul id="listKelasTersedia"></ul>
    <input type="number" id="inputNomorKelasBaruTambah" placeholder="Contoh: 7" />
    <button onclick="submitTambahKelasBaru()">Buat</button>
    <button onclick="tutupModal('modalFormTambahKelas')">Close</button>
    <p id="statusTambahKelasBaru" style="color:red;"></p>
  </div>
</div>


	<script>
let passwordTambahKelas = "";

function bukaModalTambahKelas() {
  document.getElementById("modalTambahKelasPassword").style.display = "flex";
}

function tutupModal(id) {
  document.getElementById(id).style.display = "none";
}

async function verifikasiAdminTambahKelas() {
  const passInput = document.getElementById("inputPasswordTambahKelas").value;
  const status = document.getElementById("statusPasswordTambahKelas");
  status.textContent = "‚è≥ Mengecek...";

  const res = await fetch("/api/cek-admin", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ password: passInput })
  });

  const result = await res.json();
  if (res.ok) {
    passwordTambahKelas = passInput;
    tutupModal("modalTambahKelasPassword");
    tampilkanFormTambahKelasBaru();
  } else {
    status.textContent = result.message || "‚ùå Password salah.";
  }
}

async function tampilkanFormTambahKelasBaru() {
  const list = document.getElementById("listKelasTersedia");
  const status = document.getElementById("statusTambahKelasBaru");
  document.getElementById("inputNomorKelasBaruTambah").value = "";
  list.innerHTML = "<li>üîÑ Mengambil data kelas...</li>";
  status.textContent = "";

  try {
    const res = await fetch("/api/ambil-kelas");
    const kelas = await res.json();
    list.innerHTML = "";
    kelas.forEach(nama => {
      const li = document.createElement("li");
      li.textContent = nama;
      list.appendChild(li);
    });

    document.getElementById("modalFormTambahKelas").style.display = "flex";
  } catch (err) {
    list.innerHTML = "<li>‚ùå Gagal mengambil daftar kelas.</li>";
  }
}

async function submitTambahKelasBaru() {
  const nomor = document.getElementById("inputNomorKelasBaruTambah").value.trim();
  const status = document.getElementById("statusTambahKelasBaru");

  if (!nomor) {
    status.textContent = "‚ùó Nomor kelas harus diisi.";
    return;
  }

  status.textContent = "‚è≥ Mengirim permintaan...";
  const res = await fetch("/api/buat-kelas-baru", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ namaFile: `kelas_${nomor}.json` })
  });

  const result = await res.json();
  if (res.ok) {
    status.style.color = "green";
    status.textContent = "‚úÖ Kelas berhasil dibuat.";
    setTimeout(() => tutupModal("modalFormTambahKelas"), 1500);
  } else {
    status.style.color = "red";
    status.textContent = result.message || "‚ùå Gagal membuat kelas.";
  }
}
</script>


<!-- Tombol Daftar User NIS -->
<!-- Modal Validasi Admin -->
<div id="modalAdminNIS" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Validasi Admin</h3>
    <label>Password Admin: <input type="password" id="adminPasswordInputNIS"></label>
    <p id="adminErrorNIS" style="color:red;"></p>
    <button onclick="cekPasswordAdminNIS()">Submit</button>
    <button onclick="tutupModal('modalAdminNIS')">Close</button>
  </div>
</div>

<!-- Modal Daftar User NIS -->
<div id="modalDaftarNIS" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Daftar User NIS</h3>
    <label>Username: <input type="text" id="newUsernameNIS"></label><br>
    <label>Password: <input type="password" id="newPasswordNIS"></label><br>
    <label><input type="checkbox" onclick="toggleLihatPasswordNIS()"> Lihat Password</label><br><br>

    <div id="kelasCheckboxContainerNIS">üîÑ Memuat daftar kelas...</div><br>
    <div id="nisCheckboxContainer">üîÑ Pilih kelas dahulu...</div><br>

    <button onclick="buatUserNIS()">Create User NIS</button>
    <button onclick="tutupModal('modalDaftarNIS')">Close</button>
    <p id="daftarNISError" style="color:red;"></p>
    <p id="daftarNISSuccess" style="color:green;"></p>
  </div>
</div>

<script>
/* =========================
   Helper kecil
========================= */
const _norm = v => String(v ?? '').trim().toLowerCase();
const _fetchJson = async (url, opt) => {
  const r = await fetch(url, opt);
  let data = null;
  try { data = await r.json(); } catch {}
  if (!r.ok) throw new Error((data && (data.error || data.message)) || `${r.status} ${r.statusText}`);
  return data;
};

let adminPasswordGlobalNIS = "";
let usedNisSet = new Set(); // diisi dari /api/getUsersNis

// Tampilkan modal validasi admin
function munculkanValidasiAdminNIS() {
  document.getElementById("modalAdminNIS").style.display = "flex";
  document.getElementById("adminPasswordInputNIS").value = "";
  document.getElementById("adminErrorNIS").textContent = "";
}

// Cek password admin
async function cekPasswordAdminNIS() {
  const password = document.getElementById("adminPasswordInputNIS").value;
  if (!password) { 
    document.getElementById("adminErrorNIS").textContent = "Password wajib diisi."; 
    return; 
  }

  try {
    const res = await fetch('/api/cekAdminWali', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ password })
    });
    const result = await res.json();

    if (res.status === 200) {
      adminPasswordGlobalNIS = password;
      tutupModal("modalAdminNIS");
      bukaFormDaftarNIS();
    } else {
      document.getElementById("adminErrorNIS").textContent = result.message || "Gagal validasi.";
    }
  } catch (e) {
    document.getElementById("adminErrorNIS").textContent = e.message || "Gagal validasi.";
  }
}

// Buka modal daftar NIS
async function bukaFormDaftarNIS() {
  document.getElementById("modalDaftarNIS").style.display = "flex";
  document.getElementById("daftarNISError").textContent = "";
  document.getElementById("daftarNISSuccess").textContent = "";
  document.getElementById("kelasCheckboxContainerNIS").innerHTML = "üîÑ Memuat daftar kelas...";
  document.getElementById("nisCheckboxContainer").innerHTML = "üîÑ Pilih kelas dahulu...";

  // 1) Ambil daftar NIS yang SUDAH terdaftar agar bisa disembunyikan
  try {
    const { usedNis = [] } = await _fetchJson('/api/getUsersNis');
    usedNisSet = new Set(usedNis.map(_norm));
  } catch (e) {
    // Kalau gagal, biarkan set kosong, UI tetap jalan
    usedNisSet = new Set();
    console.warn('Gagal ambil used NIS:', e);
  }

  // 2) Ambil daftar kelas
  ambilDaftarKelasNIS();
}

// Tutup modal
function tutupModal(id) { document.getElementById(id).style.display = "none"; }

// Toggle password
function toggleLihatPasswordNIS() {
  const pwField = document.getElementById("newPasswordNIS");
  pwField.type = pwField.type === "password" ? "text" : "password";
}

// Ambil daftar kelas
async function ambilDaftarKelasNIS() {
  const container = document.getElementById("kelasCheckboxContainerNIS");
  container.innerHTML = "üîÑ Memuat daftar kelas...";
  try {
    const res = await fetch("/api/ambil-kelas");
    const kelasList = await res.json();
    container.innerHTML = "";

    (kelasList || []).forEach(kelas => {
      const label = document.createElement("label");
      // PERTAHANKAN UI: onchange tetap memanggil ambilDaftarNIS(kelas)
      label.innerHTML = `<input type="checkbox" value="${kelas}" onchange="ambilDaftarNIS('${kelas}')"> ${kelas}<br>`;
      container.appendChild(label);
    });
  } catch(err) {
    container.innerHTML = "‚ùå Gagal memuat kelas.";
    console.error(err);
  }
}

// Ambil daftar NIS dari kelas TERPILIH (union), sembunyikan yang sudah terdaftar
async function ambilDaftarNIS(/*kelasDiklik*/) {
  const container = document.getElementById("nisCheckboxContainer");
  container.innerHTML = "üîÑ Memuat NIS...";

  // Kumpulkan seluruh kelas yang sedang dicentang (UI dipertahankan: tetap pakai checkbox per kelas)
  const kelasDipilih = [...document.querySelectorAll("#kelasCheckboxContainerNIS input[type=checkbox]:checked")].map(cb => cb.value);

  if (!kelasDipilih.length) {
    container.innerHTML = "üîÑ Pilih kelas dahulu...";
    return;
  }

  try {
    // Ambil NIS tiap kelas secara paralel
    const settled = await Promise.allSettled(
      kelasDipilih.map(k => fetch(`/api/ambil-kelas-nis?kelas=${encodeURIComponent(k)}`).then(r => r.json()))
    );

    // Gabung unik per NIS dan FILTER yang sudah terdaftar
    const mapByNis = new Map(); // key = norm(nis) -> {nis, nama}
    for (const it of settled) {
      if (it.status !== 'fulfilled' || !Array.isArray(it.value)) continue;
      for (const s of it.value) {
        const nisRaw = s?.nis ?? s?.NIS ?? s?.id ?? '';
        const key = _norm(nisRaw);
        if (!key) continue;
        if (usedNisSet.has(key)) continue; // INI inti filter: jangan tampilkan NIS yang sudah terdaftar
        if (!mapByNis.has(key)) {
          mapByNis.set(key, { nis: String(nisRaw).trim(), nama: String(s?.nama ?? s?.name ?? '').trim() });
        }
      }
    }

    // Urutkan sederhana berdasar NIS
    const items = [...mapByNis.values()].sort((a,b) => String(a.nis).localeCompare(String(b.nis), 'id'));

    // PERTAHANKAN UI: render baris label + <br> seperti sebelumnya
    container.innerHTML = "";
    if (!items.length) {
      container.innerHTML = "Tidak ada NIS baru pada kelas terpilih.<br>";
      return;
    }
    items.forEach(santri => {
      const label = document.createElement("label");
      label.innerHTML = `<input type="checkbox" value="${santri.nis}"> ${santri.nis} - ${santri.nama}<br>`;
      container.appendChild(label);
    });
  } catch(err) {
    container.innerHTML = "‚ùå Gagal memuat NIS.";
    console.error(err);
  }
}

// Buat user NIS
async function buatUserNIS() {
  const username = document.getElementById("newUsernameNIS").value;
  const password = document.getElementById("newPasswordNIS").value;

  const kelasCheckboxes = document.querySelectorAll("#kelasCheckboxContainerNIS input[type=checkbox]:checked");
  const nisCheckboxes = document.querySelectorAll("#nisCheckboxContainer input[type=checkbox]:checked");

  if (!username || !password) { 
    document.getElementById("daftarNISError").textContent = "Username & Password wajib diisi."; 
    return; 
  }
  if (nisCheckboxes.length === 0) { 
    document.getElementById("daftarNISError").textContent = "Pilih minimal 1 NIS."; 
    return; 
  }

  const kelas = Array.from(kelasCheckboxes).map(c => c.value);
  const nis = Array.from(nisCheckboxes).map(n => n.value);

  // Safety kecil (front-end): pastikan tidak ada yang sudah used (harusnya sudah terseleksi)
  const adaDup = nis.some(n => usedNisSet.has(_norm(n)));
  if (adaDup) {
    document.getElementById("daftarNISError").textContent = "Ada NIS yang sudah terdaftar. Muat ulang daftar lalu pilih lagi.";
    return;
  }

  try {
    const res = await fetch('/api/daftarNisWali', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ username, password, kelas, nis, adminPassword: adminPasswordGlobalNIS })
    });
    const result = await res.json();

    if (res.status === 200) {
      document.getElementById("daftarNISSuccess").textContent = result.message || "Berhasil membuat user NIS.";
      document.getElementById("daftarNISError").textContent = "";

      // update usedNisSet agar NIS barusan langsung tidak tampil
      nis.forEach(n => usedNisSet.add(_norm(n)));
      // refresh daftar NIS sesuai kelas yang masih terpilih (UI tetap)
      ambilDaftarNIS();
    } else {
      document.getElementById("daftarNISError").textContent = result.message || "Gagal membuat user NIS.";
    }
  } catch (err) {
    document.getElementById("daftarNISError").textContent = err.message || "Gagal membuat user NIS.";
  }
}
</script>


  
    <!-- Dashboard -->
    <div id="dashboard-card" class="card" style="display: none;">
      <h1>Mudah, Simpel dan Akurat</h1>
      <h2>Ahlan, <span id="namaUser"></span>!</h2>

     
<div class="dashboard-header">
  <div class="dashboard-header-row">
    <select id="kelas"></select>

    <!-- Dua tanggal dibundel agar berdampingan rapat -->
    <span class="date-pair">
      <!-- Pair 1: label nempel ke input -->
      <span class="date-item">
        <label for="tanggal">Dari</label>
        <input type="date" id="tanggal" />
      </span>

      <!-- Pair 2: label nempel ke input -->
      <span class="date-item">
        <label for="tanggal-filter-akhir">‚ü∂ sampai</label>
        <input type="date" id="tanggal-filter-akhir" />
      </span>
    </span>
  </div>
</div>

<style>
  /* Baris kontrol */
  .dashboard-header-row{
    display:flex; flex-direction:row; flex-wrap:wrap;
    align-items:center; justify-content:flex-start;
    gap:.6rem; /* jarak antara <select> dan grup tanggal */
  }

  /* Grup dua tanggal (jangan melar, berdampingan rapat) */
  .date-pair{
    display:flex; align-items:center; flex-wrap:nowrap;
    gap:0;              /* tidak ada gap antar pair, kita atur manual di bawah */
    flex:0 0 auto;
  }

  /* Tiap pair: label nempel ke input, tanpa renggang */
  .date-item{
    display:inline-flex; align-items:center; white-space:nowrap;
    gap:0;              /* NOL: label menempel ke input */
    flex:0 0 auto; justify-content:flex-start; width:auto;
  }
  .date-item label{
    margin:0; line-height:1; display:inline-flex; align-items:center;
  }
  .date-item input{
    margin-left:2px;    /* jarak sangat kecil agar tidak dempet total */
  }

  /* Lebar input tanggal kompak */
  #tanggal, #tanggal-filter-akhir{
    width:16ch; min-width:14ch;
  }

  /* === Mobile (<=600px) === */
  @media (max-width:600px){
    #kelas{ flex:1 1 100%; max-width:100%; } /* select 1 baris penuh */
    .dashboard-header-row{ gap:.5rem; }

    /* jarak ANTAR pair (antara "Dari"‚Ä¶ dan "sampai"‚Ä¶) kecil & konsisten */
    .date-item + .date-item{ margin-left:.35rem; }  /* ~5-6px */

    /* tetap rapat antara label & input */
    .date-item input{ margin-left:2px; }
  }

  /* === Desktop (>=601px): tiga kolom sejajar */
  @media (min-width:601px){
    .dashboard-header-row{ flex-wrap:nowrap; }
    .date-item + .date-item{ margin-left:.5rem; }   /* sedikit lebih lega di desktop */
  }
</style>
		

      <table id="santri-table">
        <thead>
          <tr>
            <th>Nis</th>
            <th>Nama</th>
			<th>Kelas</th>
            <th>Level</th>
            <th>Presensi</th>
			<th>SP</th>
            <th>Setor Dari</th>
            <th>Setor Sampai</th>
			<th>Page</th>
			<th>Total Page</th>
			<th>Juz</th>
            <th>Total Juz</th>
            <th>Nilai</th>
            <th id="totalAllJuzHeader" style="cursor:pointer; text-decoration:underline;">Setting THMS</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="bukaModalSantri()" style="margin-left:0px;">Tambah Santri</button>
      <button id="btnHapusSantri">Hapus Santri</button>
	  <button id="btnPindahKelas">Pindah Kelas</button>
      
	<div class="actions" 
    style="display:flex; align-items:center; gap:.5rem; flex-direction:row; flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch;">

  <button id="save-btn">Simpan Data</button>
  <button id="openPdfModal">Unduh Data</button>
  <button id="editBtnIndex" type="button">HTML</button>

<!-- Modal Utama: Rentang Tanggal + Aksi -->
<div id="pdfModalOverlay" style="
  display:none; 
  position:fixed; 
  top:0; left:0; 
  width:100%; height:100%; 
  background:rgba(0,0,0,0.5); 
  z-index:999; 
  justify-content:center; 
  align-items:center;">
  
  <div style="background:#fff; padding:20px; border-radius:8px; min-width:320px; max-width:90%;">
    <h3>Download Rekap Nilai</h3>
    
    <!-- Kontrol Rekap: 3 baris x 2 kolom -->
    <div class="pdf-rekap-controls">
      <!-- Row 1, Col 1: Mulai -->
      <div class="date-item">
        <label for="pdf-start-date">Mulai</label>
        <input type="date" id="pdf-start-date" />
      </div>

      <!-- Row 1, Col 2: s/d -->
      <div class="date-item">
        <label for="pdf-end-date">s/d</label>
        <input type="date" id="pdf-end-date" />
      </div>

      <!-- Row 2, Col 1: PDF Halaqoh -->
      <button id="download-pdf-rekap" class="rekap-btn">PDF Halaqoh</button>

      <!-- Row 2, Col 2: Excel Halaqoh -->
      <button id="download-xls-rekap" class="rekap-btn">Excel Halaqoh</button>

      <!-- Row 3, Col 1: PDF Individual -->
      <button id="download-pdf-santri" class="rekap-btn">PDF Individual</button>

      <!-- Row 3, Col 2: PDF All Halaqoh -->
      <button id="download-pdf-allkelas" class="rekap-btn">PDF All Halaqoh</button>
    </div>

    <!-- Tombol tutup -->
    <div style="text-align:right; margin-top:15px;">
      <button id="closePdfModal">Tutup</button>
    </div>
  </div>
</div>

<!-- CSS khusus modal ini saja -->
<style>
  /* Grid 2 kolom untuk 6 item (3 baris) */
  #pdfModalOverlay .pdf-rekap-controls{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap:.6rem .8rem;              /* row-gap, column-gap */
    align-items:center;
    margin-top:.5rem;
  }

  /* Label nempel ke input & kompak */
  #pdfModalOverlay .date-item{
    display:inline-flex; align-items:center; gap:.2rem; white-space:nowrap;
  }
  #pdfModalOverlay .date-item input[type="date"]{
    width:12ch; min-width:10ch;
  }

  /* Tombol melebar mengikuti kolom agar sejajar rapi */
  #pdfModalOverlay .rekap-btn{
    width:100%;
  }
</style>


<!-- Modal Kedua: Pilih Santri (muncul saat klik "PDF per Santri") -->
<div id="santriModalOverlay" style="
  display:none; 
  position:fixed; 
  top:0; left:0; 
  width:100%; height:100%; 
  background:rgba(0,0,0,0.5); 
  z-index:1000; 
  justify-content:center; 
  align-items:center;">
  
  <div style="background:#fff; padding:20px; border-radius:8px; min-width:320px; max-width:90%;">
    <h3>Pilih Santri</h3>

    <div class="pdf-rekap-controls" style="margin-top:.75rem;">
      <label for="pdf-santri-select" style="min-width:260px;">
        <span>Santri</span>
        <select id="pdf-santri-select">
          <option value="">Memuat‚Ä¶</option>
        </select>
      </label>

      <button id="okSantriSelect" class="rekap-btn" style="background:#0ea5e9;">OK</button>
      <button id="cancelSantriSelect" class="rekap-btn" style="background:#6b7280;">Batal</button>
    </div>
  </div>
</div>
<button class="logout-btn" id="logout-btn">Keluar</button>
</div>


<script>
  // -------- Modal Utama --------
  const openPdfModal = document.getElementById("openPdfModal");
  const pdfModalOverlay = document.getElementById("pdfModalOverlay");
  const closePdfModal = document.getElementById("closePdfModal");

  openPdfModal?.addEventListener("click", () => {
    pdfModalOverlay.style.display = "flex";
  });

  closePdfModal?.addEventListener("click", () => {
    pdfModalOverlay.style.display = "none";
  });

  pdfModalOverlay?.addEventListener("click", (e) => {
    if (e.target === pdfModalOverlay) pdfModalOverlay.style.display = "none";
  });

  // -------- Modal Pilih Santri (kedua) --------
  const santriModalOverlay = document.getElementById("santriModalOverlay");
  const okSantriSelect = document.getElementById("okSantriSelect");
  const cancelSantriSelect = document.getElementById("cancelSantriSelect");

  // Buka modal kedua saat klik "PDF per Santri"
  document.getElementById("download-pdf-santri")?.addEventListener("click", async () => {
    santriModalOverlay.style.display = "flex";
    try { if (window._populateSantriSelect) await window._populateSantriSelect(); } catch(e){}
  });

  // OK => generate PDF per santri
  okSantriSelect?.addEventListener("click", async () => {
    try {
      if (window._pdfSantriDownload) {
        await window._pdfSantriDownload(); // validasi & generate
        santriModalOverlay.style.display = "none"; // sukses => tutup
      }
    } catch (e) {
      console.error(e); // gagal => biarkan modal tetap terbuka
    }
  });

  // Batal / klik luar untuk tutup
  cancelSantriSelect?.addEventListener("click", () => {
    santriModalOverlay.style.display = "none";
  });
  santriModalOverlay?.addEventListener("click", (e) => {
    if (e.target === santriModalOverlay) santriModalOverlay.style.display = "none";
  });
</script>




	<!-- Modal Sederhana -->
<div id="modalPindahKelas" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);align-items:center;justify-content:center;z-index:9999;">
  <div style="background:#fff;padding:16px;border-radius:10px;max-width:520px;width:92%;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h3 style="margin:0;">Pindah Kelas</h3>
      <button id="closePindah" title="Tutup">‚úï</button>
    </div>

    <label><b>Pilih Santri (multi pilih):</b></label>
    <select id="selectSantriPindah" multiple size="8" style="width:100%;margin:6px 0;"></select>

    <div style="margin:8px 0;">
      <label><b>Pilih Kelas Tujuan:</b></label>
      <div id="listKelasTujuan" style="margin-top:6px;"></div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:10px;">
      <button id="doPindah" style="padding:8px 12px;">Pindahkan</button>
      <span id="statusPindah" style="font-size:.95rem;"></span>
    </div>
  </div>
</div>

<!-- Modal Overlay -->
<div id="modalHapusSantri" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; width:400px; max-height:80%; overflow:auto;">
    <h3>Pilih Santri yang Akan Dihapus</h3>
    <ul id="listSantriHapus" style="list-style:none; padding-left:0;"></ul>
    <button id="btnHapusTerpilih">Hapus</button>
    <button id="btnTutupModal">Tutup</button>
  </div>
</div>


<script>
// ==== SEMESTER FLEX ====
const SEMESTER_MAX = 12;

function isValidSemester(v, max = SEMESTER_MAX) {
  const n = Number(String(v).trim());
  return Number.isInteger(n) && n >= 1 && n <= max;
}

function extendSemesterOptions(selectEl, max = SEMESTER_MAX) {
  if (!selectEl) return;
  const existing = new Set([...selectEl.options].map(o => String(o.value)));
  const frag = document.createDocumentFragment();
  for (let i = 1; i <= max; i++) {
    const val = String(i);
    if (!existing.has(val)) {
      const opt = document.createElement("option");
      opt.value = val;
      opt.textContent = val;
      frag.appendChild(opt);
    }
  }
  if (frag.childNodes.length) selectEl.appendChild(frag);
}
</script>

	
<!-- Modal Tambah Santri -->
<div id="modalSantri" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
  <div style="background:#fff; width:320px; margin:100px auto; padding:20px; border-radius:10px;">
    <h2>Tambah Santri</h2>

    <label>Nama:</label><br>
    <input type="text" id="inputNama" style="width:90%; margin-bottom:10px;" />

    <label>NIS:</label><br>
    <input type="text" id="inputNis" style="width:90%; margin-bottom:10px;" />

    <label>Semester:</label><br>
    <select id="inputSemester" style="width:90%; margin-bottom:10px;">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
    </select>

    <!-- ‚¨áÔ∏è BARU: Jenjang -->
    <label>Jenjang:</label><br>
    <select id="inputJenjang" style="width:90%; margin-bottom:10px;">
  <option value=""></option>
  <option value="A1">1 SD</option>
  <option value="A2">2 SD</option>
  <option value="A3">3 SD</option>
  <option value="A4">4 SD</option>
  <option value="A5">5 SD</option>
  <option value="A6">6 SD</option>
  <option value="A7">1 SMP</option>
  <option value="A8">2 SMP</option>
  <option value="A9">3 SMP</option>
  </select>

    <div style="margin-top:10px; display:flex; justify-content:space-between; gap:8px;">
      <button id="btnSimpanSantri" onclick="simpanSantriBaru()">Simpan</button>
      <button onclick="tutupModal('modalSantri')">‚ùå Batal</button>
    </div>

    <div id="loadingTambahSantri" style="display:none; margin-top:10px; color:blue;">
      ‚è≥ Menyimpan...
    </div>
  </div>
</div>
  
  
  <!-- ======================= OVERLAY LEMBAR PENILAIAN (TANPA PLAYBACK AUDIO) ======================= -->
<div id="overlay-quran" style="display:none; position:fixed; top:0; left:0;
     width:100%; height:100%; background:rgba(0,0,0,0.5);
     z-index:10000; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:8px;
       max-width:800px; max-height:80vh;
       display:flex; flex-direction:column;
       overflow:hidden;">

    <!-- Baris sejajar: toggle kiri, counter kanan -->
    <div class="keterangan-row"
         style="display:flex; align-items:center; justify-content:space-between; gap:12px; direction:ltr; margin-bottom:6px;">
      <button id="toggle-keterangan" class="keterangan-toggle">Lihat Keterangan Warna</button>
      <div id="modal-mark-warna" style="font-weight:bold; font-size:16px;"></div>
    </div>

    <!-- Box keterangan (ditoggle oleh tombol di kiri) -->
    <div id="keterangan-box" class="keterangan-box">
      <p>üü© <b>Hijau</b> = kesalahan ringan (pengurangan <b>0.25</b>)<br>
        Contoh: meninggalkan tajwid seperti <i>Ikhfa, Tebal, Tipis, Hukum Ra, Qalqalah, Ghunnah, Mad Munfashil, Mad Iwad, Shafir, Dhod, Hams, Mim Sakinah</i>, dan lain-lain.</p>
      <p>üü® <b>Kuning</b> = kesalahan menengah (pengurangan <b>0.5</b>)<br>
        Contoh: salah hafalan tapi bisa memperbaiki sendiri, <i>waqof</i> dan <i>ibtida'</i> kurang tepat, dan lain-lain.</p>
      <p>üü• <b>Merah</b> = kesalahan berat (pengurangan <b>1</b>)<br>
        Contoh: kesalahan fatal mengganti huruf, <i>waqof</i> dan <i>ibtida'</i> salah, menambah atau mengurangi mad yang mengubah makna Al-Quran, atau salah hafalan kemudian dibetulkan oleh guru, dan lain-lain.</p>
    </div>

    <!-- Area teks Al-Qur'an -->
<div id="quran-text" style="
  direction:rtl; font-size:30px; line-height:2.2;

  /* kunci justify */
  text-align:justify;
  text-align-last:right;
  text-justify:inter-word;
  white-space:normal;  /* ‚Üê ganti dari pre-wrap */

  flex:1 1 auto; overflow:auto; overscroll-behavior:contain; -webkit-overflow-scrolling:touch; scrollbar-gutter:stable;
"></div>


    <hr>

    <div>
      <span id="modal-nama-santri" style="font-weight:bold; font-size:18px;"></span>
      <span id="nilai-akhir">100</span> ‚Äî <span id="predikat-akhir">MUMTAZ</span>
    </div>

    <!-- Baris aksi nilai + tombol rekam -->
<div class="manual-actions" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
  <input type="number" id="input-nilai-manual" min="0" max="100" step="0.1" style="width:90px;" placeholder="Nilai Manual">
  <button id="btn-beri-nilai">Acc Nilai Manual</button>
  <button id="btn-open-record">Recording</button>
</div>

    <style>
      .keterangan-row{
        display:flex;
        align-items:center;
        gap:12px;
        margin-bottom:6px;
      }
      .keterangan-box {
        display: none;
        background: #f9f9f9;
        border-left: 4px solid #007bff;
        margin-top: 10px;
        padding: 12px;
        border-radius: 6px;
        font-size: 15px;
        line-height: 1.6;
      }
      .keterangan-toggle {
        all: unset;
        display: inline-block;
        font-weight: 600;
        font-size: 15px;
        letter-spacing: 0.3px;
        color: #1E88E5;
        padding: 2px 4px;
        cursor: pointer;
        position: relative;
        transition: color 0s ease;
      }
      .keterangan-toggle:hover {
        color: #ffffff;
        background:#1E88E5;
        border-radius:4px;
      }
      /* Tombol Simpan/Tutup horizontal full width */
      .modal-actions{
        display:flex; flex-direction:row; align-items:stretch; gap:10px; margin-top:12px;
      }
      .modal-actions button{
        flex:1 1 0; width:auto; padding:10px 14px; border:none; border-radius:8px; font-weight:600; cursor:pointer;
      }
      .btn-primary{ background:#1E88E5; color:#fff; }
      .btn-primary:hover{ filter:brightness(1.05); }
      .btn-secondary{ background:#e9ecef; color:#333; }
      .btn-secondary:hover{ filter:brightness(0.98); }
      @media (max-width:380px){ .modal-actions{ flex-wrap:wrap; } .modal-actions button{ flex:1 0 100%; } }
    </style>

    <!-- Tombol Simpan/Tutup -->
    <div class="modal-actions">
      <button id="save-btn-modal" class="btn-primary">Simpan</button>
      <button id="close-overlay" class="btn-secondary">Tutup</button>
    </div>

  </div>
</div>

<!-- ======================= OVERLAY REKAMAN AUDIO (SATU-SATUNYA TEMPAT PLAYBACK) ======================= -->
<div id="overlay-record" style="display:none; position:fixed; top:0; left:0;
  width:100%; height:100%; background:rgba(0,0,0,0.5);
  z-index:10001; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:8px; width:min(720px,95vw); max-height:85vh; display:flex; flex-direction:column; overflow:auto;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <div style="font-weight:700; font-size:18px;">Rekam Audio</div>
      <button id="record-close" class="btn-secondary" style="border:none; padding:8px 12px; border-radius:8px; cursor:pointer;">Close</button>
    </div>
    <div style="margin-bottom:6px;">
      <span style="opacity:.7;">Santri:</span> <b id="record-nama-santri">-</b>
    </div>

    <div class="record-controls" style="display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin:6px 0 10px;">
      <button id="record-start" class="rec-btn">Recording</button>
      <button id="record-stop" class="stop-btn" disabled>Stop</button>
      <span id="record-duration">00:00</span>
      <span id="record-spinner" style="display:none; align-items:center;">
        <span class="spinner" style="margin-right:8px;"></span>
        <i style="color:#007bff;">Menyimpan...</i>
      </span>
    </div>

    <!-- Semua rekaman (lama & baru) hanya muncul di sini -->
    <ul id="record-list" style="margin:0; padding-left:18px;"></ul>

    <style>
      .rec-btn{
        background:linear-gradient(135deg,#ff4b5c,#ff0000); color:#fff; font-weight:bold; font-size:12px;
        border:none; border-radius:50px; padding:10px 22px; cursor:pointer; transition:transform .1s, box-shadow .1s;
      }
      .rec-btn:hover{ transform:scale(1.05); box-shadow:0 0 15px rgba(255,0,0,.4); }
      .stop-btn{
        background:linear-gradient(135deg,#555,#333); color:#fff; font-weight:bold; font-size:12px;
        border:none; border-radius:50px; padding:10px 22px; cursor:pointer; transition:transform .1s, box-shadow .1s;
      }
      .stop-btn:hover{ transform:scale(1.05); box-shadow:0 0 10px rgba(0,0,0,.5); }
      .spinner{
        border:4px solid #f3f3f3; border-top:4px solid #007bff; border-radius:50%;
        width:22px; height:22px; animation:spin 1s linear infinite; display:inline-block;
      }
      @keyframes spin{ 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    </style>
  </div>
</div>

<!-- ============ Library encoder MP3 (WAJIB di /js/) ============ -->
<script>window.WEB_AUDIO_WORKER_DIR = '/js/';</script>
<script src="/js/WebAudioRecorder.min.js" defer></script>
<script src="/js/WebAudioRecorderMp3.min.js" defer></script>

<script>
/* ========= STATE UTAMA ========= */
let quranData = {};
let ayahPageMap = {};
let markData = {};
let currentIdSiswa = null;     // id/nis baris aktif
let currentRowEl = null;       // <tr> aktif
const recordListEl   = document.getElementById('record-list'); // hanya di modal rekaman
const WORKER_DIR = window.WEB_AUDIO_WORKER_DIR || '/js/';       // penting untuk worker + .mem

/* ========= UTIL KELAS/TANGGAL ========= */
function getKelasTanggalAktif() {
  const kelas = document.getElementById('kelas')?.value || 'default';
  const tanggal = currentRowEl?.dataset?.tanggal || document.getElementById('tanggal')?.value || 'default';
  return { kelas, tanggal };
}

/* ========= AMBIL MARKS + AUDIO (SERVER) ========= */
async function ambilMarksDariNetlify(id, kelas, tanggal) {
  try {
    const res = await fetch(`/api/getMarksAudio?id=${id}&kelas=${kelas}&tanggal=${tanggal}`);
    if (!res.ok) throw new Error('Gagal ambil marks dari server');
    const data = await res.json();
    return data.marks || {};
  } catch(err) {
    console.error(err);
    return {};
  }
}

/* ========= AUDIO: UTIL MIME ========= */
function getMimeType(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  if (ext === 'mp3') return 'audio/mpeg';
  if (ext === 'ogg') return 'audio/ogg';
  if (ext === 'webm') return 'audio/webm';
  return 'audio/wav';
}

/* ========= RENDER AUDIO HANYA DI MODAL REKAMAN ========= */
function tampilkanAudioDiModalRekam(marks) {
  recordListEl.innerHTML = '';
  if (marks && Array.isArray(marks.audio) && marks.audio.length) {
    for (const filename of marks.audio) {
      const li = document.createElement('li');
      li.innerHTML = `
        <audio controls preload="metadata" style="width:100%;">
          <source src="/api/getAudio?file=${encodeURIComponent(filename)}" type="${getMimeType(filename)}">
          Browser Anda tidak mendukung audio.
        </audio>`;
      recordListEl.appendChild(li);
    }
  }
}

/* ========= STORAGE ========= */
function getStorageKey() {
  const { kelas, tanggal } = getKelasTanggalAktif();
  return `marks_${kelas}_${tanggal}_${currentIdSiswa}`;
}
function simpanKeStorage() {
  if (!currentIdSiswa) return;
  localStorage.setItem(getStorageKey(), JSON.stringify(markData));
}
function ambilDariStorage() {
  if (!currentIdSiswa) return;
  const saved = localStorage.getItem(getStorageKey());
  markData = saved ? JSON.parse(saved) : {};
}

/* ========= HITUNG NILAI ========= */
function hitungNilai() {
  let totalMinus = 0, hijau = 0, kuning = 0, merah = 0, adaMark = false;
  for (let ayat in markData) {
    if (ayat === 'audio') continue; // abaikan daftar audio
    for (let idx in markData[ayat]) {
      const mark = markData[ayat][idx]; if (!mark) continue;
      adaMark = true;
      if (mark === "green") { totalMinus += 0.25; hijau++; }
      else if (mark === "yellow") { totalMinus += 0.5; kuning++; }
      else if (mark === "red") { totalMinus += 1; merah++; }
    }
  }
  let nilai = adaMark ? Math.max(0, 100 - totalMinus) : 0;
  const predikatMap = [
    { max: 59, text: "ROSIB", huruf: "D" },
    { max: 69, text: "MAQBUL", huruf: "C" },
    { max: 79, text: "JAYYID", huruf: "B" },
    { max: 89, text: "JAYYID JIDDAN", huruf: "A" },
    { max: 100, text: "MUMTAZ PLUS", huruf: "A" }
  ];
  let predikat = "-";
  if (adaMark) {
    const p = predikatMap.find(p => nilai <= p.max);
    const warna = { A: "green", A: "green", B: "blue", C: "orange", D: "red" };
    predikat = `${p.text} <span style="background-color:${warna[p.huruf]};color:white;padding:0 4px;border-radius:3px;">${p.huruf}</span>`;
  }
  const nilaiEl = document.getElementById("nilai-akhir");
  const predikatEl = document.getElementById("predikat-akhir");
  if (nilaiEl) nilaiEl.innerText = nilai.toFixed(1);
  if (predikatEl) predikatEl.innerHTML = predikat;
  const warnaDiv = document.getElementById("modal-mark-warna");
  if (warnaDiv) warnaDiv.innerHTML = `üü© ${hijau} &nbsp; üü® ${kuning} &nbsp; üü• ${merah}`;
  return { nilai, predikat, hijau, kuning, merah };
}

/* ========= TOMBOL NILAI MANUAL ========= */
document.getElementById("btn-beri-nilai").onclick = function() {
  if (!currentIdSiswa) return alert("Klik 'Lembar Penilaian' dulu.");
  const v = parseFloat(document.getElementById("input-nilai-manual").value);
  if (isNaN(v) || v < 0 || v > 100) return alert("Masukkan Nilai Manual dari 0 sampai 100.");
  let pred = "-";
  if (v <= 59) pred = "ROSIB (D)";
  else if (v <= 69) pred = "MAQBUL (C)";
  else if (v <= 79) pred = "JAYYID (B)";
  else if (v <= 89) pred = "JAYYID JIDDAN (A)";
  else pred = "MUMTAZ PLUS (A)";
  markData = {}; // kosongkan mark
  document.getElementById("nilai-akhir").innerText = v.toFixed(1);
  document.getElementById("predikat-akhir").innerText = pred;
  document.getElementById("modal-mark-warna").innerHTML = `üü© 0 &nbsp; üü® 0 &nbsp; üü• 0`;
  updateNilaiDiTabel({ nilai: v, predikat: pred });
};

/* ========= UPDATE TABEL ========= */
function updateNilaiDiTabel({ nilai, predikat }) {
  if (!currentIdSiswa) return;
  let row = currentRowEl || [...document.querySelectorAll("table tbody tr")]
    .find(r => String(r.cells[0].innerText.trim()) === String(currentIdSiswa));
  if (row) {
    const cell = [...row.cells].find(td => td.querySelector(".lihat-quran-btn"));
    if (cell) {
      cell.innerHTML = `
        <div class="nilai-ringkas"><strong>${Number(nilai).toFixed(1)}</strong> ${predikat}</div>
        <button class="lihat-quran-btn">Lembar Penilaian</button>`;
      row.markData = JSON.parse(JSON.stringify(markData));
    }
  }
}

/* ========= BUAT KATA KLIK ========= */
function buatKataKlik(surah, ayat, teks) {
  return teks.split(" ").map((kata, idx) => {
    const span = document.createElement("span");
    span.innerText = kata + " ";
    span.style.cursor = "pointer";
    span.dataset.key = `${surah}:${ayat}`;
    span.dataset.idx = idx;
    span.onclick = () => {
      const warnaSekarang = markData[surah+":"+ayat]?.[idx] || null;
      let warnaBaru = warnaSekarang === null ? "green"
        : warnaSekarang === "green" ? "yellow"
        : warnaSekarang === "yellow" ? "red"
        : null;
      if (!markData[surah+":"+ayat]) markData[surah+":"+ayat] = {};
      if (warnaBaru) markData[surah+":"+ayat][idx] = warnaBaru;
      else delete markData[surah+":"+ayat][idx];
      span.style.backgroundColor = warnaBaru || "";
      const hasil = hitungNilai();
      updateNilaiDiTabel(hasil);
    };
    if (markData[surah+":"+ayat]?.[idx]) span.style.backgroundColor = markData[surah+":"+ayat][idx];
    return span;
  });
}

/* ========= LOAD DATA QURAN ========= */
let dataSiap = Promise.all([
  fetch('https://raw.githubusercontent.com/dickymiswardi/mtq/refs/heads/main/symbol1.json').then(r => r.json()).then(d => { quranData = d; }),
  fetch('https://raw.githubusercontent.com/dickymiswardi/tadabbur/refs/heads/main/ayah_page_map.json').then(r => r.json()).then(d => { ayahPageMap = d; })
]);

/* ========= EVENT CLICK "LEMBAR PENILAIAN" ========= */
const fontLoadedPages = new Set();
document.addEventListener('click', async function (e) {
  if (!e.target.classList.contains('lihat-quran-btn')) return;

  const overlay = document.getElementById('overlay-quran');
  overlay.style.display = 'flex';

  // baris yang diklik
  const row = e.target.closest('tr');
  if (!row) return;                   /* guard */
  currentRowEl = row;
  currentIdSiswa = row.cells[0].innerText.trim();  // STRING

  // tampilkan nama
  const namaSantri = row.cells[1].childNodes[0]?.textContent.trim()
                  || row.cells[1].innerText.replace(/\d{4}-\d{2}-\d{2}/,'').trim();
  const namaSpan = document.getElementById('modal-nama-santri');
  if (namaSpan) namaSpan.innerText = namaSantri;

  // gunakan tanggal per-baris jika ada
  const kelas = document.getElementById('kelas')?.value || 'default';
  const tanggalBaris = row.dataset?.tanggal || document.getElementById('tanggal')?.value || 'default';

  // 1) ambil marks + audio (TAPI TIDAK dirender di overlay ini)
  let serverMarks = await ambilMarksDariNetlify(currentIdSiswa, kelas, tanggalBaris);
  markData = (serverMarks && typeof serverMarks === 'object') ? serverMarks : {};

  // 2) pastikan data Quran siap
  await dataSiap;

  // 3) ambil range
  const surahDari   = parseInt(row.querySelector('.surah-dari').value, 10);
  const ayatDari    = parseInt(row.querySelector('.ayat-dari').value, 10);
  const surahSampai = parseInt(row.querySelector('.surah-sampai').value, 10);
  const ayatSampai  = parseInt(row.querySelector('.ayat-sampai').value, 10);

  // 4) peta halaman -> daftar ayat
  const halamanMap = {};
  for (let s = surahDari; s <= surahSampai; s++) {
    const aStart = (s === surahDari) ? ayatDari : 1;
    const aEnd   = (s === surahSampai) ? ayatSampai : 300;
    for (let a = aStart; a <= aEnd; a++) {
      const key = `${s}:${a}`; const teks = quranData[key]; const page = ayahPageMap[key];
      if (!teks || !page) continue;
      (halamanMap[page] ||= []).push({ surah:s, ayat:a, teks:String(teks).replace(/\|/g,' ') });
    }
  }

  // 5) render ke overlay
  const quranText = document.getElementById('quran-text');
  quranText.innerHTML = '';
  const halamanUrut = Object.keys(halamanMap).map(Number).sort((x,y)=>x-y);
  for (const page of halamanUrut) {
    if (!fontLoadedPages.has(page)) {
      const pageStr = String(page).padStart(3,'0');
      const fontUrl = `https://raw.githubusercontent.com/dickymiswardi/quran/refs/heads/main/fonts/QCF_P${pageStr}.TTF`;
      try {
        const font = new FontFace(`QCF_P${pageStr}`, `url(${fontUrl})`);
        await font.load(); document.fonts.add(font); fontLoadedPages.add(page);
      } catch (err) { console.warn('Gagal load font page', page, err); }
    }
    const pageDiv = document.createElement('div');
    const pageStr = String(page).padStart(3,'0');
    pageDiv.style.fontFamily = `QCF_P${pageStr}, serif`;
    pageDiv.style.fontSize = '30px';
    pageDiv.style.lineHeight = '2.2';
    pageDiv.style.direction = 'rtl';
    pageDiv.style.marginBottom = '20px';
	pageDiv.style.textAlign = 'justify';
	pageDiv.style.setProperty('text-justify','inter-word');
	pageDiv.style.setProperty('text-align-last','right');
	pageDiv.style.whiteSpace = 'normal';


    halamanMap[page].forEach(item => {
  	const spans = buatKataKlik(item.surah, item.ayat, item.teks);
  	spans.forEach(span => pageDiv.appendChild(span));
  	// pageDiv.appendChild(document.createElement('br'));   // ‚ùå hapus baris ini
  	pageDiv.appendChild(document.createTextNode(' '));       // ‚úÖ spasi antar-ayat
	});


    quranText.appendChild(pageDiv);
  }

  // 6) nilai
  const adaMarkBerwarna = Object.keys(markData).some(k =>
    k !== 'audio' && markData[k] && typeof markData[k] === 'object' &&
    Object.values(markData[k]).some(v => v === 'green' || v === 'yellow' || v === 'red')
  );
  const hasil = (typeof hitungNilai === 'function') ? hitungNilai() : null;
  if (hasil && adaMarkBerwarna) updateNilaiDiTabel(hasil);
  else {
    const ringkas = row.querySelector('.nilai-ringkas');
    const nilaiEl = document.getElementById('nilai-akhir');
    const predEl  = document.getElementById('predikat-akhir');
    if (ringkas && nilaiEl && predEl) {
      const strong = ringkas.querySelector('strong');
      const angka = strong ? parseFloat(String(strong.textContent).replace(',', '.')) : NaN;
      if (!Number.isNaN(angka)) nilaiEl.textContent = angka.toFixed(1);
      const sisa = ringkas.textContent.replace(strong?.textContent || '', '').trim();
      predEl.innerHTML = sisa || '-';  /* FIX typo */
    }
  }
});

/* ========= TOGGLE & TUTUP ========= */
document.getElementById("toggle-keterangan").addEventListener("click", () => {
  const box = document.getElementById("keterangan-box");
  box.style.display = (box.style.display === "block") ? "none" : "block";
});
document.getElementById('close-overlay').addEventListener('click', () => {
  document.getElementById('overlay-quran').style.display = 'none';
});

/* ========= MODAL REKAMAN (BUKA/TUTUP) ========= */
document.getElementById('btn-open-record').addEventListener('click', () => {
  if (!currentIdSiswa) return alert("Buka dulu 'Lembar Penilaian' pada baris santri.");
  const overlay = document.getElementById('overlay-record');
  const namaEl = document.getElementById('record-nama-santri');
  const nama = document.getElementById('modal-nama-santri')?.textContent || '-';
  namaEl.textContent = nama;

  // render rekaman lama di modal rekaman
  tampilkanAudioDiModalRekam(markData);

  overlay.style.display = 'flex';
});
document.getElementById('record-close').addEventListener('click', () => {
  stopRecordingIfNeeded(true);
  document.getElementById('overlay-record').style.display = 'none';
});

/* ========= REKAMAN .MP3 DENGAN WebAudioRecorder ========= */
let audioCtx = null;
let micStream = null;
let sourceNode = null;
let mp3Recorder = null;
let isRecording = false;

const recordStartBtn = document.getElementById('record-start');
const recordStopBtn  = document.getElementById('record-stop');
const recordDurEl    = document.getElementById('record-duration');
const recordSpinEl   = document.getElementById('record-spinner');

let durSec = 0;
let durTimer = null;

function formatTime(sec){ const m = String(Math.floor(sec/60)).padStart(2,'0'); const s = String(sec%60).padStart(2,'0'); return `${m}:${s}`; }

async function ensureMicNodes(){
  if (audioCtx && micStream && sourceNode) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  micStream = await navigator.mediaDevices.getUserMedia({ audio:true });
  sourceNode = audioCtx.createMediaStreamSource(micStream);
}

function stopRecordingIfNeeded(cancelOnly=false){
  try { if (mp3Recorder && isRecording && !cancelOnly) mp3Recorder.finishRecording(); } catch(e){}
  isRecording = false;
  clearInterval(durTimer);
  recordStartBtn.disabled = false;
  recordStopBtn.disabled = true;
}

recordStartBtn.addEventListener('click', async () => {
  try{
    await ensureMicNodes();

    mp3Recorder = new WebAudioRecorder(sourceNode, {
      workerDir: WORKER_DIR,   // ‚Üê pastikan ke /js/
      encoding: 'mp3',
      numChannels: 2,          // ‚Üê MP3 encoder butuh stereo
      onComplete: async function(rec, blob){
        await handleRecordedBlobMP3(blob);
      },
      onError: function(rec, err){ console.error(err); alert('Terjadi kesalahan saat rekam/encode.'); }
    });

    mp3Recorder.setOptions({
      timeLimit: 600,            // 10 menit
      encodeAfterRecord: true,   // encode setelah stop
      mp3: { bitRate: 128 }      // 128 kbps
    });

    mp3Recorder.startRecording();
    isRecording = true;

    durSec = 0; recordDurEl.textContent = '00:00';
    durTimer = setInterval(()=>{ durSec++; recordDurEl.textContent = formatTime(durSec); }, 1000);

    recordStartBtn.disabled = true;
    recordStopBtn.disabled  = false;
  } catch(err){
    console.error(err);
    alert('Tidak bisa mengakses mikrofon.');
  }
});

recordStopBtn.addEventListener('click', () => {
  if (!mp3Recorder || !isRecording) return;
  recordStopBtn.disabled  = true;
  recordStartBtn.disabled = false;
  clearInterval(durTimer);
  try { mp3Recorder.finishRecording(); } catch(e){ console.warn(e); }
  isRecording = false;
});

async function handleRecordedBlobMP3(blob){
  // tampilkan spinner
  recordSpinEl.style.display = 'inline-flex';

  const { kelas, tanggal } = getKelasTanggalAktif();
  const ts = Date.now();
  const safeTanggal = String(tanggal).replace(/[^0-9-]/g,'');
  const filename = `rec_${kelas}_${currentIdSiswa}_${safeTanggal}_${ts}.mp3`;

  // Helper: blob -> dataURL (base64)
  function blobToDataURL(b){
    return new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(b);
    });
  }

  let uploaded = false;
  try{
    const base64 = await blobToDataURL(blob);

    // 1) Upload audio ke repo
    const up = await fetch('/api/upload-audio', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ fileName: filename, base64 }) // folder default: "audio"
    });
    const upJson = await up.json();
    if (!up.ok || !upJson?.success) throw new Error(upJson?.error || 'Upload audio gagal');
    uploaded = true;

    // 2) Append ke marks.audio
    await fetch('/api/appendAudioToMarks', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ id: currentIdSiswa, ...getKelasTanggalAktif(), filename })
    }).catch(()=>{});
  } catch(e){
    console.warn('Upload/append audio gagal, file disimpan lokal saja.', e);
  }

  // 3) Tampilkan rekaman BARU di modal rekaman (bukan overlay Qur'an)
  const url = uploaded
    ? `/api/getAudio?file=${encodeURIComponent(filename)}`
    : URL.createObjectURL(blob);

  const li = document.createElement('li');
  li.innerHTML = `
    <audio controls preload="metadata" style="width:100%;">
      <source src="${url}" type="audio/mpeg">
      Browser Anda tidak mendukung audio.
    </audio>`;
  recordListEl.appendChild(li);

  // 4) Update struktur data (tanpa merender di overlay Qur'an)
  markData.audio = Array.isArray(markData.audio) ? markData.audio : [];
  if (uploaded) markData.audio.push(filename);

  // selesai
  recordSpinEl.style.display = 'none';
}
</script>



<!-- Overlay Hitung Total All Juz -->
<div id="juzOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
background:rgba(0,0,0,0.5); z-index:999; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:8px; min-width:300px;">
    <h3>Target Hafalan Minimal Semester</h3>
    <!-- Styling bullet yang rapi & minimal -->
    <style>
      #juzOverlay .juz-list{
        margin:8px 0 12px;
        padding-left:1.25rem;        /* jarak marker */
        list-style:disc;
      }
      #juzOverlay .juz-list li{
        margin:4px 0;                /* spasi antar baris */
        line-height:1.55;
      }
      #juzOverlay .juz-list li::marker{
        color:#3b82f6;               /* warna bullet (biru lembut) */
        font-size:1.1em;             /* sedikit lebih besar */
      }
      #juzOverlay .juz-list strong{
        font-variant-numeric:tabular-nums; /* angka rata */
      }
    </style>

    <!-- Bullet list cakep -->
    <ul class="juz-list"><li>Semester 1: <strong>8</strong> Juz</li>
      <li>Semester 2: <strong>5</strong> Juz</li>
      <li>Semester 3: <strong>5</strong> Juz</li>
      <li>Semester 4: <strong>5</strong> Juz</li>
      <li>Semester 5: <strong>5</strong> Juz</li>
      <li>Semester 6: <strong>2</strong> Juz</li></ul>

    <hr style="border:none; border-top:1px solid #eee; margin:8px 0 12px;">

    <label>Dari: <input type="date" id="rangeDari"></label><br><br>
    <label>Sampai: <input type="date" id="rangeSampai" disabled></label><br><br>
    <button id="btnHitungTotalJuz">Setting Tanggal THMS</button>
    <button onclick="document.getElementById('juzOverlay').style.display='none'">Close</button>
  </div>
</div>

<!-- ===========================
     MODAL: Input Murajaah
     =========================== -->
<div id="murModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1200; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:16px; border-radius:12px; width:min(920px,95%); max-height:90vh; overflow:auto;">
    <h3 style="margin:0 0 10px;">Input Murajaah (Surah/Ayat/Page)</h3>

    <div style="border:1px solid #e5e7eb; border-radius:10px; padding:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <label>Page dari
        <select id="mur-pageFrom"></select>
      </label>
      <label>ke Page
        <select id="mur-pageTo"></select>
      </label>

      <span class="muted" aria-hidden="true">|</span>

      <label>Surah dari
        <select id="mur-surahFrom"></select>
      </label>
      <label>Ayat
        <select id="mur-ayahFrom"></select>
      </label>
      <span class="muted" aria-hidden="true">‚Üí</span>
      <label>ke Surah
        <select id="mur-surahTo"></select>
      </label>
      <label>Ayat
        <select id="mur-ayahTo"></select>
      </label>
    </div>

    <div style="margin:8px 0 12px; font-size:12px; color:#6b7280" id="mur-infoRange">-</div>

    <div style="background:#f9fafb; border:1px dashed #e5e7eb; padding:10px; border-radius:8px;">
      <div><b>Total setara Juz:</b> <span id="mur-totalJuz" style="font-weight:700">0.00</span> juz</div>
      <div style="font-size:12px; color:#6b7280" id="mur-pagesHint"></div>
    </div>

    <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end; align-items:center;">
      <span id="mur-save-status" style="font-size:12px; color:#6b7280; margin-right:auto;"></span>
      <button type="button" id="mur-save" style="background:#16a34a; color:#fff; border:1px solid #16a34a; padding:8px 12px; border-radius:8px;">Save Data</button>
      <button type="button" id="mur-close">Tutup</button>
    </div>
  </div>
</div>


<!-- Kolom header akan disisipkan otomatis via JS.
     Ini hanya overlay untuk set tanggal + info THMS. -->

<!-- ===========================
     Overlay Total Mur (Range)
     =========================== -->
<div id="murRangeOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1200; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:12px; width:min(520px,94%); box-shadow:0 12px 36px rgba(0,0,0,.18)">
    <h3 style="margin:0 0 10px;">Target Hafalan Minimal Semester</h3>

    <style>
      #murRangeOverlay .juz-list{
        margin:8px 0 12px;
        padding-left:1.25rem;
        list-style:disc;
      }
      #murRangeOverlay .juz-list li{ margin:4px 0; line-height:1.55; }
      #murRangeOverlay .juz-list li::marker{ color:#3b82f6; font-size:1.1em; }
      #murRangeOverlay .juz-list strong{ font-variant-numeric:tabular-nums; }
    </style>

    <ul class="juz-list"><li>Semester 1: <strong>8</strong> Juz</li>
      <li>Semester 2: <strong>5</strong> Juz</li>
      <li>Semester 3: <strong>5</strong> Juz</li>
      <li>Semester 4: <strong>5</strong> Juz</li>
      <li>Semester 5: <strong>5</strong> Juz</li>
      <li>Semester 6: <strong>2</strong> Juz</li></ul>

    <hr style="border:none; border-top:1px solid #eee; margin:8px 0 12px;">

    <label>Dari: <input type="date" id="murRangeDari"></label><br><br>
    <label>Sampai: <input type="date" id="murRangeSampai"></label><br><br>

    <div id="murRangeStatus" style="font-size:12px; color:#6b7280; margin-bottom:10px;"></div>

    <button id="btnHitungTotalMur" type="button">Setting Tanggal Murajaah</button>
    <button type="button" onclick="document.getElementById('murRangeOverlay').style.display='none'">Close</button>
  </div>
</div>
  
 <script>
  // === Deklarasi elemen ===
  const loginCard = document.getElementById("login-card");
  const dashboardCard = document.getElementById("dashboard-card");
  const loginForm = document.getElementById("login-form");
  const loginError = document.getElementById("login-error");
  const logoutBtn = document.getElementById("logout-btn");
  const togglePasswordBtn = document.getElementById("toggle-password");
  const passwordInput = document.getElementById("password");
  const overlay = document.getElementById("overlay");
  const kelasSelect = document.getElementById("kelas");
  const tanggalInput = document.getElementById("tanggal");  
  const startDateInput = document.getElementById("start-date");  // üîπ TAMBAHAN
  const endDateInput = document.getElementById("end-date");      // üîπ TAMBAHAN
  const santriTableBody = document.querySelector("#santri-table tbody");
  const saveBtn = document.getElementById("save-btn");
  const downloadBtn = document.getElementById("download-btn");
  const totalAllJuzHeader = document.getElementById("totalAllJuzHeader");
  const namaUserSpan = document.getElementById("namaUser");
  const tanggalFilterAkhir = document.getElementById("tanggal-filter-akhir");
  const KELAS_KEY = "kelasTerakhir";



  let surahList = [];
  let pagesMap = {};

  

  // === Fungsi atur dropdown kelas ===
function aturDropdownKelas(user) {
  const semuaKelas = [  "kelas_01","kelas_012526","kelas_02"];

  const namaKelasCustom = {  kelas_01: "Ust. Dicky Miswardi, B.A.",
  kelas_012526: "Ust. Moro, B.A.",
  kelas_02: "Ust. Obie Zarobie, B.A."};

  kelasSelect.innerHTML = "";

  const kelasDiizinkan = user?.kelas?.length ? user.kelas : semuaKelas;

  semuaKelas.forEach(kls => {
    const opt = document.createElement("option");
    opt.value = kls;
    opt.textContent = namaKelasCustom[kls] || kls;
    opt.disabled = !kelasDiizinkan.includes(kls);
    kelasSelect.appendChild(opt);
  });

  // --- pilih nilai ---
  const saved = localStorage.getItem(KELAS_KEY); // ex: "kelas_3"
  const adaSaved = saved && Array.from(kelasSelect.options).some(o => o.value === saved && !o.disabled);
  if (adaSaved) {
    kelasSelect.value = saved;        // pakai pilihan terakhir bila masih diizinkan
  } else {
    const pertamaAktif = Array.from(kelasSelect.options).find(o => !o.disabled);
    if (pertamaAktif) kelasSelect.value = pertamaAktif.value; // fallback
  }
}

  // === Login form ===
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const username = document.getElementById("username").value;
    const password = passwordInput.value;

    overlay.style.display = "flex";

    try {
      const res = await fetch("/api/getUsers");
      const users = await res.json();
      const user = users.find(u => u.username === username && u.password === password);

      if (user) {
        localStorage.setItem("isLoggedIn", true);
        localStorage.setItem("username", username);
        localStorage.setItem("kelasDiizinkan", JSON.stringify(user.kelas || []));
        namaUserSpan.textContent = username;

        aturDropdownKelas(user);
        showDashboard();
        loadDataSantri(); // langsung load data sesuai kelas terpilih
      } else {
        loginError.style.display = "block";
      }
    } catch (err) {
      loginError.textContent = "Gagal memuat data user!";
      loginError.style.display = "block";
    }

    overlay.style.display = "none";
  });

  // === Load data santri ===
  async function loadDataSantri() {
    const kelas = kelasSelect.value;
    if (!kelas) return; // jaga-jaga

    try {
      const res = await fetch(`/api/getSantri?kelas=${kelas}`);
      if (!res.ok) throw new Error("Gagal memuat data santri");
      const data = await res.json();
      console.log("Data santri:", data);
      // TODO: render ke tabel
    } catch (err) {
      console.error(err);
      alert("Gagal memuat data santri / absensi!");
    }
  }

  // === Saat halaman dibuka ===
  window.addEventListener("DOMContentLoaded", async () => {
    try {
      const resSurah = await fetch("/api/getAyat");
      surahList = await resSurah.json();

      const resPages = await fetch("/api/getPagesMap");
      pagesMap = await resPages.json();
    } catch (err) {
      console.error("Gagal load surah/pagesMap:", err);
    }

    const isLoggedIn = localStorage.getItem("isLoggedIn");
    if (isLoggedIn) {
      const storedKelas = JSON.parse(localStorage.getItem("kelasDiizinkan") || "[]");
      const storedUsername = localStorage.getItem("username") || "";
      namaUserSpan.textContent = storedUsername;

      aturDropdownKelas({ kelas: storedKelas });
      showDashboard();
      loadDataSantri();
    }
  });

  // === Event ganti kelas ===
  kelasSelect.addEventListener("change", () => {
  try { localStorage.setItem(KELAS_KEY, kelasSelect.value); } catch {}
  loadDataSantri();
});

  // === Header total juz click ===
  totalAllJuzHeader.addEventListener("click", bukaOverlayTotalAllJuz);



    

    function showDashboard() {
  loginCard.style.display = "none";
  dashboardCard.style.display = "block";

  const today = new Date().toLocaleDateString('sv-SE'); // YYYY-MM-DD

  // batas maksimal filter akhir
  if (tanggalFilterAkhir) tanggalFilterAkhir.max = today;

  // restore filter akhir
  const savedTanggalAkhirFilter = localStorage.getItem("tanggalFilterAkhirTerakhir") || "";
  if (tanggalFilterAkhir) {
    tanggalFilterAkhir.value = savedTanggalAkhirFilter;
    tanggalFilterAkhir.addEventListener("change", () => {
      localStorage.setItem("tanggalFilterAkhirTerakhir", tanggalFilterAkhir.value);
      loadSantriData();
    });
  }

  // batas tanggal tak boleh ke depan
  if (tanggalInput)   tanggalInput.max = today;
  if (startDateInput) startDateInput.max = today;
  if (endDateInput)   endDateInput.max = today;

  // restore tanggal
  const savedTanggal = localStorage.getItem("tanggalTerakhir");
  const savedEnd     = localStorage.getItem("endDateTerakhir");

  if (tanggalInput) {
    tanggalInput.value = savedTanggal || today;
    tanggalInput.addEventListener("change", () => {
      localStorage.setItem("tanggalTerakhir", tanggalInput.value);
      if (tanggalFilterAkhir) {
        tanggalFilterAkhir.value = "";
        localStorage.removeItem("tanggalFilterAkhirTerakhir");
      }
      loadSantriData();
    });
  }

  if (endDateInput) {
    endDateInput.value = savedEnd || today;
    endDateInput.addEventListener("change", () => {
      localStorage.setItem("endDateTerakhir", endDateInput.value);
      loadSantriData();
    });
  }

  loadSantriData();
}

logoutBtn.addEventListener("click", () => {
  overlay.style.display = "flex";
  setTimeout(() => {
    localStorage.removeItem("isLoggedIn");
    localStorage.removeItem("username");
    loginCard.style.display = "block";
    dashboardCard.style.display = "none";
    overlay.style.display = "none";
  }, 500);
});

async function loadSantriData() {
  const kelas   = kelasSelect.value;
  const tanggal = tanggalInput.value; // tanggal awal (kolom pertama)
  overlay.style.display = "flex";

  // ===== NEW: Konfigurasi & util jenjang (future-proof) =====
  const JENJANG_MAX = Number(window.JENJANG_MAX ?? 9); // ubah ke 100 / 300 / 1000 sesuai kebutuhan

  const parseJenjang = (v) => {
    const m = /^A(\d+)$/.exec(String(v || "").trim());
    return m ? Number(m[1]) : null;
  };

  const isValidJenjang = (v, max = JENJANG_MAX) => {
    if (!v) return true;                       // kosong = boleh
    const n = parseJenjang(v);
    if (!Number.isFinite(n) || n < 1) return false; // minimal A1
    if (!max || max === 0) return true;        // 0 => tanpa batas atas
    return n <= max;
  };

  // Menjaga label custom yang sudah kamu tulis (ILA, 1A, 2B, dst),
  // lalu menambahkan A{existing+1}..A{JENJANG_MAX} jika perlu.
  const ensureJenjangOptions = (selectEl, max = JENJANG_MAX, currentValue = "") => {
    if (!selectEl) return;
    const existingVals = new Set([...selectEl.options].map(o => String(o.value || "")));
    const frag = document.createDocumentFragment();

    // Tambah opsi kosong jika belum ada
    if (![...selectEl.options].some(o => o.value === "")) {
      const empty = document.createElement("option");
      empty.value = "";
      empty.textContent = "";
      frag.appendChild(empty);
    }

    // Tambah opsi hingga MAX, tanpa mengganggu label custom yang sudah ada
    for (let i = 1; i <= max; i++) {
      const v = `A${i}`;
      if (!existingVals.has(v)) {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v; // label default = value
        frag.appendChild(opt);
      }
    }

    // Sisipkan tambahan di akhir, lalu set nilai saat ini
    if (frag.childNodes.length) selectEl.appendChild(frag);
    if (currentValue !== undefined && currentValue !== null) {
      selectEl.value = String(currentValue);
    }
  };
  // ===== END NEW =====

  // === cache master
  window.semesterMap   ??= {}; // key = NIS (prioritas) atau ID ‚Üí "1".."6"
  window.jenjangMap    ??= {}; // key -> "A1".."A8" atau ""
  window.keteranganMap ??= {}; // key -> "" | "SP1".."SP4"

  // Helpers kecil
  const keyId   = v => (v === 0 || v) ? String(v).trim() : "";
  const keyNis  = v => (v === 0 || v) ? String(v).trim() : "";
  const keyName = v => String(v || "").trim().toLowerCase();
  const byIdMap = (arr, pick = x => x) => {
    const m = new Map();
    for (const a of arr || []) {
      const id = keyId(a?.id);
      if (id) m.set(id, pick(a));
    }
    return m;
  };
  const byNisMap = (arr, pick = x => x) => {
    const m = new Map();
    for (const a of arr || []) {
      const nis = keyNis(a?.nis);
      if (nis) m.set(nis, pick(a));
    }
    return m;
  };
  const byNameMap = (arr, pick = x => x) => {
    const m = new Map();
    for (const a of arr || []) {
      const nm = keyName(a?.nama);
      if (nm && !m.has(nm)) m.set(nm, pick(a)); // ambil yang pertama, hindari overwrite
    }
    return m;
  };

  // dataset helpers (kalau diperlukan bagian lain)
  const getRowKey = row => (row?.dataset?.key || "").trim();
  const getRowId  = row => (row?.dataset?.id  || "").trim();
  const getRowNis = row => (row?.dataset?.nis || "").trim();

  // enable/disable tombol saat mode NIS
  function setButtonsDisabled(disabled) {
    const targets = [
      document.getElementById("save-btn-modal"),
      document.getElementById("save-btn"),
	  document.getElementById("editBtnIndex"),
	  document.getElementById("mur-save"),
      document.getElementById("btnHitungTotalJuz"),
      document.querySelector("button[onclick='bukaModalSantri()']"),
      document.getElementById("btnHapusSantri"),
      document.getElementById("btnPindahKelas"),
      document.getElementById("recordButton"),
      document.getElementById("btn-beri-nilai"),
      document.querySelector("button[onclick='simpanSantriBaru()']"),
      document.getElementById("btnHapusTerpilih"),
      document.getElementById("doPindah"),
    ];
    targets.forEach(btn => {
      if (!btn) return;
      btn.disabled = !!disabled;
      btn.style.opacity = disabled ? "0.5" : "";
      btn.style.cursor  = disabled ? "not-allowed" : "";
      if (disabled) {
        btn.dataset._onclick_bak ??= btn.getAttribute("onclick") || "";
        if (btn.dataset._onclick_bak) btn.removeAttribute("onclick");
      } else {
        if (btn.dataset._onclick_bak) {
          btn.setAttribute("onclick", btn.dataset._onclick_bak);
          delete btn.dataset._onclick_bak;
        }
      }
    });
  }

  try {
    // Roster santri (MASTER)
    const resSantri = await fetch(`/api/getSantri?kelas=${encodeURIComponent(kelas)}&t=${Date.now()}`);
    let santriData = await resSantri.json();

    // Bangun peta master
    window.semesterMap   = {};
    window.jenjangMap    = {};
    window.keteranganMap = {};

    (santriData || []).forEach(s => {
      const k = (s?.nis != null && s.nis !== "") ? String(s.nis).trim()
              : (s?.id != null ? String(s.id).trim() : "");
      if (!k) return;
      window.semesterMap[k]   = String(s?.semester   ?? "1");
      window.jenjangMap[k]    = String(s?.jenjang    ?? "");  // boleh kosong
      window.keteranganMap[k] = String(s?.keterangan ?? "");  // boleh kosong
    });

    // Index roster
    const rosterById   = byIdMap(santriData, s => s);
    const rosterByNis  = byNisMap(santriData, s => s);
    const rosterByName = byNameMap(santriData, s => s);

    // Ambil absensi (single / range)
    let absensiRaw = [];
    const endFilter = tanggalFilterAkhir ? tanggalFilterAkhir.value : "";

    if (endFilter && endFilter !== tanggal) {
      const resAbsensiRange = await fetch(
        `/api/getAbsensiRange?kelas=${encodeURIComponent(kelas)}&start=${encodeURIComponent(tanggal)}&end=${encodeURIComponent(endFilter)}&t=${Date.now()}`
      );
      absensiRaw = await resAbsensiRange.json();
      if (!Array.isArray(absensiRaw)) absensiRaw = [];
    } else {
      const resAbsensi = await fetch(
        `/api/getAbsensi?kelas=${encodeURIComponent(kelas)}&tanggal=${encodeURIComponent(tanggal)}&t=${Date.now()}`
      );
      let d = await resAbsensi.json();
      absensiRaw = Array.isArray(d) ? d : (d?.list || []);
    }

    // Normalisasi absensi + sematkan field master untuk tampilan
    let absensiData = absensiRaw.map((r) => {
      let id   = keyId(r?.id ?? "");
      let nis  = keyNis(r?.nis ?? "");
      const nm = keyName(r?.nama);

      if (!nis && id && rosterById.get(id)?.nis) {
        nis = keyNis(rosterById.get(id).nis);
      }
      if (!nis && nm && rosterByName.get(nm)?.nis) {
        nis = keyNis(rosterByName.get(nm).nis);
      }

      // isi nama bila kosong
      let nama = r?.nama;
      if (!nama && nis && rosterByNis.get(nis)?.nama) nama = rosterByNis.get(nis).nama;
      if (!nama && id  && rosterById.get(id)?.nama)  nama = rosterById.get(id).nama;

      // isi id bila kosong lewat nis
      if (!id && nis && rosterByNis.get(nis)?.id) id = keyId(rosterByNis.get(nis).id);

      const keyMaster   = nis || id || "";
      const semesterFix = window.semesterMap?.[keyMaster]   ?? r.semester;
      const jenjangFix  = window.jenjangMap?.[keyMaster]    ?? r.jenjang;
      const ketFix      = window.keteranganMap?.[keyMaster] ?? r.keterangan;

      return { ...r, id, nis, nama, semester: semesterFix, jenjang: jenjangFix, keterangan: ketFix };
    });

    // Ambil user login & filter akses santri (tetap)
    const username = localStorage.getItem("username");
    const users = await fetch(`/api/getUsers?t=${Date.now()}`).then(r => r.json());
    const user  = users.find(u => u.username === username);

    if (user) {
      if (user.kelas && user.kelas.length) {
        if (!user.kelas.includes(kelas)) {
          santriData = [];
        } else if (user.nis && user.nis.length) {
          santriData = santriData.filter(s => user.nis.includes(s.nis));
        }
      }
    } else {
      santriData = [];
    }

    // Mode NIS ‚Üí disable tombol tertentu
    const isModeNIS = !!(user && Array.isArray(user.nis) && user.nis.length);
    setButtonsDisabled(isModeNIS);
    setNISDropdownDisabled(isModeNIS);
    setNISRecordDisabled(isModeNIS);
    setNISRekapDisabled(isModeNIS);

    // RENDER TABEL
    santriTableBody.innerHTML = "";
    const isRange = !!(endFilter && endFilter !== tanggal);

    // Index absensi untuk JOIN cepat
    if (!isRange) {
      var absById   = new Map();
      var absByNis  = new Map();
      var absByName = new Map();
      for (const a of absensiData) {
        const aid  = keyId(a?.id);
        const anis = keyNis(a?.nis);
        const anm  = keyName(a?.nama);
        if (aid && !absById.has(aid))   absById.set(aid, a);
        if (anis && !absByNis.has(anis)) absByNis.set(anis, a);
        if (anm && !absByName.has(anm)) absByName.set(anm, a);
      }
    } else {
      var absensiById   = {};
      var absensiByNis  = {};
      var absensiByName = {};
      for (const a of absensiData) {
        const aid  = keyId(a?.id);
        const anis = keyNis(a?.nis);
        const anm  = keyName(a?.nama);
        if (aid)  (absensiById[aid]  ||= []).push(a);
        if (anis) (absensiByNis[anis] ||= []).push(a);
        if (anm)  (absensiByName[anm] ||= []).push(a);
      }
      const sorter = arr => arr.sort((x,y) => String(x.tanggal||"").localeCompare(String(y.tanggal||"")));
      Object.values(absensiById).forEach(sorter);
      Object.values(absensiByNis).forEach(sorter);
      Object.values(absensiByName).forEach(sorter);
    }

    // Render per santri
    santriData.forEach((santri) => {
      const sid    = keyId(santri.id);
      const snis   = keyNis(santri.nis);
      const snameK = keyName(santri.nama);

      let rowsForSantri;
      if (isRange) {
        const fromNis  = (snis && absensiByNis?.[snis])  ? absensiByNis[snis]  : [];
        const fromId   = (sid  && absensiById?.[sid])    ? absensiById[sid]    : [];
        const fromName = (snameK && absensiByName?.[snameK]) ? absensiByName[snameK] : [];
        // gabung & dedup per tanggal (prioritas nis ‚Üí id ‚Üí nama)
        const seen = new Set();
        rowsForSantri = [];
        for (const r of [...fromNis, ...fromId, ...fromName]) {
          const k = r.tanggal || "__";
          if (!seen.has(k)) { rowsForSantri.push(r); seen.add(k); }
        }
      } else {
        // single date: prioritas nis ‚Üí id ‚Üí nama
        const hit = (snis && absByNis.get(snis))
                 || (sid  && absById.get(sid))
                 || (snameK && absByName.get(snameK))
                 || null;
        rowsForSantri = [hit || {}];
      }

      if (isRange && rowsForSantri.length === 0) rowsForSantri.push({});

      rowsForSantri.forEach((dataAbsensi) => {
        const row = document.createElement("tr");

        const surahOptions = surahList.map(s => `<option value="${s.id}">${s.nama}</option>`).join("");
        const dari   = (dataAbsensi?.dari   || "1:1").split(":");
        const sampai = (dataAbsensi?.sampai || "1:1").split(":");

        const rowDate = (isRange && dataAbsensi?.tanggal) ? dataAbsensi.tanggal : tanggal;

        const subTanggal = isRange && dataAbsensi?.tanggal
          ? `<div style="font-size:12px;opacity:.65">${dataAbsensi.tanggal}</div>`
          : "";

        // === Nilai master saat ini
        const keyMaster = (snis || sid || "");
        const semNow = (window.semesterMap?.[keyMaster])   ?? santri.semester   ?? "1";
        const jenNow = (window.jenjangMap?.[keyMaster])    ?? santri.jenjang    ?? "";
        const ketNow = (window.keteranganMap?.[keyMaster]) ?? santri.keterangan ?? "";

        // TAMPILAN: NIS ‚Üí fallback ID
        row.innerHTML = `
          <td class="col-nis">${santri.nis ?? santri.id ?? ""}</td>
          <td class="col-nama">${santri.nama ?? ""}${subTanggal}</td>
          <td>
  <select class="jenjang">
    <option value="A1" ${jenNow === 'A1' ? 'selected' : ''}>1 SD</option>
    <option value="A2" ${jenNow === 'A2' ? 'selected' : ''}>2 SD</option>
    <option value="A3" ${jenNow === 'A3' ? 'selected' : ''}>3 SD</option>
    <option value="A4" ${jenNow === 'A4' ? 'selected' : ''}>4 SD</option>
    <option value="A5" ${jenNow === 'A5' ? 'selected' : ''}>5 SD</option>
    <option value="A6" ${jenNow === 'A6' ? 'selected' : ''}>6 SD</option>
    <option value="A7" ${jenNow === 'A7' ? 'selected' : ''}>1 SMP</option>
    <option value="A8" ${jenNow === 'A8' ? 'selected' : ''}>2 SMP</option>
    <option value="A9" ${jenNow === 'A9' ? 'selected' : ''}>3 SMP</option>
  </select>
</td>
          <td>
            <select class="semester">
    <option value="1" ${String(semNow) === '1' ? 'selected' : ''}>1</option>
    <option value="2" ${String(semNow) === '2' ? 'selected' : ''}>2</option>
    <option value="3" ${String(semNow) === '3' ? 'selected' : ''}>3</option>
    <option value="4" ${String(semNow) === '4' ? 'selected' : ''}>4</option>
    <option value="5" ${String(semNow) === '5' ? 'selected' : ''}>5</option>
    <option value="6" ${String(semNow) === '6' ? 'selected' : ''}>6</option>
  </select>
          </td>
          <td>
            <select class="absensi">
              <option value="Hadir" ${dataAbsensi?.absensi === "Hadir" ? "selected" : ""}>Hadir</option>
              <option value="Alpha" ${dataAbsensi?.absensi === "Alpha" ? "selected" : ""}>Alpha</option>
              <option value="Sakit" ${dataAbsensi?.absensi === "Sakit" ? "selected" : ""}>Sakit</option>
              <option value="Izin" ${dataAbsensi?.absensi === "Izin" ? "selected" : ""}>Izin</option>
            </select>
          </td>
          <td>
            <select class="keterangan">
    <option value="" ${!ketNow ? 'selected' : ''}></option>
    <option value="SP1" ${ketNow === 'SP1' ? 'selected' : ''}>SP1</option>
    <option value="SP2" ${ketNow === 'SP2' ? 'selected' : ''}>SP2</option>
  </select>
          </td>
          <td>
            <select class="surah-dari">${surahOptions}</select>
            <select class="ayat-dari"></select>
          </td>
          <td>
            <select class="surah-sampai">${surahOptions}</select>
            <select class="ayat-sampai"></select>
          </td>
          <td class="halaman-terbaca">${dataAbsensi?.halaman ?? '-'}</td>
          <td class="total-halaman">${dataAbsensi?.totalHalaman ?? '-'}</td>
          <td class="juz-terbaca">${dataAbsensi?.juzTerbaca ?? '-'}</td>
          <td class="total-juz">${dataAbsensi?.totalJuz ?? 0}</td>
          <td>
            <div class="nilai-ringkas">
              ${dataAbsensi?.buttonCell
                ? `<strong>${Number(dataAbsensi.buttonCell.nilai).toFixed(1)}</strong> - ${bgHuruf(dataAbsensi.buttonCell.predikatHuruf, dataAbsensi.buttonCell.predikatText)}`
                : ''}
            </div>
            <button type="button" class="lihat-quran-btn">Lembar Penilaian</button>
          </td>
          <td class="total-all-juz">0</td>
        `;

        // DATASET stabil (dipakai proses lain)
        const dsId  = keyId(sid);
        const dsNis = keyNis(snis);
        row.dataset.id        = dsId;
        row.dataset.nis       = dsNis;
        row.dataset.key       = (dsNis || dsId || "");
        row.dataset.tanggal   = rowDate;
        row.dataset.jenjang   = jenNow || ""; // untuk rollback
        row.dataset.keterangan= ketNow || ""; // untuk rollback

        // marks jika ada
        if (dataAbsensi && dataAbsensi.marks) row.markData = dataAbsensi.marks;

        santriTableBody.appendChild(row);

        // ganti gif jika total-all-juz = 0 (opsional, logika lama dipertahankan)
        const totalAllJuzTd = row.querySelector("td.total-all-juz");
        if (totalAllJuzTd && totalAllJuzTd.textContent.trim() === "0") {
          totalAllJuzTd.innerHTML = `0`;
        }

        // Set dropdown surah/ayat
        const surahDari   = row.querySelector(".surah-dari");
        const ayatDari    = row.querySelector(".ayat-dari");
        const surahSampai = row.querySelector(".surah-sampai");
        const ayatSampai  = row.querySelector(".ayat-sampai");

        const dariArr   = Array.isArray(dari)   ? dari   : String(dari).split(":");
        const sampaiArr = Array.isArray(sampai) ? sampai : String(sampai).split(":");

        surahDari.value   = dariArr[0];
        surahSampai.value = sampaiArr[0];

        fillAyatOptions(ayatDari,   surahDari.value,   dariArr[1]);
        fillAyatOptions(ayatSampai, surahSampai.value, sampaiArr[1]);

        surahDari.addEventListener("change", () => fillAyatOptions(ayatDari, surahDari.value));
        surahSampai.addEventListener("change", () => fillAyatOptions(ayatSampai, surahSampai.value));

        // sinkron otomatis
        surahDari.addEventListener("change", () => {
          surahSampai.value = surahDari.value;
          fillAyatOptions(ayatSampai, surahSampai.value, ayatDari.value);
        });
        ayatDari.addEventListener("change", () => { ayatSampai.value = ayatDari.value; });

        [ayatDari, ayatSampai, surahDari, surahSampai].forEach(el => {
          el.addEventListener("change", () => updateTotalJuz(row));
        });

        // === NEW: pastikan opsi jenjang otomatis extend s/d JENJANG_MAX
        const jenSel = row.querySelector(".jenjang");
        ensureJenjangOptions(jenSel, JENJANG_MAX, jenNow);

        // === Handler ubah JENJANG ‚Üí tulis balik ke kelas_{}.json (validasi dinamis)
        if (jenSel) {
          jenSel.addEventListener("change", async () => {
            const key  = String(row.dataset?.key || row.dataset?.nis || row.dataset?.id || "").trim();
            const oldJ = String(row.dataset?.jenjang ?? (window.jenjangMap?.[key] ?? jenNow ?? ""));
            const newJ = String(jenSel.value || "");

            if (!isValidJenjang(newJ)) {
              alert(`Jenjang harus A1 - A${JENJANG_MAX || '‚àû'} (atau kosong).`);
              jenSel.value = oldJ;
              return;
            }

            jenSel.disabled = true;
            jenSel.style.opacity = "0.6";
            try {
              const res = await fetch(`/api/updateJenjangKelas?kelas=${encodeURIComponent(kelas)}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ key, jenjang: newJ })
              });

              const text = await res.text();
              let out = {};
              try { out = JSON.parse(text); } catch {}

              if (!res.ok || out?.success !== true) {
                throw new Error(out?.error || text || "Gagal update jenjang.");
              }

              window.jenjangMap[key] = newJ;   // sync cache
              row.dataset.jenjang    = newJ;   // sync dataset
            } catch (e) {
              alert("Gagal menyimpan jenjang ke kelas: " + e.message);
              jenSel.value = oldJ; // rollback
            } finally {
              jenSel.disabled = false;
              jenSel.style.opacity = "";
            }
          }, { once: false });
        }

        // === Handler ubah KETERANGAN ‚Üí tulis balik ke kelas_{}.json
        const ketSel = row.querySelector(".keterangan");
        if (ketSel) {
          ketSel.addEventListener("change", async () => {
            const key  = String(row.dataset?.key || row.dataset?.nis || row.dataset?.id || "").trim();
            const oldK = String(row.dataset?.keterangan ?? (window.keteranganMap?.[key] ?? ketNow ?? ""));
            const newK = String(ketSel.value || "");

            if (newK && !/^SP[1-4]$/.test(newK)) {
              alert("Keterangan harus SP1 - SP4 (atau kosong).");
              ketSel.value = oldK;
              return;
            }

            ketSel.disabled = true;
            ketSel.style.opacity = "0.6";
            try {
              const res = await fetch(`/api/updateKeteranganKelas?kelas=${encodeURIComponent(kelas)}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ key, keterangan: newK })
              });

              const text = await res.text();
              let out = {};
              try { out = JSON.parse(text); } catch {}

              if (!res.ok || out?.success !== true) {
                throw new Error(out?.error || text || "Gagal update keterangan.");
              }

              window.keteranganMap[key] = newK; // sync cache
              row.dataset.keterangan    = newK; // sync dataset
            } catch (e) {
              alert("Gagal menyimpan keterangan ke kelas: " + e.message);
              ketSel.value = oldK; // rollback
            } finally {
              ketSel.disabled = false;
              ketSel.style.opacity = "";
            }
          });
        }

        // === Handler ubah SEMESTER ‚Üí tulis balik ke kelas_{}.json
        const semSel = row.querySelector(".semester");
        if (semSel) {
          semSel.addEventListener("change", async () => {
            const key    = String(row.dataset?.key || row.dataset?.nis || row.dataset?.id || "").trim();
            const oldSem = String(window.semesterMap?.[key] ?? semNow ?? "1");
            const newSem = String(semSel.value || oldSem);

            if (!isValidSemester(newSem)) {
  		alert(`Semester harus 1-${SEMESTER_MAX}.`);
  		semSel.value = oldSem;
  		return;
		}

            semSel.disabled = true;
            semSel.style.opacity = "0.6";
            try {
              const res = await fetch(`/api/updateSemesterKelas?kelas=${encodeURIComponent(kelas)}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ key, semester: newSem })
              });
              const text = await res.text();
              let out = {};
              try { out = JSON.parse(text); } catch {}

              if (!res.ok || out?.success !== true) {
                throw new Error(out?.error || text || "Gagal update semester.");
              }

              window.semesterMap[key] = newSem; // sync cache
            } catch (e) {
              alert("Gagal menyimpan semester ke kelas: " + e.message);
              semSel.value = oldSem; // rollback
            } finally {
              semSel.disabled = false;
              semSel.style.opacity = "";
            }
          });
        }
      });
    });
  } catch (err) {
    alert("Gagal memuat data santri / absensi!");
    console.error(err);
  }

  overlay.style.display = "none";
}




    function fillAyatOptions(selectEl, surahId, selectedAyat = 1) {
      const surah = surahList.find(s => s.id == surahId);
      if (!surah) return;
      selectEl.innerHTML = "";
      for (let i = 1; i <= surah.jumlah_ayat; i++) {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = i;
        if (i == selectedAyat) opt.selected = true;
        selectEl.appendChild(opt);
      }
    }

    const jumlahAyatPerHalaman = {"1":7,"2":5,"3":11,"4":8,"5":5,"6":8,"7":11,"8":9,"9":4,"10":8,"11":7,"12":7,"13":5,"14":5,"15":8,"16":4,"17":7,"18":7,"19":7,"20":8,"21":7,"22":4,"23":8,"24":10,"25":6,"26":7,"27":5,"28":5,"29":4,"30":6,"31":6,"32":8,"33":5,"34":4,"35":5,"36":6,"37":3,"38":4,"39":8,"40":3,"41":4,"42":4,"43":3,"44":5,"45":5,"46":5,"47":7,"48":1,"49":4,"50":9,"51":6,"52":7,"53":7,"54":8,"55":8,"56":7,"57":9,"58":9,"59":7,"60":6,"61":8,"62":9,"63":8,"64":7,"65":6,"66":11,"67":8,"68":8,"69":5,"70":4,"71":8,"72":8,"73":7,"74":6,"75":8,"76":6,"77":6,"78":5,"79":3,"80":5,"81":4,"82":3,"83":7,"84":4,"85":7,"86":7,"87":8,"88":6,"89":9,"90":5,"91":7,"92":5,"93":3,"94":7,"95":4,"96":8,"97":8,"98":6,"99":7,"100":6,"101":7,"102":7,"103":8,"104":8,"105":5,"106":3,"107":3,"108":4,"109":4,"110":4,"111":6,"112":8,"113":5,"114":5,"115":4,"116":5,"117":7,"118":7,"119":6,"120":6,"121":6,"122":7,"123":6,"124":8,"125":5,"126":5,"127":7,"128":8,"129":10,"130":9,"131":8,"132":9,"133":8,"134":7,"135":9,"136":5,"137":8,"138":9,"139":4,"140":7,"141":9,"142":8,"143":6,"144":7,"145":6,"146":5,"147":4,"148":5,"149":6,"150":8,"151":11,"152":11,"153":8,"154":7,"155":6,"156":8,"157":6,"158":10,"159":6,"160":8,"161":6,"162":8,"163":9,"164":16,"165":10,"166":7,"167":6,"168":6,"169":6,"170":4,"171":4,"172":7,"173":8,"174":9,"175":8,"176":11,"177":8,"178":8,"179":9,"180":8,"181":7,"182":5,"183":7,"184":9,"185":8,"186":6,"187":6,"188":7,"189":7,"190":6,"191":5,"192":5,"193":4,"194":7,"195":7,"196":7,"197":7,"198":4,"199":7,"200":7,"201":7,"202":6,"203":7,"204":5,"205":6,"206":5,"207":7,"208":6,"209":8,"210":6,"211":5,"212":8,"213":9,"214":11,"215":8,"216":9,"217":8,"218":10,"219":9,"220":9,"221":8,"222":7,"223":7,"224":9,"225":9,"226":8,"227":8,"228":9,"229":9,"230":10,"231":7,"232":9,"233":11,"234":9,"235":10,"236":10,"237":8,"238":8,"239":7,"240":6,"241":9,"242":11,"243":6,"244":9,"245":8,"246":9,"247":8,"248":8,"249":5,"250":8,"251":5,"252":10,"253":6,"254":8,"255":6,"256":5,"257":8,"258":6,"259":9,"260":9,"261":10,"262":15,"263":16,"264":20,"265":19,"266":20,"267":15,"268":8,"269":12,"270":8,"271":8,"272":12,"273":10,"274":8,"275":7,"276":8,"277":6,"278":9,"279":8,"280":8,"281":10,"282":7,"283":10,"284":10,"285":11,"286":11,"287":9,"288":8,"289":9,"290":11,"291":10,"292":8,"293":11,"294":11,"295":5,"296":7,"297":7,"298":11,"299":8,"300":8,"301":13,"302":9,"303":14,"304":13,"305":11,"306":14,"307":13,"308":13,"309":13,"310":12,"311":19,"312":15,"313":25,"314":14,"315":13,"316":12,"317":11,"318":11,"319":15,"320":12,"321":10,"322":10,"323":14,"324":11,"325":9,"326":13,"327":15,"328":9,"329":9,"330":11,"331":11,"332":5,"333":10,"334":8,"335":7,"336":8,"337":8,"338":9,"339":9,"340":8,"341":6,"342":17,"343":10,"344":15,"345":17,"346":15,"347":15,"348":15,"349":14,"350":10,"351":10,"352":7,"353":4,"354":5,"355":7,"356":10,"357":5,"358":3,"359":5,"360":9,"361":9,"362":12,"363":11,"364":12,"365":12,"366":10,"367":19,"368":20,"369":21,"370":23,"371":28,"372":25,"373":23,"374":24,"375":23,"376":21,"377":13,"378":9,"379":13,"380":9,"381":11,"382":8,"383":13,"384":12,"385":10,"386":8,"387":8,"388":7,"389":7,"390":8,"391":7,"392":9,"393":11,"394":7,"395":7,"396":10,"397":8,"398":9,"399":7,"400":8,"401":7,"402":7,"403":11,"404":11,"405":10,"406":9,"407":8,"408":9,"409":9,"410":10,"411":11,"412":8,"413":9,"414":6,"415":11,"416":9,"417":10,"418":6,"419":9,"420":7,"421":8,"422":5,"423":8,"424":7,"425":4,"426":8,"427":11,"428":7,"429":7,"430":8,"431":9,"432":8,"433":9,"434":9,"435":8,"436":7,"437":12,"438":8,"439":6,"440":13,"441":15,"442":13,"443":14,"444":16,"445":13,"446":24,"447":27,"448":25,"449":26,"450":24,"451":27,"452":29,"453":16,"454":10,"455":16,"456":19,"457":22,"458":10,"459":5,"460":11,"461":10,"462":9,"463":7,"464":9,"465":11,"466":7,"467":8,"468":9,"469":9,"470":8,"471":7,"472":9,"473":9,"474":8,"475":11,"476":8,"477":11,"478":9,"479":9,"480":9,"481":8,"482":8,"483":10,"484":5,"485":7,"486":9,"487":13,"488":7,"489":12,"490":12,"491":11,"492":14,"493":13,"494":13,"495":16,"496":18,"497":21,"498":20,"499":13,"500":9,"501":10,"502":10,"503":9,"504":6,"505":8,"506":7,"507":11,"508":8,"509":10,"510":9,"511":9,"512":6,"513":8,"514":5,"515":5,"516":7,"517":7,"518":15,"519":20,"520":16,"521":24,"522":21,"523":23,"524":17,"525":18,"526":26,"527":18,"528":24,"529":21,"530":22,"531":22,"532":24,"533":27,"534":27,"535":34,"536":26,"537":23,"538":8,"539":7,"540":6,"541":5,"542":6,"543":5,"544":10,"545":4,"546":6,"547":7,"548":8,"549":5,"550":6,"551":7,"552":9,"553":8,"554":7,"555":7,"556":9,"557":9,"558":5,"559":7,"560":7,"561":5,"562":12,"563":14,"564":19,"565":27,"566":18,"567":26,"568":28,"569":29,"570":15,"571":18,"572":13,"573":15,"574":19,"575":18,"576":30,"577":28,"578":26,"579":20,"580":25,"581":31,"582":30,"583":25,"584":31,"585":42,"586":29,"587":25,"588":28,"589":27,"590":22,"591":32,"592":30,"593":23,"594":27,"595":29,"596":26,"597":27,"598":12,"599":18,"600":21,"601":17,"602":14,"603":14,"604":15
};

function updateTotalJuz(row) {
  const surahDari = row.querySelector(".surah-dari").value.trim();
  const ayatDari = Number(row.querySelector(".ayat-dari").value.trim());
  const surahSampai = row.querySelector(".surah-sampai").value.trim();
  const ayatSampai = Number(row.querySelector(".ayat-sampai").value.trim());

  const halamanAwalJuz = [
    1, 22, 42, 62, 82, 102, 122, 142, 162, 182,
    202, 222, 242, 262, 282, 302, 322, 342, 362, 382,
    402, 422, 442, 462, 482, 502, 522, 542, 562, 582, 602
  ];

  let totalJuz = 0;
  const halamanValid = [];

  // Loop dari surahDari:ayatDari ‚Üí surahSampai:ayatSampai per ayat
for (let s = Number(surahDari); s <= Number(surahSampai); s++) {
  const surah = surahList.find(x => Number(x.id) === s);
  if (!surah) continue;
  const totalAyatSurah = surah.jumlah_ayat;

  const startAyat = (s === Number(surahDari)) ? ayatDari : 1;
  const endAyat = (s === Number(surahSampai)) ? ayatSampai : totalAyatSurah;

  for (let a = startAyat; a <= endAyat; a++) {
    const key = `${s}:${a}`;
    const halaman = pagesMap[key];
    if (!halaman) continue;

    // PAGE: selalu dicatat (termasuk 21, 602, 603, 604)
    halamanValid.push(halaman);

    // JUZ: hanya dihitung jika BUKAN 21 dan BUKAN 602‚Äì604
    if (halaman === 21 || (halaman >= 602 && halaman <= 604)) continue;

    const ayatDiHalaman = jumlahAyatPerHalaman[halaman];
    if (!ayatDiHalaman) {
      console.warn(`Jumlah ayat tidak ditemukan untuk halaman ${halaman}`);
      continue;
    }

    totalJuz += (0.05 / ayatDiHalaman); // bobot per ayat
  }
}

totalJuz = totalJuz.toFixed(2);


 // Hilangkan halaman duplikat untuk perhitungan juz tercakup
  const halamanUnik = [...new Set(halamanValid)].sort((a, b) => a - b);

  const juzTercakup = [];
  for (let i = 0; i < halamanAwalJuz.length; i++) {
    const awalJuz = halamanAwalJuz[i];
    const akhirJuz = i < halamanAwalJuz.length - 1 ? halamanAwalJuz[i + 1] - 1 : 604;

    if (akhirJuz >= 602 && awalJuz <= 604) continue;

    for (let h of halamanUnik) {
      if (h >= awalJuz && h <= akhirJuz) {
        juzTercakup.push(i + 1);
        break;
      }
    }
  }

  function compressJuzRanges(list) {
    if (list.length === 0) return "";
    list.sort((a, b) => a - b);
    const ranges = [];
    let start = list[0], end = start;
    for (let i = 1; i < list.length; i++) {
      if (list[i] === end + 1) {
        end = list[i];
      } else {
        ranges.push(start === end ? `${start}` : `${start}-${end}`);
        start = end = list[i];
      }
    }
    ranges.push(start === end ? `${start}` : `${start}-${end}`);
    return ranges.join(", ");
  }

	const juzTerbacaFormatted = compressJuzRanges(juzTercakup);

	 // Hitung pages quran
	function calculateHalamanTerbaca(halamanList) {
  if (!halamanList || halamanList.length === 0) return { ranges: "-", total: 0 };

  const halamanCountMap = {}; // key: halaman, value: jumlah ayat terbaca
  for (let h of halamanList) {
    halamanCountMap[h] = (halamanCountMap[h] || 0) + 1;
  }

  const uniqueHalaman = Object.keys(halamanCountMap)
                             .map(Number)
                             .sort((a, b) => a - b);

  const ranges = [];
  let totalHalaman = 0;

  let start = uniqueHalaman[0];
  let end = start;

  for (let i = 0; i < uniqueHalaman.length; i++) {
    const h = uniqueHalaman[i];
    const ayatTerbaca = halamanCountMap[h];
    const ayatTotal = jumlahAyatPerHalaman[h] || 1;
    totalHalaman += ayatTerbaca / ayatTotal;

    if (i > 0) {
      if (h === end + 1) {
        end = h;
      } else {
        ranges.push(start === end ? `${start}` : `${start}-${end}`);
        start = end = h;
      }
    }
  }

  ranges.push(start === end ? `${start}` : `${start}-${end}`);

  return { ranges: ranges.join(", "), total: totalHalaman };
}

// Pemakaian di tabel
const result = calculateHalamanTerbaca(halamanValid);
row.querySelector(".halaman-terbaca").textContent = result.ranges;
row.querySelector(".total-halaman").textContent = result.total.toFixed(2);
  
  row.querySelector(".juz-terbaca").textContent = juzTerbacaFormatted;
  row.querySelector(".total-juz").textContent = totalJuz;
}

    kelasSelect.addEventListener("change", loadSantriData);
    tanggalInput.addEventListener("change", loadSantriData);


// ===== Save Data (ringkas, ikut pola <td> ‚áÑ server) =====
async function simpanDataMutabaah(saveBtn){
  const table = document.querySelector('#santri-table');
  const rows  = document.querySelectorAll('#santri-table tbody tr');

  // --- Resolve kelas & tanggal global (fleksibel) ---
  function resolveKelas(){
    const byWin=(window.kelasSelect?.value)||'';
    const byId =document.querySelector('#kelasSelect')?.value || document.querySelector('#kelas')?.value || '';
    const byNm =document.querySelector('select[name="kelas"]')?.value || document.querySelector('input[name="kelas"]')?.value || '';
    const byDt =document.querySelector('#santri-table')?.dataset?.kelas || document.body?.dataset?.kelas || '';
    if (String(byWin).trim()) return String(byWin).trim();
    if (String(byId).trim())  return String(byId).trim();
    if (String(byNm).trim())  return String(byNm).trim();
    if (String(byDt).trim())  return String(byDt).trim();
    const r=document.querySelector('#santri-table tbody tr');
    return String(r?.dataset?.kelas||'').trim();
  }
  function resolveTanggalGlobal(){
    const byWin=(window.tanggalInput?.value)||'';
    const byId =document.querySelector('#tanggalInput')?.value || document.querySelector('#tanggal')?.value || document.querySelector('#date')?.value || '';
    const byNm =document.querySelector('input[name="tanggal"]')?.value || document.querySelector('input[name="date"]')?.value || '';
    if (String(byWin).trim()) return String(byWin).trim();
    if (String(byId).trim())  return String(byId).trim();
    if (String(byNm).trim())  return String(byNm).trim();
    return '';
  }
  const kelas = resolveKelas();
  const tanggalGlobal = resolveTanggalGlobal();

  // --- Jika kelas kosong beneran, stop (ini wajib) ---
  if (!kelas) { alert('Kelas belum terdeteksi.'); return; }

  // --- Kompilasi tanggal per baris; kalau kosong semua, pakai tanggal global ---
  const tanggalSet = new Set([...rows].map(r=>String(r.dataset?.tanggal||'').trim()).filter(Boolean));
  if (!tanggalSet.size && tanggalGlobal) tanggalSet.add(tanggalGlobal);

  if (!tanggalSet.size){
    alert('Tanggal tidak ditemukan baik di baris maupun header.');
    return;
  }

  // helpers
  const parseNum=(v)=>{ if(typeof v==='number')return Number.isFinite(v)?v:0; const s=String(v??'').replace(/[^0-9.,-]/g,'').replace(',', '.'); const n=parseFloat(s); return Number.isFinite(n)?n:0; };
  function getNamaFromCell(cell){ if(!cell)return ""; const first=cell.childNodes&&cell.childNodes[0]; const txt=(first&&first.textContent)?first.textContent:cell.textContent; return String(txt).trim(); }
  function getRowId(row){ const raw=row.children[0]?.textContent?.trim()||""; const asNum=parseInt(raw,10); return Number.isNaN(asNum)?raw:asNum; }
  function parseNilaiStr(nilaiStr){
    if(!nilaiStr) return {nilai:null,predikatText:null,predikatHuruf:null};
    const parts=nilaiStr.trim().split(/\s+/).filter(Boolean);
    let numIdx=parts.findIndex(p=>/^-?\d+(,\d+|\.\d+)?$/.test(p));
    if(numIdx===-1) numIdx=parts.findIndex(p=>!Number.isNaN(parseFloat(p.replace(',','.'))));
    let nilai=null; if(numIdx!==-1) nilai=parseFloat(parts[numIdx].replace(',','.'));
    const rest=parts.filter((_,i)=>i!==numIdx).map(p=>p.replace(/[^\p{L}\p{N}\-]/gu,'')).filter(Boolean);
    const gIdx=rest.findIndex(p=>/^[A-E]$/i.test(p));
    const huruf=gIdx!==-1?rest[gIdx].toUpperCase():null;
    const teks =rest.filter((_,i)=>i!==gIdx && rest[i]!=='-'); 
    return { nilai, predikatText: (teks.length?teks.join(' '):null), predikatHuruf:huruf };
  }

  // UI lock
  if (saveBtn){ saveBtn.disabled=true; saveBtn.dataset._old=saveBtn.textContent; saveBtn.textContent='‚è≥ Menyimpan...'; }

  // Timeout agar tidak ‚Äúmenggantung‚Äù
  const controller = new AbortController();
  const cancelTimer = setTimeout(()=>controller.abort(), 15000);

  try{
    const hasilKirim=[];

    for (const tanggal of tanggalSet){
      // Filter baris sesuai tanggal ini (kalau tabel multi-tanggal). Jika semua baris tanpa tanggal dan hanya ada tanggalGlobal, pakai semuanya.
      const rowsTanggal = [...rows].filter(r=>{
        const rt = String(r.dataset?.tanggal||'').trim();
        return tanggalGlobal && !rt ? true : (rt===tanggal);
      });

      // Ambil data lama (untuk merge field lain)
      let dataLama=[];
      try{
        const r=await fetch(`/api/getAbsensi?kelas=${encodeURIComponent(kelas)}&tanggal=${encodeURIComponent(tanggal)}&t=${Date.now()}`, { signal: controller.signal });
        if(r.ok){ dataLama=await r.json(); }
      }catch{ /* biarkan kosong, lanjut dengan [] */ }

      const dataMerged = Array.isArray(dataLama)?[...dataLama]:[];

      rowsTanggal.forEach(row=>{
        const id=getRowId(row);
        const existing=dataMerged.find(d=>String(d.id)===String(id))||{};
        const nama=getNamaFromCell(row.children[1]);

        const keySem=String((row.dataset?.nis||row.dataset?.id||"")||"").trim();
        const semester=(window.semesterMap?.[keySem]) ?? existing.semester ?? "";
        const jenjang =(window.jenjangMap?.[keySem])  ?? existing.jenjang  ?? "";
        const keterangan=(window.keteranganMap?.[keySem]) ?? existing.keterangan ?? "";
        const nis=String(row.dataset?.nis || existing.nis || "").trim();

        // Ambil kolom lain sesuai pola index.html
        const surahDari    = row.querySelector(".surah-dari")?.value ?? "";
        const ayatDari     = row.querySelector(".ayat-dari")?.value ?? "";
        const surahSampai  = row.querySelector(".surah-sampai")?.value ?? "";
        const ayatSampai   = row.querySelector(".ayat-sampai")?.value ?? "";
        const totalJuz     = row.querySelector(".total-juz")?.textContent ?? existing.totalJuz ?? "0";
        const halaman      = row.querySelector(".halaman-terbaca")?.textContent ?? existing.halaman ?? "";
        const totalHalaman = row.querySelector(".total-halaman")?.textContent ?? existing.totalHalaman ?? "";
        const juzTerbaca   = row.querySelector(".juz-terbaca")?.textContent ?? existing.juzTerbaca ?? "";

        // Nilai (opsional)
        const nilaiCell=row.querySelector(".lihat-quran-btn")?.parentElement;
        const nilaiStr =nilaiCell?.querySelector("div:nth-child(1)")?.innerText?.trim()||"";
        const parsed =parseNilaiStr(nilaiStr);
        let buttonCell;
        if (typeof parsed.nilai==="number" && !Number.isNaN(parsed.nilai)){
          const predikatText  =(parsed.predikatText && parsed.predikatText!=='-') ? parsed.predikatText : (existing.buttonCell?.predikatText ?? "-");
          const predikatHuruf =(parsed.predikatHuruf && parsed.predikatHuruf!=='-') ? parsed.predikatHuruf : (existing.buttonCell?.predikatHuruf ?? "-");
          buttonCell = { nilai: parsed.nilai, predikatText, predikatHuruf };
        } else if (existing.buttonCell) { buttonCell=existing.buttonCell; }

        // === Murajaah dari <td> ===
        const murCell=row.querySelector('.murajaah-cell');
        let juzMur=0, murFrom="", murTo="", murPages="";
        if (murCell){
          const valTxt=murCell.dataset.murtotal || murCell.querySelector('.mur-val')?.textContent || "0";
          juzMur=parseNum(valTxt);
          const sF=murCell.dataset.sf||"", aF=murCell.dataset.af||"";
          const sT=murCell.dataset.st||"", aT=murCell.dataset.at||"";
          const pF=murCell.dataset.pf||"", pT=murCell.dataset.pt||"";
          if(sF&&aF) murFrom=`${sF}:${aF}`;
          if(sT&&aT) murTo  =`${sT}:${aT}`;
          if(pF&&pT) murPages=`${pF}-${pT}`;
        } else {
          juzMur   = parseNum(existing.juzmurajaah||0);
          murFrom  = existing.murFrom || "";
          murTo    = existing.murTo   || "";
          murPages = existing.murPages|| "";
        }

        // === ABSENSI (meniru A57.html) ===
        // 1) coba ambil dari elemen spesifik baris (select/input)
        //    - <select class="absensi"> / input[name="absensi"] / radio[name="absensi-<id>"]
        // 2) fallback ke dataset atau existing.absensi
        let absensi =
          row.querySelector('.absensi')?.value
          ?? row.querySelector('select[name="absensi"]')?.value
          ?? row.querySelector('input[name="absensi"]')?.value
          ?? row.querySelector(`input[name="absensi-${id}"]:checked`)?.value
          ?? row.dataset?.absensi
          ?? existing.absensi
          ?? "";

        // === MARKS (meniru A57.html) ===
        // Jika ada markData yang ditempel di DOM baris, gunakan itu; kalau tidak, pertahankan existing.marks
        const marks = (row.markData && typeof row.markData === 'object')
          ? row.markData
          : (existing.marks || { audio: [] });

        const base={
          ...existing,
          id, nis, nama, jenjang, semester,
          absensi,                // <<< penting: ikut dikirim (A57.html)
          dari:`${surahDari}:${ayatDari}`,
          sampai:`${surahSampai}:${ayatSampai}`,
          totalJuz, halaman, totalHalaman, juzTerbaca, keterangan,
          juzmurajaah:Number(juzMur.toFixed(2)),
          murFrom, murTo, murPages,
          marks                   // <<< penting: ikut dikirim (A57.html)
        };
        const newData = buttonCell ? { ...base, buttonCell } : base;

        const idx=dataMerged.findIndex(d=>String(d.id)===String(id));
        if(idx!==-1) dataMerged[idx]=newData; else dataMerged.push(newData);
      });

      // Kirim ke server (POST)
      let result = {};
      try{
        const res=await fetch('/api/saveData',{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Accept':'application/json'
          },
          body: JSON.stringify({ tanggal, kelas, data: dataMerged }),
          signal: controller.signal,
          credentials: 'same-origin'
        });
        const ct = res.headers.get('content-type') || '';
        const isJSON = ct.includes('application/json');
        result = isJSON ? await res.json() : { success: res.ok, message: await res.text() };
        if(!res.ok){
          throw new Error((result && result.message) || `Gagal (${res.status})`);
        }
      }catch(err){
        hasilKirim.push({ tanggal, ok:false, result:{ success:false, message:String(err.message||err) } });
        continue; // lanjut tanggal berikutnya
      }
      hasilKirim.push({ tanggal, ok: !!result?.success, result });
    }

    const gagal=hasilKirim.filter(h=>!h.ok);
    if(!gagal.length){
      if(saveBtn) saveBtn.textContent='‚úÖ Tersimpan';
      // rehydrate agar sinkron lintas browser
      if (window.murajaah && typeof window.murajaah.refreshServer==='function'){
        try{ await window.murajaah.refreshServer(); }catch{}
      }
    }else{
      const daftar=gagal.map(g=>g.tanggal).join(', ');
      alert(`‚ùå Sebagian tanggal gagal disimpan: ${daftar}`);
      if(saveBtn) saveBtn.textContent='‚ùå Gagal Sebagian';
      console.warn('Detail gagal:', gagal);
    }

  }catch(e){
    console.error(e);
    alert('‚ö†Ô∏è Error menyimpan data!');
  }finally{
    clearTimeout(cancelTimer);
    if(saveBtn){
      setTimeout(()=>{
        saveBtn.textContent = saveBtn.dataset._old || 'Save Data';
        saveBtn.disabled=false;
        delete saveBtn.dataset._old;
      }, 1200);
    }
  }
}

// Listener tombol
document.getElementById('save-btn')?.addEventListener('click', function(){ simpanDataMutabaah(this); });
document.getElementById('save-btn-modal')?.addEventListener('click', function(){ simpanDataMutabaah(this); });
document.getElementById('mur-save')?.addEventListener('click', function(){ simpanDataMutabaah(this); });



// ============================
// Download PDF
// ============================
(function(){
  const $ = sel => document.querySelector(sel);

  function fmtD_M_YYYY(iso){
    if (!iso) return '';
    const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return iso;
    return `${Number(m[3])}-${Number(m[2])}-${m[1]}`;
  }

  // ===== Inject CSS kontrol =====
  (function injectStyles(){
    if (document.getElementById('rekap-style')) return;
    const s = document.createElement('style');
    s.id = 'rekap-style';
    s.textContent = `
      .pdf-rekap-controls{
        display:flex; flex-wrap:wrap; gap:.6rem; align-items:center;
        background:#fff; border:1px solid #e5e7eb; border-radius:12px;
        padding:.6rem .8rem; box-shadow:0 1px 2px rgba(0,0,0,.04);
        margin:.6rem 0 .9rem;
      }
      .pdf-rekap-controls label{
        display:flex; gap:.35rem; align-items:center; font-weight:600; color:#111827;
      }
      .pdf-rekap-controls input[type="date"],
      .pdf-rekap-controls select{
        padding:.42rem .55rem; border:1px solid #d1d5db; border-radius:10px;
        min-height:2.1rem; font:inherit; color:#111827; background:#fff;
      }
      .pdf-rekap-controls .rekap-btn{
        padding:.55rem .9rem; border:none; border-radius:10px; font-weight:700; letter-spacing:.2px;
        box-shadow:0 1px 1px rgba(0,0,0,.05); color:#fff; cursor:pointer;
      }
      #download-pdf-rekap.rekap-btn{ background:#0ea5e9; }
      #download-xls-rekap.rekap-btn{ background:#22c55e; }
      #download-pdf-santri.rekap-btn{ background:#8b5cf6; }
	  #download-pdf-allkelas.rekap-btn{ background:#f59e0b; } /* oranye */
      .pdf-rekap-controls .rekap-btn:hover{ filter:brightness(.97); }
      .pdf-rekap-controls .rekap-btn:disabled{ opacity:.6; cursor:not-allowed; }
    `;
    document.head.appendChild(s);
  })();

	/** Konversi kode A1..A34 => label ILA..ILD, 1A..1J, 2A..2J, 3A..3J, dst */
function jenjangLabel(code) {
  const m = String(code || '').trim().match(/^A(\d+)$/i);
  if (!m) return String(code || '');     // kalau kosong/di luar pola, tampilkan apa adanya
  const n = Number(m[1]);
  if (n >= 1 && n <= 4) {
    return ['ILA','ILB','ILC','ILD'][n - 1];
  }
  // A5..A14 => 1A..1J, A15..A24 => 2A..2J, A25..A34 => 3A..3J, dst
  const group = Math.floor((n - 5) / 10) + 1;        // 1, 2, 3, ...
  const idx   = (n - 5) % 10;                        // 0..9
  const letter = String.fromCharCode(65 + idx);      // 'A'..'J'
  return `${group}${letter}`;
}

  // === Helper Kelas/Kelompok ===
  function buildKelasKelompokLine(kelas, kelasEl) {
    const kelasNum = (String(kelas||'').match(/(\d+)/)?.[1]) || (kelas || '-');
    const custom = window.namaKelasCustom || window.NAMA_KELAS_CUSTOM || {  kelas_01: "Kelompok Ust. Dicky Miswardi, B.A.",
  kelas_012526: "Kelompok Ust. Moro, B.A.",
  kelas_02: "Kelompok Ust. Obie Zarobie, B.A."};
    let kelompok = custom[kelas] || "";
    if (!kelompok) {
      const optText = kelasEl?.options?.[kelasEl.selectedIndex]?.text?.trim() || "";
      const fromOpt = (optText.match(/Kelompok\s+(.+)/i)?.[1] || optText).trim();
      if (fromOpt) kelompok = fromOpt;
    }
    kelompok = (kelompok || '').replace(/^Kelompok\s+/i, '').trim() || '-';
    return { kelasNum, kelompok, line: `Halaqoh: ${kelasNum}, ${kelompok}` };
  }

  function setBtnLoading(btn, loading, loadingText='Mengerjakan‚Ä¶') {
    if (!btn) return;
    if (loading) {
      btn.dataset._oldText = btn.textContent;
      btn.textContent = loadingText;
      btn.disabled = true;
    } else {
      if (btn.dataset._oldText) btn.textContent = btn.dataset._oldText;
      btn.disabled = false;
      delete btn.dataset._oldText;
    }
  }

  // ====== Tombol ======
  const pdfBtn = document.getElementById('download-pdf-rekap');
  let xlsBtn = document.getElementById('download-xls-rekap');
  let allKelasBtn = document.getElementById('download-pdf-allkelas');
  let pdfSantriBtn = document.getElementById('download-pdf-santri'); // HANYA pemicu modal
  const santriSelect = document.getElementById('pdf-santri-select');

  if (!xlsBtn) {
    const wrap = document.querySelector('.pdf-rekap-controls');
    if (wrap) {
      xlsBtn = document.createElement('button');
      xlsBtn.id = 'download-xls-rekap';
      xlsBtn.className = 'rekap-btn';
      xlsBtn.textContent = 'Download Excel Rekap';
      wrap.appendChild(xlsBtn);
    }
  }

  pdfBtn?.classList.add('rekap-btn');
  pdfBtn?.addEventListener('click', pdfRekapDownload);
  xlsBtn?.addEventListener('click', xlsRekapDownload);


  if (!allKelasBtn) {
  const wrap = document.querySelector('.pdf-rekap-controls');
  if (wrap) {
    allKelasBtn = document.createElement('button');
    allKelasBtn.id = 'download-pdf-allkelas';
    allKelasBtn.className = 'rekap-btn';
    allKelasBtn.textContent = 'Download PDF All Kelas';
    wrap.appendChild(allKelasBtn);
  }
}
allKelasBtn?.addEventListener('click', pdfAllKelasDownload);

  // Saat tanggal berubah, muat ulang opsi santri (opsional)
  $('#pdf-start-date')?.addEventListener('change', () => { window._populateSantriSelect?.(); });
  $('#pdf-end-date')?.addEventListener('change', () => { window._populateSantriSelect?.(); });

  // ====== Loader XLSX ======
  async function ensureXLSX(){
    if (window.XLSX) return;
    await new Promise((resolve, reject) => {
      const sc = document.createElement('script');
      sc.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
      sc.onload = resolve; sc.onerror = () => reject(new Error('Gagal memuat XLSX'));
      document.head.appendChild(sc);
    });
  }

  // ====== Ambil & Agregasi Data ======
  async function collectRekapData(){
    const kelasEl = (typeof kelasSelect !== 'undefined' && kelasSelect) ? kelasSelect : document.getElementById('kelasSelect');
    const kelas = kelasEl?.value || '';
    const startDate = document.querySelector('#pdf-start-date')?.value;
    const endDate   = document.querySelector('#pdf-end-date')?.value;
    if (!startDate || !endDate) throw new Error('Mohon pilih tanggal mulai dan tanggal akhir.');

    const { line: kelasLine } = buildKelasKelompokLine(kelas, kelasEl);

    // 1) ABSENSI
    const absUrl = `/api/getAbsensiRange?kelas=${encodeURIComponent(kelas)}&start=${encodeURIComponent(startDate)}&end=${encodeURIComponent(endDate)}&t=${Date.now()}`;
    const resAbs = await fetch(absUrl);
    if (!resAbs.ok) throw new Error('Gagal mengambil data absensi.');
    let allData = await resAbs.json();
    if (!Array.isArray(allData) || allData.length === 0) throw new Error('Tidak ada data pada rentang tanggal tersebut.');

    // 2) ROSTER
    const resSantri = await fetch(`/api/getSantri?kelas=${encodeURIComponent(kelas)}&t=${Date.now()}`);
    const santriData = await resSantri.json().catch(()=>[]) || [];

    // helper index
    const keyId   = v => (v === 0 || v) ? String(v).trim() : "";
    const keyNis  = v => (v === 0 || v) ? String(v).trim() : "";
    const keyName = v => String(v || "").trim().toLowerCase();
    const byIdMap = (arr, pick = x => x) => { const m = new Map(); for (const a of arr||[]) { const id = keyId(a?.id); if (id) m.set(id, pick(a)); } return m; };
    const byNisMap = (arr, pick = x => x) => { const m = new Map(); for (const a of arr||[]) { const nis = keyNis(a?.nis); if (nis) m.set(nis, pick(a)); } return m; };
    const byNameMap = (arr, pick = x => x) => { const m = new Map(); for (const a of arr||[]) { const nm = keyName(a?.nama); if (nm && !m.has(nm)) m.set(nm, pick(a)); } return m; };
    const rosterById   = byIdMap(santriData, s => s);
    const rosterByNis  = byNisMap(santriData, s => s);
    const rosterByName = byNameMap(santriData, s => s);

    // 3) Normalisasi (+ inject semester, jenjang, keterangan)
    const allDataNorm = allData.map(r => {
      let id   = keyId(r?.id ?? "");
      let nis  = keyNis(r?.nis ?? "");
      const nmK = keyName(r?.nama);
      if (!nis && id && rosterById.get(id)?.nis) nis = keyNis(rosterById.get(id).nis);
      if (!nis && nmK && rosterByName.get(nmK)?.nis) nis = keyNis(rosterByName.get(nmK).nis);

      let nama = r?.nama;
      if (!nama && nis && rosterByNis.get(nis)?.nama) nama = rosterByNis.get(nis).nama;
      if (!nama && id  && rosterById.get(id)?.nama)  nama = rosterById.get(id).nama;
      if (!id && nis && rosterByNis.get(nis)?.id) id = keyId(rosterByNis.get(nis).id);

      let semester = (r?.semester != null) ? Number(r.semester) : null;
      if (semester == null) {
        if (nis && rosterByNis.get(nis)?.semester != null) semester = Number(rosterByNis.get(nis).semester);
        else if (id && rosterById.get(id)?.semester != null) semester = Number(rosterById.get(id).semester);
      }

      let jenjang = r?.jenjang ?? null;
      if (!jenjang && nis && rosterByNis.get(nis)?.jenjang) jenjang = rosterByNis.get(nis).jenjang;
      if (!jenjang && id  && rosterById.get(id)?.jenjang)  jenjang = rosterById.get(id).jenjang;

      let keterangan = r?.keterangan ?? null;
      if (!keterangan && nis && rosterByNis.get(nis)?.keterangan) keterangan = rosterByNis.get(nis).keterangan;
      if (!keterangan && id  && rosterById.get(id)?.keterangan)  keterangan = rosterById.get(id).keterangan;

      return { ...r, id, nis, nama, semester, jenjang, keterangan, tanggal: r?.tanggal ? String(r.tanggal).slice(0,10) : null };
    });

    // KBM hari unik (kelas)
    const kbmDaySet = new Set();
    (allDataNorm||[]).forEach(it => { if (it?.tanggal) kbmDaySet.add(String(it.tanggal)); });
    const kbmDays = kbmDaySet.size;

    // Agregasi
    const aggMap = PDF_buildRekapPerKey(allDataNorm);
    const allRows = Object.values(aggMap).sort((a,b)=> (a.nama||a.nis||a.id).localeCompare(b.nama||b.nis||b.id,'id'));
    const rows = allRows.filter(r => (typeof r.nis === 'string' ? r.nis.trim() !== '' : !!r.nis));
    if (rows.length === 0) throw new Error('Tidak ada data ber-NIS pada rentang tanggal tersebut.');

    // Ringkasan total
    let totJuz=0, totH=0, totA=0, totS=0, totI=0, totPages=0;
    rows.forEach(r=>{ totJuz += r.totalJuz; totH += r.hadir; totA += r.alpha; totS += r.sakit; totI += r.izin; totPages += r.totalPageSum; });

    return { kelas, startDate, endDate, kelasLine, kbmDays, rows, allDataNorm,
      totals: { totJuz, totH, totA, totS, totI, totPages }
    };
  }

  // === Isi dropdown santri (modal) ===
  async function populateSantriSelect(){
    const sel = santriSelect;
    if (!sel) return;

    const kelasEl = (typeof kelasSelect !== 'undefined' && kelasSelect) ? kelasSelect : document.getElementById('kelasSelect');
    const kelas = kelasEl?.value || '';
    const startDate = $('#pdf-start-date')?.value;
    const endDate   = $('#pdf-end-date')?.value;

    sel.innerHTML = `<option value="">Memuat‚Ä¶</option>`;

    try {
      if (startDate && endDate) {
        const { allDataNorm } = await collectRekapData();
        const map = new Map();
        for (const it of allDataNorm) {
          const key = (it.nis && String(it.nis).trim()) || (it.id && String(it.id).trim());
          if (!key) continue;
          const nama = it.nama || '-';
          if (!map.has(key)) map.set(key, { key, nama, nis: it.nis||'', id: it.id||'' });
        }
        const arr = [...map.values()].sort((a,b)=>a.nama.localeCompare(b.nama,'id'));
        if (!arr.length) {
          sel.innerHTML = `<option value="">‚Äî Tidak ada data di rentang tanggal ‚Äî</option>`;
          return;
        }
        sel.innerHTML = `<option value="">‚Äî Pilih santri (ada data) ‚Äî</option>` +
          arr.map(x => `<option value="${x.key}" data-nama="${(x.nama||'').replace(/"/g,'&quot;')}">${x.nis ? x.nis : x.id} ‚Äî ${x.nama}</option>`).join('');
      } else {
        const resSantri = await fetch(`/api/getSantri?kelas=${encodeURIComponent(kelas)}&t=${Date.now()}`);
        const data = await resSantri.json().catch(()=>[]) || [];
        const arr = (data||[]).map(s => ({ key: (s.nis||s.id||'').toString(), nama: s.nama||'-', nis: s.nis||'', id: s.id||'' }))
                              .filter(x => x.key).sort((a,b)=>a.nama.localeCompare(b.nama,'id'));
        sel.innerHTML = `<option value="">‚Äî Pilih santri ‚Äî</option>` +
          arr.map(x => `<option value="${x.key}" data-nama="${(x.nama||'').replace(/"/g,'&quot;')}">${x.nis ? x.nis : x.id} ‚Äî ${x.nama}</option>`).join('');
      }
    } catch(e){
      sel.innerHTML = `<option value="">‚Äî Gagal memuat daftar santri ‚Äî</option>`;
      console.error(e);
    }
  }
  window._populateSantriSelect = populateSantriSelect;

  // ==================== Util Nama Surah & Setoran ====================
  const QURAN_SURAH_NAMES = [
    null,
    "Al-Fatihah","Al-Baqarah","Ali 'Imran","An-Nisa'","Al-Ma'idah","Al-An'am","Al-A'raf","Al-Anfal","At-Taubah",
    "Yunus","Hud","Yusuf","Ar-Ra'd","Ibrahim","Al-Hijr","An-Nahl","Al-Isra'","Al-Kahfi","Maryam","Ta Ha","Al-Anbiya'",
    "Al-Hajj","Al-Mu'minun","An-Nur","Al-Furqan","Asy-Syu'ara'","An-Naml","Al-Qasas","Al-'Ankabut","Ar-Rum","Luqman",
    "As-Sajdah","Al-Ahzab","Saba'","Fatir","Ya-Sin","As-Saffat","Sad","Az-Zumar","Ghafir","Fussilat","Asy-Syura",
    "Az-Zukhruf","Ad-Dukhan","Al-Jasiyah","Al-Ahqaf","Muhammad","Al-Fath","Al-Hujurat","Qaf","Az-Zariyat","At-Tur",
    "An-Najm","Al-Qamar","Ar-Rahman","Al-Waqi'ah","Al-Hadid","Al-Mujadalah","Al-Hasyr","Al-Mumtahanah","As-Saff",
    "Al-Jumu'ah","Al-Munafiqun","At-Tagabun","At-Talaq","At-Tahrim","Al-Mulk","Al-Qalam","Al-Haqqah","Al-Ma'arij",
    "Nuh","Al-Jinn","Al-Muzzammil","Al-Muddatsir","Al-Qiyamah","Al-Insan","Al-Mursalat","An-Naba'","An-Nazi'at",
    "'Abasa","At-Takwir","Al-Infitar","Al-Mutaffifin","Al-Insyiqaq","Al-Buruj","At-Tariq","Al-A'la","Al-Gasyiyah",
    "Al-Fajr","Al-Balad","Asy-Syams","Al-Lail","Ad-Duha","Asy-Syarh","At-Tin","Al-'Alaq","Al-Qadr","Al-Bayyinah",
    "Az-Zalzalah","Al-'Adiyat","Al-Qari'ah","At-Takasur","Al-'Asr","Al-Humazah","Al-Fil","Quraisy","Al-Ma'un",
    "Al-Kausar","Al-Kafirun","An-Nasr","Al-Lahab","Al-Ikhlas","Al-Falaq","An-Nas"
  ];
  function PDF_surahName(n){
    const i = Number(n);
    if (!Number.isFinite(i) || i<1 || i>114) return `Surah ${n}`;
    return QURAN_SURAH_NAMES[i] || `Surah ${n}`;
  }
  function PDF_fmtSASegmentNama(seg){
    const from = seg?.from, to = seg?.to;
    if (!from || !to) return '';
    const fName = PDF_surahName(from.s), tName = PDF_surahName(to.s);
    return `${fName}: ${from.a} s.d. ${tName}: ${to.a}`;
  }
  function PDF_joinSAsegmentsNama(arr){
    const list = PDF_sortSASegments(PDF_dedupSASegments(arr));
    if (!list.length) return '-';
    return list.map(PDF_fmtSASegmentNama).join(', ');
  }

  // === Pewarnaan sel SP ===
  function PDF_spPaintCell(doc, x, y, w, h, spValue){
    const v = String(spValue||'').toUpperCase().replace(/\s+/g,''); // SP1 / SP 1 -> SP1
    if (v === 'SP1'){            // kuning terang
      doc.setFillColor(255,241,118); // #FFF176
      doc.rect(x, y, w, h, 'F');
      return null;               // text warna normal
    }
    if (v === 'SP2'){            // merah terang
      doc.setFillColor(255,205,210); // #FFCDD2
      doc.rect(x, y, w, h, 'F');
      return null;
    }
    if (v === 'SP3'){            // hitam, text putih
      doc.setFillColor(0,0,0);
      doc.rect(x, y, w, h, 'F');
      return [255,255,255];      // override text -> putih
    }
    return null;
  }

  // ================= PDF Rekap Kelas =================
  async function pdfRekapDownload(){
    setBtnLoading(pdfBtn, true, 'Membuat PDF‚Ä¶');
    try {
      const { kelas, startDate, endDate, kelasLine, kbmDays, rows } = await collectRekapData();

      const { jsPDF } = window.jspdf || {};
      if (!jsPDF) { alert('jsPDF belum dimuat. Tambahkan <script> jsPDF.'); return; }
      const doc = new jsPDF({ orientation: 'l', unit: 'mm', format: 'a3' });

      // === Tema
      const theme = {
        cardBorder: [229,231,235],
        headerText: [15,23,42],
        tableHeadFill: [30,136,229],
        zebraFill: [248,250,252],
        border: [229,231,235],
        text: [31,41,55],
        statusFill: { tuntas: [220,252,231], khatam: [237,233,254] }
      };

      const pageW  = doc.internal.pageSize.getWidth();
      const pageH  = doc.internal.pageSize.getHeight();
      const margin = { left: 12, right: 12, top: 12, bottom: 12 };

      const headerGap = 30;
      const fontBody = 8.5;
      const fontHead = fontBody + 1;
      const lineFactor = 1.18;
      const lineH = fontBody * 0.3528 * lineFactor;
      const cellPadX = 1.6;
      const cellPadY = 1.2;
      const headerRowH = Math.max(9, fontHead * 0.3528 * lineFactor + 2*cellPadY);

      function drawHeaderBar(){
        doc.setDrawColor(...theme.cardBorder);
        doc.roundedRect(margin.left-3, margin.top-6, pageW - margin.left - margin.right + 6, 22, 3, 3);
        doc.setTextColor(...theme.headerText);
        doc.setFont('helvetica','bold'); doc.setFontSize(14);
        doc.text('Rekap Absensi & Setoran', margin.left, margin.top);
        doc.setFont('helvetica','normal'); doc.setFontSize(10);
        doc.text(kelasLine, margin.left, margin.top + 6);
        doc.text(`Periode: ${fmtD_M_YYYY(startDate)} s.d. ${fmtD_M_YYYY(endDate)}`, margin.left, margin.top + 12);
        const rightX = pageW - margin.right - 70;
        doc.text(`KBM: ${kbmDays} hari`, rightX, margin.top + 6);
        doc.text(`Total Santri: ${rows.length}`, rightX, margin.top + 12);
        doc.setTextColor(...theme.text);
      }
      function drawFooter(pageNo, totalPages, printedAt){
        const y = pageH - 6;
        doc.setDrawColor(...theme.border); doc.setLineWidth(0.2);
        doc.line(margin.left-2, y-3, pageW-margin.right+2, y-3);
        doc.setFontSize(8);
        doc.text(`Dicetak: ${printedAt}`, margin.left, y);
        doc.text(`Halaman ${pageNo} / ${totalPages}`, pageW - margin.right - 30, y);
      }

      const cols = [
        { key:'no',       title:'No.',  w:11, minW:11, maxW:12, align:'center' },
        { key:'nis',      title:'NIS',  w:24, minW:18, maxW:34, align:'left'   },
        { key:'nama',     title:'Nama', w:46, minW:36, maxW:80, align:'left'   },
        { key:'sem',      title:'SM',   w:12, minW:12, maxW:12, align:'center' }, // dipersempit
        { key:'jenjang',  title:'KLS',  w:14, minW:14, maxW:14, align:'center' }, // dipersempit
        { key:'h',        title:'H',    w:8,  minW:6,  maxW:10, align:'center' },
        { key:'a',        title:'A',    w:8,  minW:6,  maxW:10, align:'center' },
        { key:'s',        title:'S',    w:8,  minW:6,  maxW:10, align:'center' },
        { key:'i',        title:'I',    w:8,  minW:6,  maxW:10, align:'center' },
        { key:'hadirPct', title:'Hadir %', w:16, minW:16, maxW:18, align:'center' },
		{ key:'ket',      title:'SP',   w:12, minW:12, maxW:12, align:'center' }, // kolom baru
        { key:'setoran',  title:'Setoran',  w:48, minW:32, maxW:120, align:'left'  },
        { key:'juz',      title:'Juz',      w:18, minW:18, maxW:18, align:'left'   },
        { key:'totJuz',   title:'Total juz',    w:14, minW:14, maxW:22, align:'right'  },
		{ key:'murRange', title:'Murajaah', w:20, minW:18, maxW:26, align:'right' },
        { key:'persen',   title:'THMS',     w:17, minW:17, maxW:18, align:'center' }, // ganti label
        { key:'nilai',    title:'Nilai',    w:14, minW:14, maxW:20, align:'right'  },
        { key:'pred',     title:'Predikat', w:18, minW:18, maxW:18, align:'center' },
      ];
      const contentW = pageW - margin.left - margin.right;

      const tableData = rows.map((r, idx) => {
        const nilaiAvg  = r.nilaiCount ? (r.nilaiSum / r.nilaiCount) : 0;
        const pred      = PDF_predikatFromScore(nilaiAvg);
        const statusJuz = PDF_totalAllJuzStatus(r.totalJuz, r.semester);
        const setoranText = PDF_joinSAsegmentsNama(r.saSegments);
        const juzText     = PDF_joinRangeSegments(r.juzSegments, true);
        const personalDays = Number(r.daysCount || 0);
        const hadirDays    = Number(r.hadirDays || 0);
        const hadirPct     = personalDays > 0 ? Math.round((hadirDays / personalDays) * 100) : 0;

        return {
          no: String(idx+1),
          nis: r.nis || r.id || '-',
          nama: r.nama || '-',
          sem: r.semester ?? '-',
          jenjang: jenjangLabel(r.jenjang ?? ''),
          ket: r.keterangan ?? '-',                 // SP
          h: r.hadir, a: r.alpha, s: r.sakit, i: r.izin,
          hadirPct: `${hadirPct}%`,
          setoran: setoranText,
          juz: juzText,
          totJuz: r.totalJuz.toFixed(2),
		  murRange: fmtMurRange(r.murTotalJuz || 0, r.murCount || 0),
          persen: statusJuz.label,
          nilai: nilaiAvg ? nilaiAvg.toFixed(1) : '-',
          pred: pred.huruf
        };
      });

      fitColumnsFlex(doc, cols, tableData, fontBody, contentW, cellPadX);

      function drawTableHeader(doc, cols, x, y, rowH, fontSize, theme, padX){
        const totalW = sumWidth(cols);
        doc.setFillColor(...theme.tableHeadFill);
        doc.setDrawColor(...theme.border);
        doc.rect(x, y, totalW, rowH, 'FD');
        doc.setFont('helvetica','bold');
        doc.setFontSize(fontSize);
        doc.setTextColor(255,255,255);
        let cx = x;
        const lh = fontSize * 0.3528 * 1.18;
        for (const col of cols){
          const lines = doc.splitTextToSize(String(col.title||''), Math.max(1, col.w - 2*padX));
          const textH = lines.length * lh;
          const yy = y + (rowH - textH)/2 + lh*0.82;
          const tx = (col.align==='right') ? (cx + col.w - padX)
                   : (col.align==='center') ? (cx + col.w/2)
                   : (cx + padX);
          const opt = (col.align==='right') ? {align:'right'} : (col.align==='center') ? {align:'center'} : {};
          for (let i=0;i<lines.length;i++) doc.text(String(lines[i]), tx, yy + i*lh, opt);
          doc.rect(cx, y, col.w, rowH);
          cx += col.w;
        }
        doc.setTextColor(31,41,55);
        doc.setFont('helvetica','normal');
      }

      // Render tabel + footer
      drawHeaderBar();
      let x0 = margin.left;
      let y  = margin.top + headerGap;

      drawTableHeader(doc, cols, x0, y, headerRowH, fontHead, theme, cellPadX);
      y += headerRowH;

      let rowIndex = 0;
      doc.setLineWidth(0.2);

      for (const row of tableData) {
        const wraps = cols.map(col =>
          doc.splitTextToSize(String(row[col.key] ?? ''), Math.max(1, col.w - 2*cellPadX))
        );
        const rowTextHeights = wraps.map(lines => lines.length * lineH);
        const rowH = Math.max(lineH + 2*cellPadY, Math.max(...rowTextHeights) + 2*cellPadY);

        if (y + rowH > pageH - margin.bottom) {
          doc.addPage('a3', 'landscape');
          drawHeaderBar();
          y = margin.top + headerGap;
          drawTableHeader(doc, cols, x0, y, headerRowH, fontHead, theme, cellPadX);
          y += headerRowH;
          rowIndex = 0;
        }

        if (rowIndex % 2 === 1) {
          doc.setFillColor(...theme.zebraFill);
          doc.rect(x0, y, sumWidth(cols), rowH, 'F');
        }

        let x = x0;
        doc.setFont('helvetica','normal');
        doc.setFontSize(fontBody);
        doc.setTextColor(...theme.text);
        doc.setDrawColor(...theme.border);

        for (let ci=0; ci<cols.length; ci++){
          const col = cols[ci];
          const lines = wraps[ci];

          // highlight status THMS (TUNTAS/KHATAM)
          if (col.key === 'persen') {
            const val = String(row[col.key] || '').toUpperCase();
            if (val === 'TUNTAS' || val === 'KHATAM') {
              const fill = (val === 'TUNTAS') ? theme.statusFill.tuntas : theme.statusFill.khatam;
              doc.setFillColor(...fill);
              doc.rect(x, y, col.w, rowH, 'F');
            }
          }

          // >>> pewarnaan khusus kolom SP
          let spTextColor = null;
          if (col.key === 'ket') {
            spTextColor = PDF_spPaintCell(doc, x, y, col.w, rowH, row.ket);
            if (spTextColor) doc.setTextColor(...spTextColor);
          }

          const textBlockH = lines.length * lineH;
          let yy = y + (rowH - textBlockH)/2 + lineH*0.82;
          let tx, opt = {};
          if (col.align === 'right') { tx = x + col.w - cellPadX; opt = { align:'right' }; }
          else if (col.align === 'center') { tx = x + col.w/2; opt = { align:'center' }; }
          else { tx = x + cellPadX; }
          for (let li=0; li<lines.length; li++){
            doc.text(String(lines[li]), tx, yy, opt);
            yy += lineH;
          }

          doc.rect(x, y, col.w, rowH);
          if (spTextColor) doc.setTextColor(...theme.text); // reset bila sempat di-override
          x += col.w;
        }
        y += rowH;
        rowIndex++;
      }

      // Tanda tangan + footer
      function fmtDDMMYYYY(iso){
        if (!iso) return null;
        const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (!m) return null;
        return `${m[3]}-${m[2]}-${m[1]}`;
      }
      const printedAt = new Date();
      const printedISO = printedAt.toISOString().slice(0,10);
      const ttdDate = fmtDDMMYYYY(endDate) || fmtDDMMYYYY(printedISO) || printedAt.toLocaleDateString('id-ID');

      const spaceTop = 10, neededH = 36;
      if (y + spaceTop + neededH > pageH - margin.bottom){
        doc.addPage('a3', 'landscape');
        drawHeaderBar();
        y = margin.top + headerGap;
      }
      y += spaceTop;

      const totalW = sumWidth(cols);
      const colGap = 8;
      const colW   = (totalW - colGap) / 2;
      const leftX  = margin.left;
      const rightX = margin.left + colW + colGap;

      doc.setFont('helvetica','normal'); doc.setFontSize(11);
      doc.text(`Mataram, ${ttdDate}`, margin.left + totalW, y, { align:'right' });

      const headY = y + 8;
      doc.text('Mengetahui,', leftX, headY);
      doc.text('Musyrif Tahfizh,', rightX, headY);

      const lineY = headY + 24;
      doc.setDrawColor(...theme.border);
      doc.line(leftX,  lineY, leftX  + colW - 10, lineY);
      doc.line(rightX, lineY, rightX + colW - 10, lineY);

      const totalPages = doc.internal.getNumberOfPages();
      for (let p = 1; p <= totalPages; p++) { doc.setPage(p); drawFooter(p, totalPages, printedAt.toLocaleString()); }

      const fileName = `Rekap_${kelas || 'kelas'}_${startDate}_sd_${endDate}.pdf`;
      doc.save(fileName);

    } catch (err) {
      console.error(err);
      alert('Gagal mengunduh PDF: ' + (err.message || err));
    } finally {
      setBtnLoading(pdfBtn, false);
    }
  }


// ===== Helper: ambil semua key kelas =====
function _getAllKelasKeys(){
  // Prioritas: global window.ALL_KELAS_KEYS jika disediakan
  if (Array.isArray(window.ALL_KELAS_KEYS) && window.ALL_KELAS_KEYS.length){
    return [...new Set(window.ALL_KELAS_KEYS.map(String))].sort((a,b)=>{
      const na = +(String(a).match(/(\d+)/)?.[1]||1e9);
      const nb = +(String(b).match(/(\d+)/)?.[1]||1e9);
      return na-nb || String(a).localeCompare(String(b),'id');
    });
  }

  // Fallback: opsi <select id="kelasSelect">
  const el = (typeof kelasSelect !== 'undefined' && kelasSelect) ? kelasSelect : document.getElementById('kelasSelect');
  const vals = el ? [...el.options].map(o=>o.value).filter(Boolean) : [];
  let keys = vals.length ? [...new Set(vals)] : [];

  // Fallback lagi: dari NAMA_KELAS_CUSTOM/windows.namaKelasCustom
  if (!keys.length){
    const custom = window.namaKelasCustom || window.NAMA_KELAS_CUSTOM || {};
    keys = Object.keys(custom||{});
  }

  // Urutkan berdasar angka kelas
  keys.sort((a,b)=>{
    const na = +(String(a).match(/(\d+)/)?.[1]||1e9);
    const nb = +(String(b).match(/(\d+)/)?.[1]||1e9);
    return na-nb || String(a).localeCompare(String(b),'id');
  });
  return keys;
}

// ===== Helper: line "Kelas: X, Kelompok: Y" untuk kelas tertentu (tanpa perlu selected) =====
function _kelasKelompokLineFor(kelasKey){
  const kelasNum = (String(kelasKey||'').match(/(\d+)/)?.[1]) || (kelasKey || '-');
  const el = (typeof kelasSelect !== 'undefined' && kelasSelect) ? kelasSelect : document.getElementById('kelasSelect');
  const custom = window.namaKelasCustom || window.NAMA_KELAS_CUSTOM || {};
  let kelompok = custom[kelasKey] || "";

  if (!kelompok && el){
    const opt = [...el.options].find(o => o.value === kelasKey);
    const optText = opt?.text?.trim() || "";
    if (optText){
      const fromOpt = (optText.match(/Kelompok\s+(.+)/i)?.[1] || optText).trim();
      kelompok = fromOpt;
    }
  }
  kelompok = (kelompok || '').replace(/^Kelompok\s+/i, '').trim() || '-';
  return { kelasNum, kelompok, line: `Halaqoh: ${kelasNum}, ${kelompok}` };
}

// ====== Ambil & Agregasi Data utk 1 kelas spesifik ======
async function collectRekapDataForClass(kelasKey, startDate, endDate){
  const { line: kelasLine } = _kelasKelompokLineFor(kelasKey);

  // 1) ABSENSI
  const absUrl = `/api/getAbsensiRange?kelas=${encodeURIComponent(kelasKey)}&start=${encodeURIComponent(startDate)}&end=${encodeURIComponent(endDate)}&t=${Date.now()}`;
  const resAbs = await fetch(absUrl);
  if (!resAbs.ok) throw new Error('Gagal mengambil data absensi.');
  let allData = await resAbs.json();
  if (!Array.isArray(allData) || allData.length === 0) return null; // SKIP kelas tanpa data

  // 2) ROSTER
  const resSantri = await fetch(`/api/getSantri?kelas=${encodeURIComponent(kelasKey)}&t=${Date.now()}`);
  const santriData = await resSantri.json().catch(()=>[]) || [];

  // helper index (local copy)
  const keyId   = v => (v === 0 || v) ? String(v).trim() : "";
  const keyNis  = v => (v === 0 || v) ? String(v).trim() : "";
  const keyName = v => String(v || "").trim().toLowerCase();
  const byIdMap = (arr, pick = x => x) => { const m = new Map(); for (const a of arr||[]) { const id = keyId(a?.id); if (id) m.set(id, pick(a)); } return m; };
  const byNisMap = (arr, pick = x => x) => { const m = new Map(); for (const a of arr||[]) { const nis = keyNis(a?.nis); if (nis) m.set(nis, pick(a)); } return m; };
  const byNameMap = (arr, pick = x => x) => { const m = new Map(); for (const a of arr||[]) { const nm = keyName(a?.nama); if (nm && !m.has(nm)) m.set(nm, pick(a)); } return m; };
  const rosterById   = byIdMap(santriData, s => s);
  const rosterByNis  = byNisMap(santriData, s => s);
  const rosterByName = byNameMap(santriData, s => s);

  // 3) Normalisasi (+ inject semester, jenjang, keterangan)
  const allDataNorm = allData.map(r => {
    let id   = keyId(r?.id ?? "");
    let nis  = keyNis(r?.nis ?? "");
    const nmK = keyName(r?.nama);
    if (!nis && id && rosterById.get(id)?.nis) nis = keyNis(rosterById.get(id).nis);
    if (!nis && nmK && rosterByName.get(nmK)?.nis) nis = keyNis(rosterByName.get(nmK).nis);

    let nama = r?.nama;
    if (!nama && nis && rosterByNis.get(nis)?.nama) nama = rosterByNis.get(nis).nama;
    if (!nama && id  && rosterById.get(id)?.nama)  nama = rosterById.get(id).nama;
    if (!id && nis && rosterByNis.get(nis)?.id) id = keyId(rosterByNis.get(nis).id);

    let semester = (r?.semester != null) ? Number(r.semester) : null;
    if (semester == null) {
      if (nis && rosterByNis.get(nis)?.semester != null) semester = Number(rosterByNis.get(nis).semester);
      else if (id && rosterById.get(id)?.semester != null) semester = Number(rosterById.get(id).semester);
    }

    let jenjang = r?.jenjang ?? null;
    if (!jenjang && nis && rosterByNis.get(nis)?.jenjang) jenjang = rosterByNis.get(nis).jenjang;
    if (!jenjang && id  && rosterById.get(id)?.jenjang)  jenjang = rosterById.get(id).jenjang;

    let keterangan = r?.keterangan ?? null;
    if (!keterangan && nis && rosterByNis.get(nis)?.keterangan) keterangan = rosterByNis.get(nis).keterangan;
    if (!keterangan && id  && rosterById.get(id)?.keterangan)  keterangan = rosterById.get(id).keterangan;

    return { ...r, id, nis, nama, semester, jenjang, keterangan, tanggal: r?.tanggal ? String(r.tanggal).slice(0,10) : null };
  });

  // KBM hari unik
  const kbmDaySet = new Set();
  (allDataNorm||[]).forEach(it => { if (it?.tanggal) kbmDaySet.add(String(it.tanggal)); });
  const kbmDays = kbmDaySet.size;

  // Agregasi
  const aggMap = PDF_buildRekapPerKey(allDataNorm);
  const allRows = Object.values(aggMap).sort((a,b)=> (a.nama||a.nis||a.id).localeCompare(b.nama||b.nis||b.id,'id'));
  const rows = allRows.filter(r => (typeof r.nis === 'string' ? r.nis.trim() !== '' : !!r.nis));
  if (!rows.length) return null;

  // Ringkasan total (opsional)
  let totJuz=0, totH=0, totA=0, totS=0, totI=0, totPages=0;
  rows.forEach(r=>{ totJuz += r.totalJuz; totH += r.hadir; totA += r.alpha; totS += r.sakit; totI += r.izin; totPages += r.totalPageSum; });

  return { kelas: kelasKey, startDate, endDate, kelasLine, kbmDays, rows,
    totals: { totJuz, totH, totA, totS, totI, totPages }
  };
}

// ===== PDF ALL KELAS =====
async function pdfAllKelasDownload(){
  const btn = document.getElementById('download-pdf-allkelas');
  setBtnLoading(btn, true, 'Membuat PDF‚Ä¶');
  try {
    const startDate = document.querySelector('#pdf-start-date')?.value;
    const endDate   = document.querySelector('#pdf-end-date')?.value;
    if (!startDate || !endDate) throw new Error('Mohon pilih tanggal mulai & akhir.');

    const kelasKeys = _getAllKelasKeys();
    if (!kelasKeys.length) throw new Error('Tidak menemukan daftar kelas.');

    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) { alert('jsPDF belum dimuat. Tambahkan <script> jsPDF.'); return; }

    const doc = new jsPDF({ orientation: 'l', unit: 'mm', format: 'a3' });

    // Tema konsisten
    const theme = {
      cardBorder: [229,231,235],
      headerText: [15,23,42],
      tableHeadFill: [30,136,229],
      zebraFill: [248,250,252],
      border: [229,231,235],
      text: [31,41,55],
      statusFill: { tuntas: [220,252,231], khatam: [237,233,254] }
    };

    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const margin = { left: 12, right: 12, top: 12, bottom: 12 };
    const fontBody = 8.5, fontHead = fontBody + 1;
    const lineFactor = 1.18;
    const lineH = fontBody * 0.3528 * lineFactor;
    const cellPadX = 1.6, cellPadY = 1.2;
    const headerRowH = Math.max(9, fontHead * 0.3528 * lineFactor + 2*cellPadY);

    // ===== Spasi & tinggi untuk header 'nempel' + keep-with-next
    const CLASS_HEADER_FONT = 10;                                   // pt
    const CLASS_HEADER_LINE_H = CLASS_HEADER_FONT * 0.3528 * 1.10;  // ‚âà 3.9 mm
    const HEADER_TO_TABLE_GAP = 0.8;                                 // mm (nempel tapi tidak mepet)
    const BETWEEN_CLASSES_GAP = 5.0;                                 // mm (jarak antar tabel kelas)
    const ROW_MIN_H = (fontBody * 0.3528 * 1.18) + 2*cellPadY;       // tinggi minimal 1 baris data

    // Judul utama (sekali) + Periode (sekali)
    function drawMainTitle(){
      doc.setTextColor(...theme.headerText);
      doc.setFont('helvetica','bold'); doc.setFontSize(14);
      doc.text('Rekap Absensi & Setoran', margin.left, margin.top);
      doc.setFont('helvetica','normal'); doc.setFontSize(9.5);
      doc.text(`Periode: ${fmtD_M_YYYY(startDate)} s.d. ${fmtD_M_YYYY(endDate)}`, margin.left, margin.top + 6);
      doc.setTextColor(...theme.text);
    }

    // Footer kecil per halaman
    function drawFooter(pageNo, totalPages, printedAt){
      const y = pageH - 6;
      doc.setDrawColor(...theme.border); doc.setLineWidth(0.2);
      doc.line(margin.left-2, y-3, pageW-margin.right+2, y-3);
      doc.setFontSize(8);
      doc.text(`Dicetak: ${printedAt}`, margin.left, y);
      doc.text(`Halaman ${pageNo} / ${totalPages}`, pageW - margin.right - 30, y);
    }

    // Header kecil per kelas ‚Äî 1 baris ringkas TANPA "Periode"
    function drawClassHeaderCompact(kelasLine, kbmDays, totalSantri, yStart){
      const headerText = `${kelasLine}, KBM: ${kbmDays} hari, Total Santri: ${totalSantri}`;
      doc.setFont('helvetica','bold'); doc.setFontSize(CLASS_HEADER_FONT);
      // Baseline disetel agar jarak ke tabel rapat & konsisten
      const baseline = yStart + CLASS_HEADER_LINE_H * 0.72;
      doc.text(headerText, margin.left, baseline);
      return CLASS_HEADER_LINE_H; // tinggi yang "dipakai"
    }

    // Cek ruang supaya header kelas tidak "gantung" (keep-with-next)
    function ensureSpaceForClassBlock(yCurrent){
      const need = CLASS_HEADER_LINE_H + HEADER_TO_TABLE_GAP + headerRowH + ROW_MIN_H;
      if (yCurrent + need > pageH - margin.bottom){
        doc.addPage('a3','landscape');
        return margin.top + 6; // halaman baru, tanpa judul utama
      }
      return yCurrent;
    }

    // Kolom konsisten (SM/KLS/SP sempit & THMS)
    const baseCols = [
      { key:'no',       title:'No.',  w:11, minW:11, maxW:12, align:'center' },
      { key:'nis',      title:'NIS',  w:24, minW:18, maxW:34, align:'left'   },
      { key:'nama',     title:'Nama', w:46, minW:36, maxW:80, align:'left'   },
      { key:'sem',      title:'SM',   w:12, minW:12, maxW:12, align:'center' },
      { key:'jenjang',  title:'KLS',  w:14, minW:14, maxW:14, align:'center' },
      { key:'h',        title:'H',    w:8,  minW:6,  maxW:10, align:'center' },
      { key:'a',        title:'A',    w:8,  minW:6,  maxW:10, align:'center' },
      { key:'s',        title:'S',    w:8,  minW:6,  maxW:10, align:'center' },
      { key:'i',        title:'I',    w:8,  minW:6,  maxW:10, align:'center' },
      { key:'hadirPct', title:'Hadir %', w:16, minW:16, maxW:18, align:'center' },
	  { key:'ket',      title:'SP',   w:12, minW:12, maxW:12, align:'center' },
      { key:'setoran',  title:'Setoran',  w:48, minW:32, maxW:120, align:'left'  },
      { key:'juz',      title:'Juz',      w:18, minW:18, maxW:18, align:'left'   },
      { key:'totJuz',   title:'Total juz',    w:14, minW:14, maxW:22, align:'right'  },
	  { key:'murRange',  title:'Murajaah', w:20, minW:18, maxW:26, align:'right' },
      { key:'persen',   title:'THMS',     w:17, minW:17, maxW:18, align:'center' },
      { key:'nilai',    title:'Nilai',    w:14, minW:14, maxW:20, align:'right'  },
      { key:'pred',     title:'Predikat', w:18, minW:18, maxW:18, align:'center' },
    ];

    const contentW = pageW - margin.left - margin.right;
    let y = margin.top + 12; // (judul + periode) lalu enter
    drawMainTitle();

    const printedAt = new Date().toLocaleString();

    // Loop semua kelas (serial agar stabil & hemat memori)
    for (const kelasKey of kelasKeys){
      let data = null;
      try {
        data = await collectRekapDataForClass(kelasKey, startDate, endDate);
      } catch (e) {
        console.warn('Gagal kelas', kelasKey, e);
        continue;
      }
      if (!data) continue; // skip jika kosong

      const { kelasLine, kbmDays, rows } = data;

      const tableData = rows.map((r, idx) => {
        const nilaiAvg  = r.nilaiCount ? (r.nilaiSum / r.nilaiCount) : 0;
        const pred      = PDF_predikatFromScore(nilaiAvg);
        const statusJuz = PDF_totalAllJuzStatus(r.totalJuz, r.semester);
        const setoranText = PDF_joinSAsegmentsNama(r.saSegments);
        const juzText     = PDF_joinRangeSegments(r.juzSegments, true);
        const personalDays = Number(r.daysCount || 0);
        const hadirDays    = Number(r.hadirDays || 0);
        const hadirPct     = personalDays > 0 ? Math.round((hadirDays / personalDays) * 100) : 0;

        return {
          no: String(idx+1),
          nis: r.nis || r.id || '-',
          nama: r.nama || '-',
          sem: r.semester ?? '-',
          jenjang: jenjangLabel(r.jenjang ?? ''),
          ket: r.keterangan ?? '-',
          h: r.hadir, a: r.alpha, s: r.sakit, i: r.izin,
          hadirPct: `${hadirPct}%`,
          setoran: setoranText,
          juz: juzText,
          totJuz: r.totalJuz.toFixed(2),
		  murRange: fmtMurRange(r.murTotalJuz || 0, r.murCount || 0),
          persen: statusJuz.label,
          nilai: nilaiAvg ? nilaiAvg.toFixed(1) : '-',
          pred: pred.huruf
        };
      });

      // Clone kolom agar leluasa adjust per kelas
      const cols = JSON.parse(JSON.stringify(baseCols));
      fitColumnsFlex(doc, cols, tableData, fontBody, contentW, cellPadX);

      // ===== PRE-FLIGHT: jangan biarkan header kelas 'gantung'
      y = ensureSpaceForClassBlock(y);

      // Header kelas (rapat ke tabel)
      y += drawClassHeaderCompact(kelasLine, kbmDays, rows.length, y);
      y += HEADER_TO_TABLE_GAP;

      // Header tabel
      drawTableHeader(doc, cols, margin.left, y, headerRowH, fontHead, theme, cellPadX);
      y += headerRowH;

      // Isi tabel
      let rowIndex = 0;
      doc.setLineWidth(0.2);

      for (const row of tableData) {
        const wraps = cols.map(col =>
          doc.splitTextToSize(String(row[col.key] ?? ''), Math.max(1, col.w - 2*cellPadX))
        );
        const rowTextHeights = wraps.map(lines => lines.length * lineH);
        const rowH = Math.max(lineH + 2*cellPadY, Math.max(...rowTextHeights) + 2*cellPadY);

        // Page break jika tidak muat
        if (y + rowH > pageH - margin.bottom) {
          doc.addPage('a3', 'landscape');
          y = margin.top + 6;

          // Ulangi header kelas agar konteks tetap menempel ke tabel
          y += drawClassHeaderCompact(kelasLine, kbmDays, rows.length, y);
          y += HEADER_TO_TABLE_GAP;

          drawTableHeader(doc, cols, margin.left, y, headerRowH, fontHead, theme, cellPadX);
          y += headerRowH;
          rowIndex = 0;
        }

        // Zebra
        if (rowIndex % 2 === 1) {
          doc.setFillColor(...theme.zebraFill);
          doc.rect(margin.left, y, sumWidth(cols), rowH, 'F');
        }

        let x = margin.left;
        doc.setFont('helvetica','normal');
        doc.setFontSize(fontBody);
        doc.setTextColor(...theme.text);
        doc.setDrawColor(...theme.border);

        for (let ci=0; ci<cols.length; ci++){
          const col = cols[ci];
          const lines = wraps[ci];

          // Highlight THMS tuntas/khatam
          if (col.key === 'persen') {
            const val = String(row[col.key] || '').toUpperCase();
            if (val === 'TUNTAS' || val === 'KHATAM') {
              const fill = (val === 'TUNTAS') ? theme.statusFill.tuntas : theme.statusFill.khatam;
              doc.setFillColor(...fill);
              doc.rect(x, y, col.w, rowH, 'F');
            }
          }

          // Pewarnaan kolom SP
          let spTextColor = null;
          if (col.key === 'ket') {
            spTextColor = PDF_spPaintCell(doc, x, y, col.w, rowH, row.ket);
            if (spTextColor) doc.setTextColor(...spTextColor);
          }

          const textBlockH = lines.length * lineH;
          let yy = y + (rowH - textBlockH)/2 + lineH*0.82;
          let tx, opt = {};
          if (col.align === 'right') { tx = x + col.w - cellPadX; opt = { align:'right' }; }
          else if (col.align === 'center') { tx = x + col.w/2; opt = { align:'center' }; }
          else { tx = x + cellPadX; }
          for (let li=0; li<lines.length; li++){
            doc.text(String(lines[li]), tx, yy, opt);
            yy += lineH;
          }

          doc.rect(x, y, col.w, rowH);
          if (spTextColor) doc.setTextColor(...theme.text);
          x += col.w;
        }

        y += rowH;
        rowIndex++;
      }

      // Jarak setelah tabel kelas selesai
      y += BETWEEN_CLASSES_GAP;
    }

    // ===== Tanda tangan sekali di paling bawah =====
    const printed = new Date();
    const printedISO = printed.toISOString().slice(0,10);
    const m = String(endDate||'').match(/^(\d{4})-(\d{2})-(\d{2})$/);
    const ttdDate = m ? `${m[3]}-${m[2]}-${m[1]}` : (String(printedISO).match(/^(\d{4})-(\d{2})-(\d{2})$/) ? String(printedISO).replace(/^(\d{4})-(\d{2})-(\d{2})$/, '$3-$2-$1') : printed.toLocaleDateString('id-ID'));

    const signNeededH = 36, spaceTop = 6;
    if (y + spaceTop + signNeededH > pageH - margin.bottom){
      doc.addPage('a3', 'landscape');
      y = margin.top + 6;
    }
    y += spaceTop;

    const totalW = pageW - margin.left - margin.right;
    const colGap = 8;
    const colW   = (totalW - colGap) / 2;
    const leftX  = margin.left;
    const rightX = margin.left + colW + colGap;

    doc.setFont('helvetica','normal'); doc.setFontSize(11);
    doc.text(`Jakarta, ${ttdDate}`, margin.left + totalW, y, { align:'right' });

    const headY = y + 8;
    doc.text('Mengetahui,', leftX, headY);
    doc.text('Musyrif Tahfizh,', rightX, headY);

    const lineY = headY + 24;
    doc.setDrawColor(...theme.border);
    doc.line(leftX,  lineY, leftX  + colW - 10, lineY);
    doc.line(rightX, lineY, rightX + colW - 10, lineY);

    // Footer per halaman
    const totalPages = doc.internal.getNumberOfPages();
    for (let p = 1; p <= totalPages; p++) { doc.setPage(p); drawFooter(p, totalPages, printedAt); }

    const fileName = `Rekap_AllKelas_${startDate}_sd_${endDate}.pdf`;
    doc.save(fileName);
  } catch (err) {
    console.error(err);
    alert('Gagal mengunduh PDF All Kelas: ' + (err.message || err));
  } finally {
    setBtnLoading(btn, false);
  }
}
	
  // ============== PDF per Santri ==============
  async function pdfSantriDownload(){
    const triggerBtn = document.getElementById('okSantriSelect') || pdfSantriBtn;
    setBtnLoading(triggerBtn, true, 'Membuat PDF‚Ä¶');
    try {
      const sel = santriSelect;
      if (!sel || !sel.value) {
        await populateSantriSelect();
        alert('Silakan pilih santri terlebih dahulu.');
        throw new Error('Santri belum dipilih');
      }
      const key = sel.value;
      const selectedNama = sel.options[sel.selectedIndex]?.dataset?.nama || '';

      const { kelas, startDate, endDate, kelasLine, rows: aggRows, allDataNorm } = await collectRekapData();

      const mine = allDataNorm.filter(it => (String(it.nis||it.id||'') === key));
      if (!mine.length) throw new Error('Tidak ada data untuk santri terpilih pada rentang tanggal.');

      const namaSantri = selectedNama || (mine.find(it => it.nama)?.nama) || '-';
      const semesterSantri = (mine.find(it => it.semester!=null)?.semester) ?? null;
      const jenjangSantri  = (aggRows.find(r => r.nis === key || (!r.nis && r.id === key))?.jenjang)
                          ?? (mine.find(it => it.jenjang!=null)?.jenjang)
                          ?? '-';
	  const jenjangSantriLabel = jenjangLabel(jenjangSantri);

      const keteranganSantri = (aggRows.find(r => r.nis === key || (!r.nis && r.id === key))?.keterangan)
                          ?? (mine.find(it => it.keterangan!=null)?.keterangan)
                          ?? '-';

      const byDate = new Map();
      for (const it of mine) {
        const tgl = it.tanggal || '-';
        if (!byDate.has(tgl)) {
          byDate.set(tgl, {
  		tanggal: tgl,
  		cnt: { hadir:0, alpha:0, sakit:0, izin:0, lainnya:0 },
  		sa: [], pages: [], juz: [],
  		totalPage: 0, totalJuz: 0,
  		murJuz: 0,                 // << baru
  		nilaiSum: 0, nilaiCount: 0
		});
        }
        const d = byDate.get(tgl);

        const st = PDF_normStatus(it?.absensi ?? it?.status);
        if (d.cnt[st] != null) d.cnt[st]++; else d.cnt.lainnya++;

        const dari = PDF_parseSA(it?.dari || it?.dariSetoran);
        const smp  = PDF_parseSA(it?.sampai || it?.sampaiSetoran);
        if (dari && smp) d.sa.push((PDF_compareSA(dari, smp) <= 0) ? {from:dari, to:smp} : {from:smp, to:dari});

        const rng = PDF_parseRange(it?.halaman || it?.page);
        const tp  = PDF_num2(it?.totalHalaman ?? it?.totalPage);
        if (tp!=null) d.totalPage += tp; else if (rng) d.totalPage += Math.max(0, rng[1]-rng[0]+1);
        if (rng) { let [a,b] = rng; if (a>b) [a,b]=[b,a]; d.pages.push([a,b]); }

        const vJ = PDF_num2(it?.totalJuz ?? it?.juz);
        if (vJ!=null) d.totalJuz += vJ;
		const vM = PDF_num2(it?.juzmurajaah ?? it?.murajaah ?? it?.mur_juz);
		if (vM != null) d.murJuz += vM;

        const jtSet = PDF_parseJuzTerbacaField(it?.juzTerbaca ?? it?.juz_terbaca ?? it?.juzTerbacaText ?? it?.juzText ?? it?.juzs ?? null);
        if (jtSet.size) {
          const arr = Array.from(jtSet).sort((a,b)=>a-b);
          let start = arr[0], prev = arr[0];
          for (let i=1; i<=arr.length; i++){
            const curr = arr[i];
            if (curr === prev + 1) { prev = curr; continue; }
            d.juz.push([start, prev]);
          }
        }

        const vN = PDF_num2(it?.buttonCell?.nilai ?? it?.nilai ?? it?.score);
        if (vN!=null) { d.nilaiSum += vN; d.nilaiCount++; }
      }

      const dayRows = [...byDate.values()].sort((a,b)=> (a.tanggal||'').localeCompare(b.tanggal||''));

      const agg = aggRows.find(r => r.nis === key || (!r.nis && r.id === key));
      const totH = agg?.hadir ?? dayRows.reduce((s,d)=>s+d.cnt.hadir,0);
      const totA = agg?.alpha ?? dayRows.reduce((s,d)=>s+d.cnt.alpha,0);
      const totS = agg?.sakit ?? dayRows.reduce((s,d)=>s+d.cnt.sakit,0);
      const totI = agg?.izin  ?? dayRows.reduce((s,d)=>s+d.cnt.izin,0);
      const totPages = Math.round(agg?.totalPageSum ?? dayRows.reduce((s,d)=>s+d.totalPage,0));
      const totJuz   = +(agg?.totalJuz ?? dayRows.reduce((s,d)=>s+d.totalJuz,0)).toFixed(2);
	  const murCountTotal = dayRows.reduce((s,d)=> s + ((d.murJuz||0) > 0 ? 1 : 0), 0);
	  const murJuzTotal   = +( (agg?.murTotalJuz ?? dayRows.reduce((s,d)=> s + (d.murJuz||0), 0)).toFixed(2) );
      const nilaiAvg = (agg?.nilaiCount ? agg.nilaiSum/agg.nilaiCount : 0);
      const statusJuzTotal = PDF_totalAllJuzStatus(totJuz, agg?.semester ?? semesterSantri);

      const daysCount = agg?.daysCount ?? dayRows.length;
      const hadirDays = agg?.hadirDays ?? dayRows.filter(d => d.cnt.hadir > 0).length;
      const hadirPctTotal = daysCount > 0 ? Math.round((hadirDays / daysCount) * 100) : 0;

      const tableRows = dayRows.map((d, idx) => {
        const validSessions = d.cnt.hadir + d.cnt.alpha + d.cnt.sakit + d.cnt.izin;
        const hadirPct = validSessions > 0 ? Math.round(100 * d.cnt.hadir / validSessions) : 0;
        const nilaiHarian = d.nilaiCount ? (d.nilaiSum/d.nilaiCount) : 0;
        const predHarian  = PDF_predikatFromScore(nilaiHarian);
        const statusJuzHarian = PDF_totalAllJuzStatus(d.totalJuz, semesterSantri);

        return {
          tanggal: d.tanggal,
          no: String(idx+1),
          nis: key,
          nama: namaSantri,
          sem: semesterSantri ?? (agg?.semester ?? '-'),
          jenjang: jenjangSantriLabel,
          ket: keteranganSantri,                         // SP
          h: d.cnt.hadir, a: d.cnt.alpha, s: d.cnt.sakit, i: d.cnt.izin,
          hadirPct: `${hadirPct}%`,
          setoran: PDF_joinSAsegmentsNama(d.sa),
          juz: PDF_joinRangeSegments(d.juz, true),
          totJuz: d.totalJuz ? d.totalJuz.toFixed(2) : '0.00',
		  murRange: fmtMurRange(d.murJuz || 0, (d.murJuz||0) > 0 ? 1 : 0),
          persen: statusJuzHarian.label,
          nilai: nilaiHarian ? nilaiHarian.toFixed(1) : '-',
          pred: predHarian.huruf
        };
      });

      const predTotal = PDF_predikatFromScore(nilaiAvg);
      const setoranTotal = agg ? PDF_joinSAsegmentsNama(agg.saSegments) : '-';
      const juzTotalTxt  = agg ? PDF_joinRangeSegments(agg.juzSegments, true) : '-';

      tableRows.push({
        _isRekap: true,
        no: '',
        nis: key,
        nama: 'REKAP',
        sem: semesterSantri ?? (agg?.semester ?? '-'),
        jenjang: jenjangSantriLabel,
        ket: keteranganSantri,                           // SP di baris rekap
        h: totH, a: totA, s: totS, i: totI,
        hadirPct: `${hadirPctTotal}%`,
        setoran: setoranTotal,
        juz: juzTotalTxt,
        totJuz: totJuz.toFixed(2),
		murRange: fmtMurRange(murJuzTotal, murCountTotal),
        persen: statusJuzTotal.label,
        nilai: nilaiAvg ? nilaiAvg.toFixed(1) : '-',
        pred: predTotal.huruf
      });

      // === PDF ===
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF) { alert('jsPDF belum dimuat. Tambahkan <script> jsPDF.'); return; }
      const doc = new jsPDF({ orientation: 'l', unit: 'mm', format: 'a3' });

      const theme = {
        cardBorder: [229,231,235],
        headerText: [15,23,42],
        tableHeadFill: [30,136,229],
        zebraFill: [248,250,252],
        border: [229,231,235],
        text: [31,41,55],
        statusFill: { tuntas: [220,252,231], khatam: [237,233,254] },
        rekapFill: [255, 249, 196]
      };

      const pageW  = doc.internal.pageSize.getWidth();
      const pageH  = doc.internal.pageSize.getHeight();
      const margin = { left: 12, right: 12, top: 12, bottom: 12 };
      const headerGap = 30, fontBody = 8.5, fontHead = fontBody + 1;
      const lineFactor = 1.18, lineH = fontBody * 0.3528 * lineFactor;
      const fontBodySmall = Math.max(6.5, fontBody - 0.8);
      const cellPadX = 1.6, cellPadY = 1.2;
      const headerRowH = Math.max(9, fontHead * 0.3528 * lineFactor + 2*cellPadY);

      function drawHeaderBarS(){
        doc.setDrawColor(...theme.cardBorder);
        doc.roundedRect(margin.left-3, margin.top-6, pageW - margin.left - margin.right + 6, 22, 3, 3);
        doc.setTextColor(...theme.headerText);
        doc.setFont('helvetica','bold'); doc.setFontSize(14);
        doc.text('Rincian Per Santri ‚Äî Absensi & Setoran', margin.left, margin.top);
        doc.setFont('helvetica','normal'); doc.setFontSize(10);
        doc.text(kelasLine, margin.left, margin.top + 6);
        doc.text(`Santri: ${key} ‚Äî ${namaSantri}`, margin.left, margin.top + 12);
        const rightX = pageW - margin.right - 78;
        doc.text(`Semester: ${tableRows.find(r=>!r._isRekap)?.sem ?? '-'}`, rightX, margin.top + 6);
        doc.text(`Periode: ${fmtD_M_YYYY(startDate)} s.d. ${fmtD_M_YYYY(endDate)}`, rightX, margin.top + 12);
        doc.setTextColor(...theme.text);
      }
      function drawFooterS(pageNo, totalPages, printedAt){
        const y = pageH - 6;
        doc.setDrawColor(...theme.border); doc.setLineWidth(0.2);
        doc.line(margin.left-2, y-3, pageW-margin.right+2, y-3);
        doc.setFontSize(8);
        doc.text(`Dicetak: ${printedAt}`, margin.left, y);
        doc.text(`Halaman ${pageNo} / ${totalPages}`, pageW - margin.right - 30, y);
      }

      const cols = [
        { key:'no',       title:'No.',  w:11, minW:11, maxW:12, align:'center' },
        { key:'nis',      title:'NIS',  w:26, minW:20, maxW:36, align:'left'   },
        { key:'nama',     title:'Nama', w:46, minW:36, maxW:80, align:'left'   },
        { key:'sem',      title:'SM',   w:12, minW:12, maxW:12, align:'center' },
        { key:'jenjang',  title:'KLS',  w:14, minW:14, maxW:14, align:'center' },
        { key:'h',        title:'H',    w:8,  minW:6,  maxW:10, align:'center' },
        { key:'a',        title:'A',    w:8,  minW:6,  maxW:10, align:'center' },
        { key:'s',        title:'S',    w:8,  minW:6,  maxW:10, align:'center' },
        { key:'i',        title:'I',    w:8,  minW:6,  maxW:10, align:'center' },
        { key:'hadirPct', title:'Hadir %', w:16, minW:16, maxW:18, align:'center' },
		{ key:'ket',      title:'SP',   w:12, minW:12, maxW:12, align:'center' }, // baru
        { key:'setoran',  title:'Setoran',  w:48, minW:32, maxW:120, align:'left'  },
        { key:'juz',      title:'Juz',      w:18, minW:18, maxW:18, align:'left'   },
        { key:'totJuz',   title:'Total Juz',    w:14, minW:14, maxW:22, align:'right'  },
		{ key:'murRange',  title:'Murajaah', w:20, minW:18, maxW:26, align:'right' },
        { key:'persen',   title:'THMS',     w:17, minW:17, maxW:18, align:'center' }, // ganti label
        { key:'nilai',    title:'Nilai',    w:14, minW:14, maxW:20, align:'right'  },
        { key:'pred',     title:'Predikat', w:18, minW:18, maxW:18, align:'center' },
      ];
      const contentW = pageW - margin.left - margin.right;
      fitColumnsFlex(doc, cols, tableRows, fontBody, contentW, cellPadX);

      drawHeaderBarS();
      let x0 = margin.left;
      let y  = margin.top + headerGap;

      drawTableHeader(doc, cols, x0, y, headerRowH, fontHead, theme, cellPadX);
      y += headerRowH;

      let rowIndex = 0;
      doc.setLineWidth(0.2);

      for (const row of tableRows) {
        const wraps = cols.map(col => doc.splitTextToSize(String(row[col.key] ?? ''), Math.max(1, col.w - 2*cellPadX)));
        const nisIdx = cols.findIndex(c => c.key === 'nis');
        if (nisIdx >= 0) {
          const lines = [String(row.nis || '-')];
          if (row.tanggal && !row._isRekap) lines.push(fmtD_M_YYYY(row.tanggal));
          wraps[nisIdx] = lines;
        }

        const baseLH = fontBody * 0.3528 * 1.18;
        const lineHSmall = fontBodySmall * 0.3528 * 1.18;
        const rowTextHeights = wraps.map((lines, i) => {
          if (cols[i].key === 'nis' && lines.length === 2) {
            return baseLH + lineHSmall;
          }
          return lines.length * baseLH;
        });
        const rowH = Math.max(baseLH + 2*cellPadY, Math.max(...rowTextHeights) + 2*cellPadY);

        if (y + rowH > pageH - margin.bottom) {
          doc.addPage('a3', 'landscape'); // tetap A3
          drawHeaderBarS();
          y = margin.top + headerGap;
          drawTableHeader(doc, cols, x0, y, headerRowH, fontHead, theme, cellPadX);
          y += headerRowH;
          rowIndex = 0;
        }

        if (row._isRekap) {
          doc.setFillColor(255, 249, 196);
          doc.rect(x0, y, sumWidth(cols), rowH, 'F');
        } else if (rowIndex % 2 === 1) {
          doc.setFillColor(248,250,252);
          doc.rect(x0, y, sumWidth(cols), rowH, 'F');
        }

        let x = x0;
        doc.setFont('helvetica','normal');
        doc.setFontSize(fontBody);
        doc.setTextColor(...theme.text);
        doc.setDrawColor(...theme.border);

        for (let ci=0; ci<cols.length; ci++){
          const col = cols[ci];
          const lines = wraps[ci];

          // highlight THMS tuntas/khatam (non REKAP)
          if (!row._isRekap && col.key === 'persen') {
            const val = String(row[col.key] || '').toUpperCase();
            if (val === 'TUNTAS' || val === 'KHATAM') {
              const fill = (val === 'TUNTAS') ? theme.statusFill.tuntas : theme.statusFill.khatam;
              doc.setFillColor(...fill);
              doc.rect(x, y, col.w, rowH, 'F');
            }
          }

          // >>> pewarnaan khusus kolom SP
          let spTextColor = null;
          if (col.key === 'ket') {
            spTextColor = PDF_spPaintCell(doc, x, y, col.w, rowH, row.ket);
            if (spTextColor) doc.setTextColor(...spTextColor);
          }

          let yy;
          const textBlockH = lines.length * baseLH;
          yy = y + (rowH - textBlockH)/2 + baseLH*0.82;
          let tx, opt = {};
          if (col.align === 'right') { tx = x + col.w - cellPadX; opt = { align:'right' }; }
          else if (col.align === 'center') { tx = x + col.w/2; opt = { align:'center' }; }
          else { tx = x + cellPadX; }
          for (let li=0; li<lines.length; li++){
            doc.text(String(lines[li]), tx, yy, opt);
            yy += baseLH;
          }

          doc.rect(x, y, col.w, rowH);
          if (spTextColor) doc.setTextColor(...theme.text); // reset bila override
          x += col.w;
        }

        y += rowH;
        rowIndex++;
      }

      // Tanda tangan + footer
      function fmtDDMMYYYY(iso){
        const m = String(iso||'').match(/^(\d{4})-(\d{2})-(\d{2})$/);
        return m ? `${m[3]}-${m[2]}-${m[1]}` : iso;
      }
      const printedAt = new Date();
      const printedISO = printedAt.toISOString().slice(0,10);
      const ttdDate = fmtDDMMYYYY(endDate) || fmtDDMMYYYY(printedISO) || printedAt.toLocaleDateString('id-ID');

      const spaceTop = 10, neededH = 36;
      if (y + spaceTop + neededH > pageH - margin.bottom){
        doc.addPage('a3', 'landscape');
        drawHeaderBarS();
        y = margin.top + headerGap;
      }
      y += spaceTop;

      const totalW = sumWidth(cols);
      const colGap = 8;
      const colW   = (totalW - colGap) / 2;
      const leftX  = margin.left;
      const rightX = margin.left + colW + colGap;

      doc.setFont('helvetica','normal'); doc.setFontSize(11);
      doc.text(`Jakarta, ${ttdDate}`, margin.left + totalW, y, { align:'right' });

      const headY = y + 8;
      doc.text('Mengetahui,', leftX, headY);
      doc.text('Muhaffizh,', rightX, headY);

      const lineY = headY + 24;
      doc.setDrawColor(...theme.border);
      doc.line(leftX,  lineY, leftX  + colW - 10, lineY);
      doc.line(rightX, lineY, rightX + colW - 10, lineY);

      const totalPages = doc.internal.getNumberOfPages();
      for (let p = 1; p <= totalPages; p++) { doc.setPage(p); drawFooterS(p, totalPages, printedAt.toLocaleString()); }

      const fileName = `Rekap_perSantri_${key}_${startDate}_sd_${endDate}.pdf`;
      doc.save(fileName);

      const santriModal = document.getElementById('santriModalOverlay');
      if (santriModal) santriModal.style.display = 'none';

    } catch (err) {
      console.error(err);
      alert('Gagal mengunduh PDF per santri: ' + (err.message || err));
      throw err;
    } finally {
      const triggerBtn = document.getElementById('okSantriSelect') || pdfSantriBtn;
      setBtnLoading(triggerBtn, false);
    }
  }
  window._pdfSantriDownload = pdfSantriDownload;

  // ================= Excel (.xlsx) =================
  async function xlsRekapDownload(){
    setBtnLoading(xlsBtn, true, 'Membuat Excel‚Ä¶');
    try {
      await ensureXLSX();
      const { kelas, startDate, endDate, kelasLine, kbmDays, rows, totals } = await collectRekapData();

      const header = [
  "No","NIS","Nama","SM","KLS","H","A","S","I","Hadir %","SP",
  "Setoran (Surah: Ayat s.d. Surah: Ayat)","Juz","Total Juz","Murajaah","THMS","Nilai Rata2","Predikat"
];
      const body = rows.map((r, idx) => {
        const nilaiAvg  = r.nilaiCount ? (r.nilaiSum / r.nilaiCount) : 0;
        const pred      = PDF_predikatFromScore(nilaiAvg);
        const statusJuz = PDF_totalAllJuzStatus(r.totalJuz, r.semester);

        const setoranText = PDF_joinSAsegmentsNama(r.saSegments);
        const juzText     = PDF_joinRangeSegments(r.juzSegments, true);
        const personalDays = Number(r.daysCount || 0);
        const hadirDays    = Number(r.hadirDays || 0);
        const hadirPct     = personalDays > 0 ? Math.round((hadirDays / personalDays) * 100) : 0;

        return [
          idx+1,
          r.nis || r.id || '',
          r.nama || '',
          (r.semester ?? ''),
          jenjangLabel(r.jenjang ?? ''),
          r.hadir, r.alpha, r.sakit, r.izin,
		  hadirPct,
		  (r.keterangan ?? ''),   // SP (BENAR: setelah Hadir %)
          setoranText,
          juzText,
          Number(r.totalJuz.toFixed(2)),
		  fmtMurRange(r.murTotalJuz || 0, r.murCount || 0), // << baru
          statusJuz.label,
          (nilaiAvg ? Number(nilaiAvg.toFixed(1)) : null),
          pred.huruf
        ];
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet([header, ...body]);
      ws['!cols'] = autoFitColumns([header, ...body]);
      XLSX.utils.book_append_sheet(wb, ws, 'Rekap');

      const meta = [
        ["Rekap Absensi & Setoran", ""],
        ["Kelas / Kelompok", kelasLine],
        ["Periode", `${fmtD_M_YYYY(startDate)} s.d. ${fmtD_M_YYYY(endDate)}`],
        ["KBM (hari)", kbmDays],
        ["Total Santri", rows.length],
        [],
        ["Ringkasan", ""],
        ["Hadir", totals.totH],
        ["Alpha", totals.totA],
        ["Sakit", totals.totS],
        ["Izin",  totals.totI],
        ["Total Page", Math.round(totals.totPages)],
        ["Total Juz", Number(totals.totJuz.toFixed(2))]
      ];
      const wsMeta = XLSX.utils.aoa_to_sheet(meta);
      wsMeta['!cols'] = [{wch:24},{wch:40}];
      XLSX.utils.book_append_sheet(wb, wsMeta, 'Meta');

      const fileName = `Rekap_${kelas || 'kelas'}_${startDate}_sd_${endDate}.xlsx`;
      XLSX.writeFile(wb, fileName);

    } catch (err) {
      console.error(err);
      alert('Gagal mengunduh Excel: ' + (err.message || err));
    } finally {
      setBtnLoading(xlsBtn, false);
    }
  }

  // ===== Util =====

	function fmtMurRange(total, count){
  const t = Number(total||0);
  const c = Number(count||0);
  return `${t.toFixed(2)} (${c})`;
}
	
  function sumWidth(cols){ return cols.reduce((s,c)=>s + (Number(c.w)||0), 0); }
  function autoFitColumns(aoa){
    const colCount = Math.max(...aoa.map(r => r.length));
    const cols = Array.from({length: colCount}, (_,i) => {
      const maxLen = Math.max(...aoa.map(row => {
        const v = row[i];
        if (v == null) return 0;
        const s = (typeof v === 'string') ? v : String(v);
        return s.length;
      }), 0);
      return { wch: Math.min(60, Math.max(6, Math.ceil(maxLen * 1.1) + 2)) };
    });
    return cols;
  }
  function fitColumnsFlex(doc, cols, tableData, fontSize, contentW, padX){
    const keys = cols.map(c => c.key);
    const weights = keys.map((k,i) => {
      const headLen = String(cols[i].title || '').length;
      let maxLen = headLen;
      const sampleLimit = Math.min(300, tableData.length);
      for (let r=0; r<sampleLimit; r++){
        const s = String(tableData[r][k] ?? '');
        if (s.length > maxLen) maxLen = s.length;
      }
      if (['nama','setoran','juz'].includes(k)) maxLen *= 1.25;
      return maxLen;
    });

    const minSum = cols.reduce((a,c)=>a+(c.minW||c.w||8),0);
    const maxSum = cols.reduce((a,c)=>a+(c.maxW||c.w||8),0);
    const target = Math.max(minSum, Math.min(maxSum, contentW));

    const sumWgt = weights.reduce((a,b)=>a+b,0) || 1;
    let widths = cols.map((c,i)=>{
      const minW = c.minW ?? c.w ?? 8;
      const maxW = c.maxW ?? (minW+20);
      const frac = weights[i] / sumWgt;
      const raw  = minW + (target - minSum) * frac;
      return Math.max(minW, Math.min(maxW, raw));
    });

    let used = widths.reduce((a,b)=>a+b,0);
    let diff = target - used;
    const step = diff >= 0 ? 0.1 : -0.1;
    let guard = 0;
    while (Math.abs(diff) > 0.09 && guard++ < 200){
      for (let i=0; i<cols.length && Math.abs(diff)>0.09; i++){
        const minW = cols[i].minW ?? cols[i].w ?? 8;
        const maxW = cols[i].maxW ?? (minW+20);
        const canGrow = diff>0 && widths[i] + step <= maxW;
        const canShrink = diff<0 && widths[i] + step >= minW;
        if (canGrow || canShrink){ widths[i] += step; diff -= step; }
      }
    }

    widths = widths.map(w => Math.round(w*10)/10);
    const sumRounded = widths.reduce((a,b)=>a+b,0);
    const fix = Math.round((target - sumRounded)*10)/10;
    widths[widths.length-1] += fix;

    for (let i=0;i<cols.length;i++) cols[i].w = widths[i];
  }

  // ======= Parser & Aggregator util =======
  function PDF_normKey(v){ return String(v ?? '').trim(); }
  function PDF_num2(v){ if (v===0 || v==='0') return 0; const n=parseFloat(String(v??'').replace(',','.')); return Number.isFinite(n)?n:null; }
  function PDF_parseRange(r){ const m=String(r||'').trim().match(/^(\d+)\s*-\s*(\d+)$/); if(!m) return null; let a=+m[1], b=+m[2]; if(!Number.isFinite(a)||!Number.isFinite(b)) return null; return a<=b?[a,b]:[b,a]; }
  function PDF_parseSA(sa){ const m=String(sa||'').trim().match(/^(\d+)\s*:\s*(\d+)$/); return m?{s:+m[1], a:+m[2]}:null; }
  function PDF_compareSA(x,y){ if(!x||!y) return 0; return x.s!==y.s?x.s-y.s:x.a-y.a; }
  function PDF_normStatus(s){
    s = String(s||'').trim().toLowerCase();
    if (['hadir','h'].includes(s)) return 'hadir';
    if (['alpha','alfa','alpa','a'].includes(s)) return 'alpha';
    if (['sakit','skt','s'].includes(s)) return 'sakit';
    if (['izin','ijin','izn','i'].includes(s)) return 'izin';
    return 'lainnya';
  }
  function PDF_predikatFromScore(nilai){
    const map = [
      { max: 59,  text: 'ROSIB',         huruf: 'D' },
      { max: 69,  text: 'MAQBUL',        huruf: 'C' },
      { max: 79,  text: 'JAYYID',        huruf: 'B' },
      { max: 89,  text: 'JAYYID JIDDAN', huruf: 'A' },
      { max: 100, text: 'MUMTAZ',        huruf: 'A+' }
    ];
    return map.find(p => nilai <= p.max) || map[map.length-1];
  }
  function PDF_parseJuzTerbacaField(val){
    const out = new Set();
    if (val == null) return out;
    if (Array.isArray(val)) {
      val.forEach(v => {
        if (typeof v === 'number' && Number.isFinite(v)) out.add(v);
        else if (typeof v === 'string') PDF_parseJuzTerbacaField(v).forEach(n => out.add(n));
      });
      return out;
    }
    if (typeof val === 'number' && Number.isFinite(val)) { out.add(val); return out; }
    let str = String(val);
    str = str.replace(/[‚Äì‚Äî‚àí]/g, '-');
    str = str.replace(/\s*(s\.?d\.?|sd|sampai|to)\s*/gi, '-');
    str = str.replace(/juz\s*:?/gi, 'juz ');
    const re = /(?:juz\s*)?(\d{1,2})(?:\s*-\s*(\d{1,2}))?/gi;
    let m;
    while ((m = re.exec(str)) !== null) {
      let a = parseInt(m[1], 10);
      let b = m[2] ? parseInt(m[2], 10) : a;
      if (a > b) [a, b] = [b, a];
      a = Math.max(1, Math.min(30, a));
      b = Math.max(1, Math.min(30, b));
      for (let x = a; x <= b; x++) out.add(x);
    }
    return out;
  }
  function PDF_fmtSASegment(seg){ return `${seg.from.s}:${seg.from.a}-${seg.to.s}:${seg.to.a}`; }
  function PDF_dedupSASegments(arr){
    const seen = new Set(), out = [];
    for (const seg of (arr||[])) {
      if (!seg?.from || !seg?.to) continue;
      const norm = (PDF_compareSA(seg.from, seg.to) <= 0) ? seg : {from: seg.to, to: seg.from};
      const key = `${norm.from.s}:${norm.from.a}-${norm.to.s}:${norm.to.a}`;
      if (!seen.has(key)) { seen.add(key); out.push(norm); }
    }
    return out;
  }
  function PDF_sortSASegments(list){
    return [...(list||[])].sort((A,B)=>{
      const c1 = PDF_compareSA(A?.from, B?.from);
      if (c1 !== 0) return c1;
      return PDF_compareSA(A?.to, B?.to);
    });
  }
  function PDF_joinSAsegments(arr){
    const list = PDF_sortSASegments(PDF_dedupSASegments(arr));
    if (!list.length) return '-';
    return list.map(PDF_fmtSASegment).join(', ');
  }
  function PDF_sortRangeSegments(list){
    return [...(list||[])].sort((a,b)=>{
      const a0 = Number(a?.[0]), a1 = Number(a?.[1]);
      const b0 = Number(b?.[0]), b1 = Number(b?.[1]);
      if (a0 !== b0) return a0 - b0;
      return a1 - b1;
    });
  }
  function PDF_joinRangeSegments(arr, collapseSingle=false){
    if (!arr || !arr.length) return '-';
    const seen = new Set(), tmp = [];
    for (const seg of arr){
      if (!Array.isArray(seg) || seg.length<2) continue;
      let a = Number(seg[0]), b = Number(seg[1]);
      if (!Number.isFinite(a) || !Number.isFinite(b)) continue;
      if (a > b) [a,b] = [b,a];
      const key = `${a}-${b}`;
      if (!seen.has(key)) { seen.add(key); tmp.push([a,b]); }
    }
    const out = PDF_sortRangeSegments(tmp).map(([a,b]) => (collapseSingle && a===b) ? `${a}` : `${a}-${b}`);
    return out.length ? out.join(', ') : '-';
  }
  function PDF_percentCapaian(totalJuzNum, semester){
    const batasSemester = {1: 8, 2: 13, 3: 18, 4: 23, 5: 28, 6: 30};
    const total = Number(totalJuzNum);
    const sem   = Number(semester);
    if (!Number.isFinite(total)) return 0;
    if (total >= 30) return 100;
    const batas = batasSemester[sem] || 0;
    if (batas <= 0) return 0;
    let p = Math.floor((total / batas) * 100);
    return Math.max(0, Math.min(100, p));
  }
  function PDF_totalAllJuzStatus(totalJuzNum, semester){
    const p = PDF_percentCapaian(totalJuzNum, semester);
    if (Number(totalJuzNum) >= 30) return { label:'KHATAM', percent:100 };
    if (p >= 100) return { label:'TUNTAS', percent:p };
    return { label: `${p}%`, percent:p };
  }

  // === Aggregator: simpan jenjang & keterangan ===
  function PDF_buildRekapPerKey(items){
    const map = Object.create(null);
    for (const it of (items||[])) {
      const id  = PDF_normKey(it?.id);
      const nis = PDF_normKey(it?.nis);
      const key = PDF_normKey(nis || id);
      if (!key) continue;

      if (!map[key]) map[key] = {
        id:id||'', nis:nis||'', nama: it?.nama || '',
        hadir:0, alpha:0, sakit:0, izin:0, lainnya:0,
        dariMin:null, sampaiMax:null,
        pageStartMin:null, pageEndMax:null,
        totalPageSum:0,
		totalJuz:0,            // semua juz (setoran)
		murTotalJuz: 0,        // << BARU: total juz murajaah (dari 'juzmurajaah')
		murCount: 0,           // << BARU: jumlah hari yang memiliki murajaah (>0)
        _nilaiByDate:Object.create(null),
        nilaiSum:0, nilaiCount:0, nilaiMin:Infinity, nilaiMax:-Infinity,
        juzSet:new Set(),
        semester: (it?.semester!=null ? Number(it.semester) : null),
        jenjang: (it?.jenjang ?? null),
        keterangan: (it?.keterangan ?? null),      // SP
        saSegments: [], pageSegments: [], juzSegments: [],
        _datesAll: new Set(), _datesHadir: new Set()
      };
      const r = map[key];
      if (!r.nama && it?.nama) r.nama = it.nama;

      const tgl = it?.tanggal ? String(it.tanggal).slice(0,10) : null;
      const st  = PDF_normStatus(it?.absensi ?? it?.status);

      if (st==='hadir') r.hadir++;
      else if (st==='alpha') r.alpha++;
      else if (st==='sakit') r.sakit++;
      else if (st==='izin') r.izin++;
      else r.lainnya++;

      if (tgl && r.nis && nis && nis === r.nis) {
        r._datesAll.add(tgl);
        if (st === 'hadir') r._datesHadir.add(tgl);
      }

      const dari = PDF_parseSA(it?.dari || it?.dariSetoran);
      const smp  = PDF_parseSA(it?.sampai || it?.sampaiSetoran);
      if (dari && smp) {
        const seg = (PDF_compareSA(dari, smp) <= 0) ? {from: dari, to: smp} : {from: smp, to: dari};
        r.saSegments.push(seg);
      }
      const rng = PDF_parseRange(it?.halaman || it?.page);
      const tp  = PDF_num2(it?.totalHalaman ?? it?.totalPage);
      if (tp!=null) r.totalPageSum += tp;
      else if (rng) r.totalPageSum += Math.max(0, rng[1]-rng[0]+1);
      if (rng){
        let [a,b] = rng; if (a>b) [a,b]=[b,a];
        r.pageSegments.push([a,b]);
        if (Number.isFinite(a) && (r.pageStartMin==null || a<r.pageStartMin)) r.pageStartMin=a;
        if (Number.isFinite(b) && (r.pageEndMax==null   || b>r.pageEndMax))   r.pageEndMax=b;
      }

      const vJ = PDF_num2(it?.totalJuz ?? it?.juz);
      if (vJ!=null) r.totalJuz += vJ;
	  // --- Murajaah dari server ('juzmurajaah') ---
	const vM = PDF_num2(it?.juzmurajaah ?? it?.murajaah ?? it?.mur_juz);
	if (vM != null) {
  	r.murTotalJuz += vM;
  	if (vM > 0) r.murCount += 1;
	}


      const vNraw = (it?.buttonCell?.nilai ?? it?.nilai ?? it?.score);
      const vN = PDF_num2(vNraw);
      if (tgl && vN!=null) r._nilaiByDate[tgl] = vN;

      const jtRaw = it?.juzTerbaca ?? it?.juz_terbaca ?? it?.juzTerbacaText ?? it?.juzText ?? it?.juzs ?? it?.juz;
      const set = PDF_parseJuzTerbacaField(jtRaw);
      if (set.size) {
        set.forEach(n=> r.juzSet.add(n));
        const arr = Array.from(set).sort((a,b)=>a-b);
        let start = arr[0], prev = arr[0];
        for (let i=1; i<=arr.length; i++){
          const curr = arr[i];
          if (curr === prev + 1) { prev = curr; continue; }
          r.juzSegments.push([start, prev]);
        }
      }

      if (r.semester==null   && it?.semester   !=null) r.semester   = Number(it.semester);
      if (r.jenjang == null  && it?.jenjang    !=null) r.jenjang    = it.jenjang;
      if (r.keterangan == null && it?.keterangan !=null) r.keterangan = it.keterangan; // SP
    }

    for (const k in map){
      const r = map[k];
      r.nilaiSum = 0; r.nilaiCount = 0; r.nilaiMin = Infinity; r.nilaiMax = -Infinity;
      for (const t in r._nilaiByDate){
        const v = r._nilaiByDate[t];
        r.nilaiSum += v; r.nilaiCount += 1;
        if (v < r.nilaiMin) r.nilaiMin = v;
        if (v > r.nilaiMax) r.nilaiMax = v;
      }
      if (!Number.isFinite(r.nilaiMin)) r.nilaiMin = 0;
      if (!Number.isFinite(r.nilaiMax)) r.nilaiMax = 0;

      r.daysCount  = r._datesAll.size;
      r.hadirDays  = r._datesHadir.size;

      r.saSegments   = PDF_dedupSASegments(r.saSegments);
      r.pageSegments = (function dedupRange(list){
        const seen = new Set(), out=[];
        for (const seg of (list||[])){
          if (!Array.isArray(seg) || seg.length<2) continue;
          let a = Number(seg[0]), b = Number(seg[1]);
          if (!Number.isFinite(a) || !Number.isFinite(b)) continue;
          if (a>b) [a,b]=[b,a];
          const key = `${a}-${b}`;
          if (!seen.has(key)) { seen.add(key); out.push([a,b]); }
        }
        return out;
      })(r.pageSegments);
      r.juzSegments  = (function dedupRange(list){
        const seen = new Set(), out=[];
        for (const seg of (list||[])){
          if (!Array.isArray(seg) || seg.length<2) continue;
          let a = Number(seg[0]), b = Number(seg[1]);
          if (!Number.isFinite(a) || !Number.isFinite(b)) continue;
          if (a>b) [a,b]=[b,a];
          const key = `${a}-${b}`;
          if (!seen.has(key)) { seen.add(key); out.push([a,b]); }
        }
        return out;
      })(r.juzSegments);
    }
    return map;
  }

  // ======= Header tabel =======
  function drawTableHeader(doc, cols, x, y, rowH, fontSize, theme, padX){
    const totalW = sumWidth(cols);
    doc.setFillColor(...theme.tableHeadFill);
    doc.setDrawColor(...theme.border);
    doc.rect(x, y, totalW, rowH, 'FD');
    doc.setFont('helvetica','bold');
    doc.setFontSize(fontSize);
    doc.setTextColor(255,255,255);
    let cx = x;
    const lh = fontSize * 0.3528 * 1.18;
    for (const col of cols){
      const lines = doc.splitTextToSize(String(col.title||''), Math.max(1, col.w - 2*padX));
      const textH = lines.length * lh;
      const yy = y + (rowH - textH)/2 + lh*0.82;
      const tx = (col.align==='right') ? (cx + col.w - padX)
               : (col.align==='center') ? (cx + col.w/2)
               : (cx + padX);
      const opt = (col.align==='right') ? {align:'right'} : (col.align==='center') ? {align:'center'} : {};
      for (let i=0;i<lines.length;i++) doc.text(String(lines[i]), tx, yy + i*lh, opt);
      doc.rect(cx, y, col.w, rowH);
      cx += col.w;
    }
    doc.setTextColor(31,41,55);
    doc.setFont('helvetica','normal');
  }
})();











// ============================
// hitungTotalAllJuzFromTable (REVISI FINAL)
// ============================

// --- util kecil untuk normalisasi kunci & angka ---
const normKey = (v) => String(v ?? "").trim();
const parseNum = (v) => {
  if (typeof v === "number") return Number.isFinite(v) ? v : 0;
  let s = String(v ?? "").trim();
  if (!s) return 0;
  // buang selain digit, titik, koma, minus
  s = s.replace(/[^0-9.,-]/g, "");
  const comma = s.lastIndexOf(",");
  const dot   = s.lastIndexOf(".");
  if (comma > -1 && dot > -1) {
    // jika koma paling kanan ‚Üí koma desimal
    if (comma > dot) { s = s.replace(/\./g, "").replace(",", "."); }
    else { s = s.replace(/,/g, ""); }
  } else if (comma > -1) {
    s = s.replace(/\./g, "").replace(",", ".");
  } else {
    s = s.replace(/,/g, "");
  }
  const n = parseFloat(s);
  return Number.isFinite(n) ? n : 0;
};

// helper ambil nama murni dari cell
function getNamaFromCell(cell) {
  if (!cell) return "";
  const first = cell.childNodes && cell.childNodes[0];
  const txt = (first && first.textContent) ? first.textContent : cell.textContent;
  return String(txt).trim();
}

// pastikan semesterMap sudah terisi (kalau fungsi dipanggil sebelum loadSantriData)
async function ensureSemesterMap(kelas) {
  if (window.semesterMap && Object.keys(window.semesterMap).length) return;
  try {
    const res = await fetch(`/api/getSantri?kelas=${encodeURIComponent(kelas)}&t=${Date.now()}`);
    const santri = await res.json();
    window.semesterMap = {};
    (santri || []).forEach(s => {
      const k = normKey(s?.nis) || normKey(s?.id);
      if (k) window.semesterMap[k] = String(s?.semester ?? "1");
    });
  } catch (e) {
    console.warn("ensureSemesterMap gagal:", e);
    window.semesterMap ??= {};
    window.jenjangMap  ??= {};
    window.keteranganMap ??= {};
  }
}

// ambil semester: masterMap ‚Üí select di baris ‚Üí arsip ‚Üí default 1
function getSemesterForKey(key, row, fallbackFromArchive) {
  const mapVal = window?.semesterMap ? window.semesterMap[key] : null;
  if (mapVal != null && mapVal !== "") return Number(mapVal);
  const selVal = row?.querySelector?.(".semester")?.value;
  if (selVal != null && selVal !== "") return Number(selVal);
  if (fallbackFromArchive != null && fallbackFromArchive !== "") return Number(fallbackFromArchive);
  return 1;
}

// fallback: baca total juz dari kolom harian di baris (kalau rekap kosong)
function getTotalJuzFromRow(row) {
  const td = row?.querySelector?.(".total-juz");
  if (!td) return 0;
  // biasanya isi angka murni
  return parseNum(td.textContent);
}

// ============================
// HITUNG MANUAL (via overlay)
// ============================
async function hitungTotalAllJuzFromTable() {
  const kelas  = kelasSelect.value;
  const dari   = document.getElementById("rangeDari")?.value;
  const sampai = document.getElementById("rangeSampai")?.value;

  if (!dari)   { alert("Mohon pilih tanggal Dari.");   return; }
  if (!sampai) { alert("Mohon pilih tanggal Sampai."); return; }

  overlay.style.display = "flex";

  try {
    await ensureSemesterMap(kelas);

    // Ambil data absensi rentang (anti-cache)
    const res = await fetch(
      `/api/getAbsensiRange?kelas=${encodeURIComponent(kelas)}&start=${encodeURIComponent(dari)}&end=${encodeURIComponent(sampai)}&t=${Date.now()}`
    );
    if (!res.ok) throw new Error("Gagal ambil data absensi.");
    const payload = await res.json();
    const allData = Array.isArray(payload) ? payload : (payload?.list || []);

    const rows = [...santriTableBody.querySelectorAll("tr")];

    // Peta nama ‚Üí key tabel (agar record arsip tanpa NIS/ID tetap masuk)
    const nameToKey = new Map();
    rows.forEach(row => {
      const key = normKey(row.dataset?.nis || row.dataset?.id || row.dataset?.key);
      const nm  = getNamaFromCell(row.children?.[1]);
      if (key && nm) nameToKey.set(nm.toLowerCase(), key);
    });

    // Rekap: kunci stabil (nis || id) ‚Üí fallback nama‚Üíkey
    const rekap = Object.create(null); // key => { totalJuz, semester?, id, nis, nama? }
    (allData || []).forEach(item => {
      let id   = normKey(item?.id);
      let nis  = normKey(item?.nis);
      let key  = normKey(nis || id);
      if (!key) {
        const nm = normKey(item?.nama).toLowerCase();
        if (nm && nameToKey.has(nm)) key = nameToKey.get(nm);
      }
      if (!key) return;
      if (!rekap[key]) rekap[key] = { totalJuz: 0, semester: item?.semester ?? null, id, nis, nama: item?.nama ?? "" };
      rekap[key].totalJuz += parseNum(item?.totalJuz);
    });

    // Batas ketuntasan per semester
    const batasSemester = {1: 8, 2: 13, 3: 18, 4: 23, 5: 28, 6: 30};

    // Update tabel + siapkan data simpan
    const dataToSave = [];

    rows.forEach(row => {
      const key  = normKey(row.dataset?.key || row.dataset?.nis || row.dataset?.id);
      const cell = row.querySelector(".total-all-juz");
      if (!cell) return;

      // ambil dari rekap; kalau kosong, fallback baca dari sel .total-juz
      let totalJuzNum = rekap[key] ? parseNum(rekap[key].totalJuz) : 0;
      let archSem = rekap[key]?.semester ?? null;

      if (!totalJuzNum) {
        const fallbackRowVal = getTotalJuzFromRow(row);
        if (fallbackRowVal) totalJuzNum = fallbackRowVal; // pakai isi kolom kalau ada
      }

      if (totalJuzNum) {
        const semester = getSemesterForKey(key, row, archSem);
        const batas    = batasSemester[semester] || 0;
        const totalJuzStr = totalJuzNum.toFixed(2);

        let label, warna;
        if (totalJuzNum >= 30) { label = "KHATAM"; warna = "green"; }
        else {
          let prosentase = batas > 0 ? Math.floor((totalJuzNum / batas) * 100) : 0;
          if (prosentase > 100) prosentase = 100;
          if (prosentase >= 100) { label = "TUNTAS"; warna = "green"; }
          else { label = `${prosentase}%`; warna = "red"; }
        }

        // ‚Üê tambah "juz"
        cell.innerHTML = `${totalJuzStr}&nbsp;juz <span style="color:${warna}; font-size:12px;">${label}</span>`;

        dataToSave.push({
          key,
          id: rekap[key]?.id || "",
          nis: rekap[key]?.nis || "",
          totalJuz: Number(totalJuzStr),
          semester: semester || null,
          isKhatam: totalJuzNum >= 30
        });
      } else {
        // ‚Üê tambah "juz"
        cell.innerHTML = `0.00&nbsp;juz <span style="color:red; font-size:10px">0%</span>`;
      }
    });

    // Simpan hasil rekap ke backend
    const saveRes = await fetch('/api/aksesAutoUpdateAllJuz', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ fromDate: dari, toDate: sampai, kelas, data: dataToSave }),
    });

    if (!saveRes.ok) {
      const errText = await saveRes.text().catch(()=>"(no body)");
      throw new Error(`Gagal menyimpan data: ${errText}`);
    }

    alert("‚úÖ Total All Juz berhasil dihitung dan disimpan.");
  } catch (err) {
    console.error(err);
    alert("‚ùå Terjadi kesalahan: " + err.message);
  } finally {
    overlay.style.display = "none";
  }
}

// Buka overlay (rangeDari dibatasi hari ini; rangeSampai bebas)
function bukaOverlayTotalAllJuz() {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, "0");
  const dd = String(today.getDate()).padStart(2, "0");
  const todayStr = `${yyyy}-${mm}-${dd}`;

  const rangeDari = document.getElementById("rangeDari");
  const rangeSampai = document.getElementById("rangeSampai");

  if (rangeDari) {
    rangeDari.max = todayStr;
    if (!rangeDari.value || rangeDari.value > todayStr) rangeDari.value = todayStr;
  }

  if (rangeSampai) {
    rangeSampai.removeAttribute("max");
    rangeSampai.disabled = false;
    if (!rangeSampai.value) rangeSampai.value = todayStr;
  }

  document.getElementById("juzOverlay").style.display = "flex";
}

document.getElementById("btnHitungTotalJuz").addEventListener("click", hitungTotalAllJuzFromTable);

// ==================================
// HITUNG OTOMATIS (setelah render)
// ==================================
async function hitungTotalAllJuzOtomatis() {
  const kelas = kelasSelect.value;

  // Tunggu tabel terisi
  const rows = santriTableBody.querySelectorAll("tr");
  if (rows.length === 0) {
    setTimeout(hitungTotalAllJuzOtomatis, 200);
    return;
  }

  // Ambil tanggal otomatis dari server
  const rangeDari = document.getElementById("rangeDari");
  const rangeSampai = document.getElementById("rangeSampai");
  try {
    const res = await fetch(`/api/getAutoUpdateAllJuz?t=${Date.now()}`);
    const allData = await res.json();
    const kelasData = (allData || []).find(item => item.kelas === kelas);
    if (kelasData) {
      if (rangeDari)   rangeDari.value   = kelasData.fromDate || "";
      if (rangeSampai) rangeSampai.value = kelasData.toDate   || "";
    }
  } catch (err) {
    console.error("Gagal ambil tanggal otomatis:", err);
  }

  const dari = rangeDari?.value;
  const sampai = rangeSampai?.value;
  if (!dari || !sampai) return;

  // Ambil absensi & hitung
  try {
    await ensureSemesterMap(kelas);

    const resAbs = await fetch(
      `/api/getAbsensiRange?kelas=${encodeURIComponent(kelas)}&start=${encodeURIComponent(dari)}&end=${encodeURIComponent(sampai)}&t=${Date.now()}`
    );
    if (!resAbs.ok) throw new Error("Gagal ambil data absensi.");
    const payload = await resAbs.json();
    const allData = Array.isArray(payload) ? payload : (payload?.list || []);

    // Peta nama ‚Üí key tabel
    const rowsArr = [...santriTableBody.querySelectorAll("tr")];
    const nameToKey = new Map();
    rowsArr.forEach(row => {
      const key = normKey(row.dataset?.nis || row.dataset?.id || row.dataset?.key);
      const nm  = getNamaFromCell(row.children?.[1]);
      if (key && nm) nameToKey.set(nm.toLowerCase(), key);
    });

    // Rekap by key (nis || id ‚Üí fallback nama)
    const rekap = Object.create(null);
    (allData || []).forEach(item => {
      let id  = normKey(item?.id);
      let nis = normKey(item?.nis);
      let key = normKey(nis || id);
      if (!key) {
        const nm = normKey(item?.nama).toLowerCase();
        if (nm && nameToKey.has(nm)) key = nameToKey.get(nm);
      }
      if (!key) return;
      if (!rekap[key]) rekap[key] = { totalJuz: 0, semester: item?.semester ?? null };
      rekap[key].totalJuz += parseNum(item?.totalJuz);
    });

    const batasSemester = {1: 8, 2: 13, 3: 18, 4: 23, 5: 28, 6: 30};

    rowsArr.forEach(row => {
      const key  = normKey(row.dataset?.key || row.dataset?.nis || row.dataset?.id);
      const cell = row.querySelector(".total-all-juz");
      if (!cell) return;

      let totalJuzNum = rekap[key] ? parseNum(rekap[key].totalJuz) : 0;
      if (!totalJuzNum) {
        // fallback baca langsung dari tabel kolom harian
        totalJuzNum = getTotalJuzFromRow(row);
      }

      if (totalJuzNum) {
        const semester = getSemesterForKey(key, row, rekap[key]?.semester);
        const target   = batasSemester[semester] || 0;
        const totalJuzStr = totalJuzNum.toFixed(2);

        let label, warna;
        if (totalJuzNum >= 30) { label = "KHATAM";  warna = "purple"; }
        else {
          let prosentase = target > 0 ? Math.floor((totalJuzNum / target) * 100) : 0;
          if (prosentase > 100) prosentase = 100;
          if (prosentase >= 100) { label = "TUNTAS"; warna = "green"; }
          else { label = `${prosentase}%`; warna = "red"; }
        }

        // ‚Üê tambah "juz"
        cell.innerHTML = `${totalJuzStr}&nbsp;juz <span style="color:${warna}; font-size:14px">${label}</span>`;
      } else {
        // ‚Üê tambah "juz"
        cell.innerHTML = `0.00&nbsp;juz <span style="color:red; font-size:16px">0%</span>`;
      }
    });
  } catch (err) {
    console.error("Gagal ambil data absensi:", err);
  }
}

// Jalankan saat pertama kali halaman selesai dimuat
window.addEventListener("DOMContentLoaded", hitungTotalAllJuzOtomatis);

// Pastikan otomatis jalan lagi setelah tabel diperbarui
function afterTableRendered() { setTimeout(hitungTotalAllJuzOtomatis, 50); }

// Integrasi ke loadSantriData atau fungsi render tabel (guard bila belum terdefinisi)
const originalLoadSantriData = window.loadSantriData;
window.loadSantriData = async function (...args) {
  if (typeof originalLoadSantriData === "function") {
    await originalLoadSantriData.apply(this, args);
  }
  afterTableRendered();
};

// Kalau ganti tanggal atau kelas, otomatis muat ulang tabel & hitung
tanggalInput?.addEventListener("change", () => loadSantriData());
kelasSelect?.addEventListener("change", () => loadSantriData());
	 
</script>



<script>
// ---------- Murajaah ----------
(function(){
  const MAP_URL='https://raw.githubusercontent.com/dickymiswardi/tadabbur/main/ayah_page_map.json';
  const LAST_PAGE=604;
  const SKIP=(p)=> (p===21 || (p>=602 && p<=604));
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>[...r.querySelectorAll(s)];

  // ---------- Helper: resolve kelas & tanggal dari berbagai sumber Murajaah ----------
  function resolveKelas(){
    // urutan fallback: window var ‚Üí id ‚Üí name ‚Üí data-kelas di table/container ‚Üí baris
    const byWin = (window.kelasSelect && window.kelasSelect.value) ? window.kelasSelect.value : "";
    const byId  = $('#kelasSelect')?.value || $('#kelas')?.value || '';
    const byName= (document.querySelector('select[name="kelas"]')?.value
                || document.querySelector('input[name="kelas"]')?.value
                || '');
    const byData= $('#santri-table')?.dataset?.kelas
               || document.body?.dataset?.kelas
               || '';
    if (String(byWin).trim())  return String(byWin).trim();
    if (String(byId).trim())   return String(byId).trim();
    if (String(byName).trim()) return String(byName).trim();
    if (String(byData).trim()) return String(byData).trim();
    // terakhir: coba ambil dari baris pertama (kalau ada)
    const row = $('#santri-table tbody tr');
    return String(row?.dataset?.kelas || '').trim();
  }
  function resolveTanggalGlobal(){
    const byWin = (window.tanggalInput && window.tanggalInput.value) ? window.tanggalInput.value : '';
    const byId  = $('#tanggalInput')?.value
               || $('#tanggal')?.value
               || $('#date')?.value
               || '';
    const byName= (document.querySelector('input[name="tanggal"]')?.value
                || document.querySelector('input[name="date"]')?.value
                || '');
    if (String(byWin).trim())  return String(byWin).trim();
    if (String(byId).trim())   return String(byId).trim();
    if (String(byName).trim()) return String(byName).trim();
    return '';
  }

  // ---------- Data Mushaf ----------
  let ayahPageMap={}, pageAyahCount={}, surahMaxAyah={}, dataReady=false, currentRowEl=null;
  const makeOpts=(n)=>Array.from({length:n},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('');
  const parseNum=(v)=>{ if(typeof v==='number')return Number.isFinite(v)?v:0; const s=String(v??'').replace(/[^0-9.,-]/g,'').replace(',', '.'); const n=parseFloat(s); return Number.isFinite(n)?n:0; };

  async function ensureMap(){
    if (dataReady) return;
    const res=await fetch(MAP_URL);
    ayahPageMap=await res.json();
    pageAyahCount={}; surahMaxAyah={};
    for (const [key,page] of Object.entries(ayahPageMap)){
      if(!page) continue;
      pageAyahCount[page]=(pageAyahCount[page]||0)+1;
      const [sStr,aStr]=key.split(':'); const s=+sStr,a=+aStr;
      if(s&&a && (!surahMaxAyah[s]||a>surahMaxAyah[s])) surahMaxAyah[s]=a;
    }
    for(let s=1;s<=114;s++) if(!surahMaxAyah[s]) surahMaxAyah[s]=(s===1?7:(s===9?129:286));
    dataReady=true;
  }

  function computeTotalJuz(sF,aF,sT,aT){
    let tot=0;
    for(let s=+sF;s<=+sT;s++){
      const startA=(s===+sF)?+aF:1, endA=(s===+sT)?+aT:surahMaxAyah[s];
      for(let a=startA;a<=endA;a++){
        const p=ayahPageMap[`${s}:${a}`]; if(!p||SKIP(p)) continue;
        const per=pageAyahCount[p]||1; tot+=0.05/per;
      }
    }
    return tot;
  }
  function ayahRangeToPages(sF,aF,sT,aT){
    let minP=Infinity,maxP=-Infinity,hit=false;
    for(let s=+sF;s<=+sT;s++){
      const aStart=(s===+sF)?+aF:1, aEnd=(s===+sT)?+aT:surahMaxAyah[s];
      for(let a=aStart;a<=aEnd;a++){
        const p=ayahPageMap[`${s}:${a}`]; if(!p||SKIP(p)) continue;
        hit=true; if(p<minP)minP=p; if(p>maxP)maxP=p;
      }
    }
    return hit?{pFrom:minP,pTo:maxP}:null;
  }
  function pagesToAyahRange(pFrom,pTo){
    const first=[],last=[];
    for(const [k,p] of Object.entries(ayahPageMap)){ if(p===+pFrom)first.push(k); if(p===+pTo)last.push(k); }
    if(!first.length||!last.length) return null;
    const [sF,aF]=first.map(k=>k.split(':').map(Number)).sort((a,b)=>a[0]-b[0]||a[1]-b[1])[0];
    const [sT,aT]=last .map(k=>k.split(':').map(Number)).sort((a,b)=>a[0]-b[0]||a[1]-b[1]).slice(-1)[0];
    return { sFrom:sF, aFrom:aF, sTo:sT, aTo:aT };
  }

  function fillPageSelects(){ $('#mur-pageFrom').innerHTML=makeOpts(LAST_PAGE); $('#mur-pageTo').innerHTML=makeOpts(LAST_PAGE); }
  function fillSurahSelect(sel){
    const N=["Al-Fatihah","Al-Baqarah","Ali 'Imran","An-Nisa'","Al-Ma'idah","Al-An'am","Al-A'raf","Al-Anfal","At-Taubah","Yunus","Hud","Yusuf","Ar-Ra'd","Ibrahim","Al-Hijr","An-Nahl","Al-Isra'","Al-Kahf","Maryam","Ta Ha","Al-Anbiya'","Al-Hajj","Al-Mu'minun","An-Nur","Al-Furqan","Ash-Shu'ara'","An-Naml","Al-Qasas","Al-'Ankabut","Ar-Rum","Luqman","As-Sajdah","Al-Ahzab","Saba'","Fatir","Ya-Sin","As-Saffat","Sad","Az-Zumar","Ghafir","Fussilat","Ash-Shura","Az-Zukhruf","Ad-Dukhan","Al-Jathiyah","Al-Ahqaf","Muhammad","Al-Fath","Al-Hujurat","Qaf","Adz-Dzariyat","At-Tur","An-Najm","Al-Qamar","Ar-Rahman","Al-Waqi'ah","Al-Hadid","Al-Mujadilah","Al-Hashr","Al-Mumtahanah","As-Saff","Al-Jumu'ah","Al-Munafiqun","At-Taghabun","At-Talaq","At-Tahrim","Al-Mulk","Al-Qalam","Al-Haqqah","Al-Ma'arij","Nuh","Al-Jinn","Al-Muzzammil","Al-Muddaththir","Al-Qiyamah","Al-Insan","Al-Mursalat","An-Naba'","An-Nazi'at","'Abasa","At-Takwir","Al-Infitar","Al-Mutaffifin","Al-Inshiqaq","Al-Buruj","At-Tariq","Al-A'la","Al-Ghashiyah","Al-Fajr","Al-Balad","Ash-Shams","Al-Layl","Ad-Duha","Ash-Sharh","At-Tin","Al-'Alaq","Al-Qadr","Al-Bayyinah","Az-Zalzalah","Al-'Adiyat","Al-Qari'ah","At-Takathur","Al-'Asr","Al-Humazah","Al-Fil","Quraysh","Al-Ma'un","Al-Kawthar","Al-Kafirun","An-Nasr","Al-Masad","Al-Ikhlas","Al-Falaq","An-Nas"];
    const el=$(sel); el.innerHTML=Array.from({length:114},(_,i)=>`<option value="${i+1}">${i+1} ‚Äî ${N[i]}</option>`).join('');
  }
  function fillAyahForSurah(sel,surahId,{keep=false,preset=null}={}){
    const el=(typeof sel==='string')?$(sel):sel; if(!el) return;
    const max=Math.max(1, +surahMaxAyah[+surahId]||1);
    const prev=keep? +el.value : null;
    el.innerHTML=makeOpts(max);
    if(preset!=null) el.value=String(Math.min(+preset,max));
    else if(keep && prev) el.value=String(Math.min(prev,max));
    else el.value="1";
  }

  function renderAndCompute(){
    const sF=+$('#mur-surahFrom').value||1, aF=+$('#mur-ayahFrom').value||1;
    const sT=+$('#mur-surahTo').value||sF, aT=+$('#mur-ayahTo').value||aF;
    const pages=ayahRangeToPages(sF,aF,sT,aT);
    if(pages){
      $('#mur-pageFrom').value=String(pages.pFrom);
      $('#mur-pageTo').value  =String(pages.pTo);
      $('#mur-pagesHint') && ($('#mur-pagesHint').textContent=`Halaman: ${pages.pFrom}‚Äî${pages.pTo}`);
    } else { $('#mur-pagesHint') && ($('#mur-pagesHint').textContent=''); }
    $('#mur-infoRange') && ($('#mur-infoRange').textContent=`Rentang Surah ${sF}:${aF} ‚Üí ${sT}:${aT}`);
    const total=computeTotalJuz(sF,aF,sT,aT);
    $('#mur-totalJuz') && ($('#mur-totalJuz').textContent=total.toFixed(2));

    if(currentRowEl){
      const cell=currentRowEl.querySelector('.murajaah-cell'); if(!cell) return;
      const valEl=cell.querySelector('.mur-val');
      valEl && (valEl.textContent = total.toFixed(2)+' juz');
      const pr=pages||{};
      cell.dataset.murtotal=String(total.toFixed(2));
      cell.dataset.sf=String(sF); cell.dataset.af=String(aF);
      cell.dataset.st=String(sT); cell.dataset.at=String(aT);
      cell.dataset.pf=String(pr.pFrom||''); cell.dataset.pt=String(pr.pTo||'');
    }
  }

  function bindModalEvents(){
    $('#mur-close')?.addEventListener('click',()=>{$('#murModal').style.display='none';});
    $('#mur-save')?.addEventListener('click', async()=>{
      try{
        renderAndCompute();
        if(typeof window.simpanDataMutabaah==='function'){
          await window.simpanDataMutabaah($('#mur-save'));
          await refreshMurFromServer(); // re-hydrate semua kolom dari server
        }
      }catch(e){console.error(e);}
    });

    function onPageChange(){
      let pF=+$('#mur-pageFrom').value||1, pT=+$('#mur-pageTo').value||pF;
      if(pT<pF){pT=pF; $('#mur-pageTo').value=String(pF);}
      const r=pagesToAyahRange(pF,pT);
      if(r){
        $('#mur-surahFrom').value=String(r.sFrom); fillAyahForSurah('#mur-ayahFrom', r.sFrom,{preset:r.aFrom});
        $('#mur-surahTo').value  =String(r.sTo);   fillAyahForSurah('#mur-ayahTo',   r.sTo,  {preset:r.aTo});
      }
      renderAndCompute();
    }
    $('#mur-pageFrom')?.addEventListener('change', onPageChange);
    $('#mur-pageTo')  ?.addEventListener('change', onPageChange);

    function onSurahChanged(which){
      const sF=+$('#mur-surahFrom').value||1, sT=+$('#mur-surahTo').value||sF;
      if(which==='from') fillAyahForSurah('#mur-ayahFrom', sF,{keep:true});
      else               fillAyahForSurah('#mur-ayahTo',   sT,{keep:true});
      const aF=+$('#mur-ayahFrom').value||1; let aT=+$('#mur-ayahTo').value||1;
      if(sT<sF || (sT===sF && aT<aF)){ $('#mur-surahTo').value=String(sF); fillAyahForSurah('#mur-ayahTo', sF,{keep:true}); if(+$('#mur-ayahTo').value<aF) $('#mur-ayahTo').value=String(aF); }
      renderAndCompute();
    }
    $('#mur-surahFrom')?.addEventListener('change',()=>onSurahChanged('from'));
    $('#mur-surahTo')  ?.addEventListener('change',()=>onSurahChanged('to'));

    function onAyatChanged(){
      const sF=+$('#mur-surahFrom').value,aF=+$('#mur-ayahFrom').value; let sT=+$('#mur-surahTo').value,aT=+$('#mur-ayahTo').value;
      if(sT<sF || (sT===sF && aT<aF)){ $('#mur-surahTo').value=String(sF); fillAyahForSurah('#mur-ayahTo', sF,{keep:true}); if(+$('#mur-ayahTo').value<aF) $('#mur-ayahTo').value=String(aF); }
      renderAndCompute();
    }
    $('#mur-ayahFrom')?.addEventListener('change', onAyatChanged);
    $('#mur-ayahTo')  ?.addEventListener('change', onAyatChanged);
  }

  async function openModalForRow(row){
    currentRowEl=row;
    $('#murModal').style.display='flex';
    if(!dataReady){
      await ensureMap();
      fillPageSelects(); fillSurahSelect('#mur-surahFrom'); fillSurahSelect('#mur-surahTo');
    }
    // pakai dataset yang SUDAH di-hydrate dari server
    const cell=row.querySelector('.murajaah-cell'); let sF=1,aF=1,sT=1,aT=1;
    if(cell?.dataset?.sf) sF=+cell.dataset.sf||sF;
    if(cell?.dataset?.af) aF=+cell.dataset.af||aF;
    if(cell?.dataset?.st) sT=+cell.dataset.st||sT;
    if(cell?.dataset?.at) aT=+cell.dataset.at||aT;
    $('#mur-surahFrom').value=String(sF); fillAyahForSurah('#mur-ayahFrom', sF,{preset:aF});
    $('#mur-surahTo').value  =String(sT); fillAyahForSurah('#mur-ayahTo',   sT,{preset:aT});
    renderAndCompute();
  }

  function ensureMurColumn(){
    const table=$('#santri-table'); if(!table) return;
    const theadRow=table.tHead?.rows?.[0];
    if(theadRow && !theadRow.querySelector('th.mur-header')){
      const th=document.createElement('th'); th.className='mur-header'; th.textContent='Murajaah'; theadRow.appendChild(th);
    }
    const rows=table.tBodies?.[0]?.rows||[];
    [...rows].forEach(tr=>{
      if(tr.querySelector('.murajaah-cell')) return;
      const td=document.createElement('td'); td.className='murajaah-cell';
      td.innerHTML=`
        <div class="mur-val" style="font-weight:600">0.00 juz</div>
        <div class="mur-label" style="font-size:11px; color:#6b7280;"></div>
        <button type="button" class="btn-mur" style="margin-top:6px; padding:4px 8px;">Input</button>`;
      tr.appendChild(td);
      td.querySelector('.btn-mur').addEventListener('click',()=>openModalForRow(tr));
    });
  }

  // ---------- REFRESH dari server untuk SEMUA tanggal yang tampil ----------
  async function refreshMurFromServer(){
    const k = resolveKelas();
    const table = $('#santri-table'); if(!k || !table) { console.warn('murajaah: kelas kosong atau table tidak ada'); return; }

    const rows = [...(table.tBodies?.[0]?.rows||[])];
    // kumpulkan tanggal dari baris; kalau tak ada, pakai tanggal global
    const tanggalSet = new Set(rows.map(r=>String(r.dataset?.tanggal||'').trim()).filter(Boolean));
    if (!tanggalSet.size) {
      const tg = resolveTanggalGlobal();
      if (tg) tanggalSet.add(tg);
    }
    if (!tanggalSet.size) { console.warn('murajaah: tidak ada tanggal (global/baris)'); return; }

    for (const tgl of tanggalSet){
      try{
        const res=await fetch(`/api/getAbsensi?kelas=${encodeURIComponent(k)}&tanggal=${encodeURIComponent(tgl)}`);
        if(!res.ok) continue;
        const arr=await res.json().catch(()=>[])||[];
        const byId=new Map(), byNis=new Map();
        arr.forEach(r=>{
          const id =(r.id!=null?String(r.id):'').trim();
          const nis=(r.nis!=null?String(r.nis):'').trim();
          if(id)  byId.set(id,r);
          if(nis) byNis.set(nis,r);
        });

        rows.forEach(tr=>{
          const rowTgl = String(tr.dataset?.tanggal||'').trim();
          // jika tabel multi-tanggal, update hanya baris yg match tgl ini (atau semua jika kita pakai tanggal global)
          if (tanggalSet.size>1 && rowTgl && rowTgl!==tgl) return;

          const cell=tr.querySelector('.murajaah-cell'); if(!cell) return;
          const nis = String(tr.dataset?.nis||'').trim();
          const id  = String(tr.children?.[0]?.textContent||'').trim();
          const rec = (nis && byNis.get(nis)) || (id && byId.get(id)) || null;

          const total=parseNum(rec?.juzmurajaah||0);
          const valEl=cell.querySelector('.mur-val'); valEl && (valEl.textContent=`${total.toFixed(2)} juz`);
          cell.dataset.murtotal=String(total.toFixed(2));

          const setSA=(src,dsS,dsA)=>{ if(!src){cell.dataset[dsS]='';cell.dataset[dsA]='';return;} const [s,a]=String(src).split(':'); cell.dataset[dsS]=s||''; cell.dataset[dsA]=a||''; };
          const setPages=(src)=>{ if(!src){cell.dataset.pf='';cell.dataset.pt='';return;} const [pf,pt]=String(src).split('-'); cell.dataset.pf=pf||''; cell.dataset.pt=pt||''; };
          setSA(rec?.murFrom,'sf','af'); setSA(rec?.murTo,'st','at'); setPages(rec?.murPages);
        });
      }catch(e){ console.warn('murajaah refresh fail', e); }
    }
  }

  function afterTableRendered(){ ensureMurColumn(); refreshMurFromServer(); }

  // ekspor
  window.murajaah = { afterTableRendered, refreshServer: refreshMurFromServer };

  // init
  (function init(){
    bindModalEvents();
    if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', afterTableRendered);
    else afterTableRendered();
    const _origLoad=window.loadSantriData;
    window.loadSantriData=async function(...args){
      if(typeof _origLoad==='function') await _origLoad.apply(this,args);
      setTimeout(afterTableRendered,0);
    };
  })();
})();
</script>


<script>
(function(){
  // ===== util & helpers Murajaah=====
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>[...r.querySelectorAll(s)];
  const normKey = v => String(v ?? "").trim();
  const parseNum = v => {
    if (typeof window.parseNum === "function") return window.parseNum(v);
    let s = String(v ?? "").trim();
    if (!s) return 0;
    s = s.replace(/[^0-9.,-]/g,"");
    const c = s.lastIndexOf(","), d = s.lastIndexOf(".");
    if (c>-1 && d>-1){ if (c>d){ s=s.replace(/\./g,"").replace(",","."); } else { s=s.replace(/,/g,""); } }
    else if (c>-1){ s=s.replace(/\./g,"").replace(",","."); }
    else { s=s.replace(/,/g,""); }
    const n = parseFloat(s); return Number.isFinite(n)?n:0;
  };
  const BATAS = {1: 8, 2: 13, 3: 18, 4: 23, 5: 28, 6: 30};
  const LS_KEY = k => `murRange:${k}`;

  function getSantriTable(){
    return document.getElementById('santri-table')
        || document.getElementById('santriTable')
        || document.querySelector('table[data-role="santri-table"]')
        || document.querySelector('table.santri-table')
        || null;
  }

  function kelasNow(){
    if (window.kelasSelect && window.kelasSelect.value) {
      const v = normKey(window.kelasSelect.value); try{ localStorage.setItem('lastKelas', v);}catch{}; return v;
    }
    const sel = document.querySelector(
      'select#kelasSelect, select[name="kelas"], select[name="kelasSelect"], '+
      'select.kelas-select, select.kelas, #kelas, .kelasSelect, .kelas'
    );
    if (sel && sel.value){ const v=normKey(sel.value); try{localStorage.setItem('lastKelas', v);}catch{}; return v; }
    const ref = document.querySelector('[data-kelas]'); if (ref?.dataset?.kelas){ const v=normKey(ref.dataset.kelas); try{localStorage.setItem('lastKelas', v);}catch{}; return v; }
    const qs = new URLSearchParams(location.search); const vq = qs.get('kelas') || qs.get('class') || qs.get('kls');
    if (vq){ const v=normKey(vq); try{localStorage.setItem('lastKelas', v);}catch{}; return v; }
    try{ const last = localStorage.getItem('lastKelas'); if (last) return normKey(last);}catch{}
    return '';
  }
  // track perubahan kelas => simpan lastKelas
  (function(){
    const cands = document.querySelectorAll(
      'select#kelasSelect, select[name="kelas"], select[name="kelasSelect"], '+
      'select.kelas-select, select.kelas, #kelas, .kelasSelect, .kelas'
    );
    cands.forEach(el=> el.addEventListener('change', ()=> {
      try{ localStorage.setItem('lastKelas', normKey(el.value||"")); }catch{}
    }));
    const k0 = kelasNow(); if (k0) try{ localStorage.setItem('lastKelas', k0);}catch{}
  })();

  // pakai ensureSemesterMap milikmu jika ada
  const ensureSemesterMap = window.ensureSemesterMap || (async function(kelas){
    if (window.semesterMap && Object.keys(window.semesterMap).length) return;
    try{
      const r = await fetch(`/api/getSantri?kelas=${encodeURIComponent(kelas)}&t=${Date.now()}`);
      const santri = await r.json();
      window.semesterMap = {};
      (santri||[]).forEach(s=>{
        const k = normKey(s?.nis) || normKey(s?.id);
        if (k) window.semesterMap[k] = String(s?.semester ?? "1");
      });
    }catch(e){ window.semesterMap ??={}; }
  });
  function getSemesterForKeyLocal(key, row, fallback){
    if (typeof window.getSemesterForKey === "function") return window.getSemesterForKey(key, row, fallback);
    const mapVal = window?.semesterMap ? window.semesterMap[key] : null;
    if (mapVal != null && mapVal !== "") return Number(mapVal);
    const selVal = row?.querySelector?.(".semester")?.value;
    if (selVal != null && selVal !== "") return Number(selVal);
    if (fallback != null && fallback !== "") return Number(fallback);
    return 1;
  }

  // ===== sisip header & kolom =====
  function ensureMurRangeColumn(){
    const table = getSantriTable(); if (!table) return;
    // header klik
    const thRow = table.tHead?.rows?.[0];
    if (thRow && !thRow.querySelector('#murRangeHeader')){
      const th = document.createElement('th');
      th.id = 'murRangeHeader';
      th.style.cursor = 'pointer';
      th.style.textDecoration = 'underline';
      th.textContent = 'Setting Murajaah';
      const murTh = thRow.querySelector('.mur-header');
      if (murTh && murTh.nextSibling) thRow.insertBefore(th, murTh.nextSibling);
      else thRow.appendChild(th);
      th.addEventListener('click', bukaOverlayTotalMurRange);
    }
    // body cell
    const rows = table.tBodies?.[0]?.rows || [];
    [...rows].forEach(tr=>{
      if (tr.querySelector('.total-mur-range')) return;
      const td = document.createElement('td');
      td.className = 'total-mur-range';
      td.innerHTML = `0.00&nbsp;juz <span class="mur-range-badge" style="color:#999; font-size:12px">0%</span> <small class="mur-range-count" style="color:#6b7280">(0)</small>`;
      const murCell = tr.querySelector('.murajaah-cell');
      if (murCell && murCell.nextSibling) tr.insertBefore(td, murCell.nextSibling);
      else tr.appendChild(td);
    });
  }

  // ===== persist range (server + local) =====
  async function saveRangeServer(kelas, fromDate, toDate, count){
    try{
      await fetch('/api/aksesAutoUpdateAllJuzMur', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          fromDate, toDate, kelas,
          // data opsional (hanya metadata ringan supaya kompat):
          data: [{ meta:true, count: Number(count||0) }]
        })
      });
    }catch(e){ /* diamkan: tetap punya fallback localStorage */ }
  }
  function saveRangeLocal(kelas, fromDate, toDate){
    try{ localStorage.setItem(LS_KEY(kelas), JSON.stringify({ fromDate, toDate, t: Date.now() })); }catch{}
  }
  async function getRangeForKelas(kelas){
    // 1) server
    try{
      const r = await fetch('/api/getAutoUpdateAllJuzMur?t='+Date.now());
      if (r.ok){
        const arr = await r.json();
        const it  = (arr||[]).find(x=>x.kelas===kelas);
        if (it && (it.fromDate || it.toDate)) return { fromDate: it.fromDate||"", toDate: it.toDate||"" };
      }
    }catch(_){}
    // 2) local
    try{
      const raw = localStorage.getItem(LS_KEY(kelas));
      if (raw){ const obj = JSON.parse(raw); return { fromDate: obj.fromDate||"", toDate: obj.toDate||"" }; }
    }catch(_){}
    return { fromDate:"", toDate:"" };
  }

  // ===== overlay =====
  function bukaOverlayTotalMurRange(){
    const el = $('#murRangeOverlay'); if (!el) return;
    const today = new Date(); const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,"0");
    const dd = String(today.getDate()).padStart(2,"0");
    const todayStr = `${yyyy}-${mm}-${dd}`;
    const dari = $('#murRangeDari'); const sampai = $('#murRangeSampai');
    if (dari){ dari.max = todayStr; if (!dari.value || dari.value > todayStr) dari.value = todayStr; }
    if (sampai){ sampai.removeAttribute('max'); if (!sampai.value) sampai.value = todayStr; }
    $('#murRangeStatus').textContent = '';
    el.style.display = 'flex';
  }

  // ===== hitung dari server ‚Üí tampilkan ‚Üí simpan tanggal =====
  async function hitungTotalMurRangeFromTable(){
    const kelas  = kelasNow();
    const table  = getSantriTable();
    const dari   = $('#murRangeDari')?.value;
    const sampai = $('#murRangeSampai')?.value;

    if (!kelas){ alert("Mohon pilih kelas."); console.warn("murajaah: kelas kosong"); return; }
    if (!table){ alert("Tabel santri belum tersedia."); console.warn("murajaah: table tidak ada"); return; }
    if (!dari){ alert("Mohon pilih tanggal Dari."); return; }
    if (!sampai){ alert("Mohon pilih tanggal Sampai."); return; }

    $('#murRangeStatus').textContent = "‚è≥ Menghitung‚Ä¶";

    try{
      await ensureSemesterMap(kelas);

      const res = await fetch(`/api/getAbsensiRange?kelas=${encodeURIComponent(kelas)}&start=${encodeURIComponent(dari)}&end=${encodeURIComponent(sampai)}&t=${Date.now()}`);
      if (!res.ok) throw new Error("Gagal ambil data absensi.");
      const payload = await res.json();
      const allData = Array.isArray(payload) ? payload : (payload?.list || []);

      const rows = [...(table.tBodies?.[0]?.rows || [])];

      // peta nama ‚Üí key (fallback)
      const nameToKey = new Map();
      rows.forEach(row=>{
        const key = normKey(row.dataset?.nis || row.dataset?.id || row.dataset?.key);
        const nm  = (row.children?.[1] ? (row.children[1].childNodes?.[0]?.textContent || row.children[1].textContent) : "") || "";
        if (key && nm) nameToKey.set(nm.trim().toLowerCase(), key);
      });

      // rekap per key
      const rekap = Object.create(null); // key ‚Üí { sum, count, semester? , id, nis }
      (allData||[]).forEach(item=>{
        let id  = normKey(item?.id);
        let nis = normKey(item?.nis);
        let key = normKey(nis || id);
        if (!key){
          const nm = normKey(item?.nama).toLowerCase();
          if (nm && nameToKey.has(nm)) key = nameToKey.get(nm);
        }
        if (!key) return;
        const val = parseNum(item?.juzmurajaah);
        if (!rekap[key]) rekap[key] = { sum:0, count:0, semester:item?.semester ?? null, id:item?.id||"", nis:item?.nis||"" };
        rekap[key].sum += val;
        if (val > 0) rekap[key].count += 1;
      });

      // tampilkan
      rows.forEach(row=>{
        const key  = normKey(row.dataset?.key || row.dataset?.nis || row.dataset?.id);
        const cell = row.querySelector('.total-mur-range');
        if (!cell) return;

        const rec = key ? rekap[key] : null;
        const totalNum = rec ? Number(rec.sum || 0) : 0;
        const semester = getSemesterForKeyLocal(key, row, rec?.semester);
        const target   = BATAS[semester] || 0;
        const totalStr = totalNum.toFixed(2);

        let label = "0%", warna = "red";
        if (totalNum >= 30){ label="KHATAM"; warna="purple"; }
        else {
          let persen = target>0 ? Math.floor((totalNum/target)*100) : 0;
          if (persen>100) persen=100;
          if (persen>=100){ label="TUNTAS"; warna="green"; } else { label = `${persen}%`; warna="red"; }
        }

        cell.innerHTML = `${totalStr}&nbsp;juz <span class="mur-range-badge" style="color:${warna}; font-size:12px">${label}</span> <small class="mur-range-count" style="color:#6b7280">(${rec?.count||0})</small>`;
        cell.dataset.murRangeTotal = totalStr;
        cell.dataset.murRangeCount = String(rec?.count || 0);
      });

      // === simpan tanggal ke server + local agar otomatis terpakai saat refresh
      const totalKeys = Object.keys(rekap).length;
      await saveRangeServer(kelas, dari, sampai, totalKeys);
      saveRangeLocal(kelas, dari, sampai);

      $('#murRangeStatus').textContent = "‚úÖ Disimpan. Rentang ini akan otomatis terpakai saat refresh.";
    }catch(err){
      console.error(err);
      $('#murRangeStatus').textContent = "‚ùå " + (err?.message || err);
      alert("‚ùå Terjadi kesalahan: " + (err?.message || err));
    }
  }

  // tombol overlay
  $('#btnHitungTotalMur')?.addEventListener('click', hitungTotalMurRangeFromTable);

  // ===== auto-restore & auto-run saat halaman/tabel siap =====
  let autoRanForKelas = ""; // guard agar tidak dobel
  async function autoApplyMurRangeIfAvailable(){
    const kelas = kelasNow(); const table = getSantriTable();
    if (!kelas || !table) { setTimeout(autoApplyMurRangeIfAvailable, 120); return; }
    if (autoRanForKelas === kelas) return;
    // tunggu baris tabel ada
    const rows = table.tBodies?.[0]?.rows || [];
    if (!rows.length){ setTimeout(autoApplyMurRangeIfAvailable, 120); return; }

    const { fromDate, toDate } = await getRangeForKelas(kelas);
    if (fromDate && toDate){
      // isi input overlay (kalau ada)
      if ($('#murRangeDari'))   $('#murRangeDari').value   = fromDate;
      if ($('#murRangeSampai')) $('#murRangeSampai').value = toDate;
      // langsung jalankan hitung
      await hitungTotalMurRangeFromTable();
      autoRanForKelas = kelas;
    }
  }

  // hook render
  function afterTableRenderedMurRange(){
    ensureMurRangeColumn();
    autoApplyMurRangeIfAvailable();
  }
  const _origLoad = window.loadSantriData;
  window.loadSantriData = async function(...args){
    if (typeof _origLoad === 'function') await _origLoad.apply(this, args);
    setTimeout(afterTableRenderedMurRange, 30);
  };

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', afterTableRenderedMurRange);
  } else {
    afterTableRenderedMurRange();
  }
})();
</script>


		

<script>
  // ====== KONFIG (opsional dari window.*) ======
  const JENJANG_MAX = Number(window.JENJANG_MAX ?? 9);             // 34 default; 0 = tanpa batas atas
  const JENJANG_SAFETY_CAP = Number(window.JENJANG_SAFETY_CAP ?? 1000); // darurat bila tanpa batas

  // ====== Helper jenjang dinamis ======
  function parseJenjang(v) {
    const m = /^A(\d+)$/.exec(String(v || "").trim());
    return m ? Number(m[1]) : null;
  }

  // kosong = valid; selain itu harus "A<number>" minimal A1, dan <= JENJANG_MAX (kecuali 0)
  function isValidJenjang(v, max = JENJANG_MAX) {
    if (!v) return true;
    const n = parseJenjang(v);
    if (!Number.isFinite(n) || n < 1) return false;
    if (!max || max === 0) return true; // tanpa batas atas
    return n <= max;
  }

  // Tambahkan A1..A{limit} yang belum ada (tidak merusak label existing)
  function extendJenjangOptions(selectEl, max = JENJANG_MAX) {
    if (!selectEl) return;
    const existing = new Set([...selectEl.options].map(o => String(o.value || "").trim()));
    const frag = document.createDocumentFragment();

    const limit = (!max || max === 0) ? JENJANG_SAFETY_CAP : max;
    for (let i = 1; i <= limit; i++) {
      const val = `A${i}`;
      if (!existing.has(val)) {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val; // label default untuk opsi baru
        frag.appendChild(opt);
      }
    }
    if (frag.childNodes.length) selectEl.appendChild(frag);
  }

  // ===== Tambah Santri =====
  function bukaModalSantri() {
    document.getElementById("modalSantri").style.display = "block";
    // Pastikan opsi jenjang ter-extend setiap buka modal (aman dipanggil berulang)
    const jenSel = document.getElementById("inputJenjang");
    if (jenSel) extendJenjangOptions(jenSel, JENJANG_MAX);
  }

  const semSel = document.getElementById("inputSemester");
  if (semSel) extendSemesterOptions(semSel);

  // Disesuaikan dengan pemanggilanmu: tutupModal('modalSantri')
  function tutupModal(id) {
    const modal = document.getElementById(id || "modalSantri");
    if (modal) modal.style.display = "none";
    // reset form
    document.getElementById("inputNama").value = "";
    document.getElementById("inputNis").value = "";
    document.getElementById("inputSemester").value = "1";
    const jenSel = document.getElementById("inputJenjang");
    if (jenSel) jenSel.value = ""; // reset ke opsi kosong
    document.getElementById("loadingTambahSantri").style.display = "none";
    const btn = document.getElementById("btnSimpanSantri");
    if (btn) { btn.disabled = false; btn.textContent = "Simpan"; btn.style.opacity = ""; btn.style.cursor = ""; }
  }

  // Extend opsi saat halaman siap (kalau modal dibuka pertama kali)
  document.addEventListener("DOMContentLoaded", () => {
    const jenSel = document.getElementById("inputJenjang");
    if (jenSel) extendJenjangOptions(jenSel, JENJANG_MAX);
  });

  async function simpanSantriBaru() {
    const nama     = document.getElementById("inputNama").value.trim();
    const nis      = document.getElementById("inputNis").value.trim();
    const semester = document.getElementById("inputSemester").value;
    const jenjang  = (document.getElementById("inputJenjang")?.value || "").trim();
    const kelas    = document.getElementById("kelas").value; // dropdown kelas utama

    // Validasi dasar
    if (!nama) { alert("Nama tidak boleh kosong."); return; }
    if (!nis)  { alert("NIS tidak boleh kosong.");  return; }
    if (!isValidSemester(semester)) {
  alert(`Semester harus 1-${SEMESTER_MAX}.`);
  return;
}
    if (!isValidJenjang(jenjang)) {
      alert(`Jenjang harus A1 - A${JENJANG_MAX || "‚àû"} (atau kosong).`);
      return;
    }

    const loadingEl = document.getElementById("loadingTambahSantri");
    const btn = document.getElementById("btnSimpanSantri");
    loadingEl.style.display = "block";
    if (btn) { btn.disabled = true; btn.textContent = "Menyimpan‚Ä¶"; btn.style.opacity = "0.6"; btn.style.cursor = "not-allowed"; }

    try {
      const res = await fetch("/api/tambahSantri", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nama, nis, semester, jenjang, kelas })
      });

      const data = await res.json().catch(() => ({}));
      loadingEl.style.display = "none";

      if (res.ok && (data?.success ?? true)) {
        alert("Santri berhasil ditambahkan!");
        tutupModal("modalSantri");
        location.reload(); // refresh map master (semester/jenjang)
      } else {
        alert("Gagal menambahkan: " + (data?.error || res.statusText));
        if (btn) { btn.disabled = false; btn.textContent = "Simpan"; btn.style.opacity = ""; btn.style.cursor = ""; }
      }
    } catch (err) {
      loadingEl.style.display = "none";
      alert("Terjadi kesalahan: " + err.message);
      if (btn) { btn.disabled = false; btn.textContent = "Simpan"; btn.style.opacity = ""; btn.style.cursor = ""; }
    }
  }
</script>


<script>
const btnHapusSantri = document.getElementById("btnHapusSantri");
const modalHapusSantri = document.getElementById("modalHapusSantri");
const listSantriHapus = document.getElementById("listSantriHapus");
const btnHapusTerpilih = document.getElementById("btnHapusTerpilih");
const btnTutupModal = document.getElementById("btnTutupModal");

// Tombol untuk menutup modal
btnTutupModal.addEventListener("click", () => {
  modalHapusSantri.style.display = "none";
});

// Tombol untuk membuka modal dan load santri
btnHapusSantri.addEventListener("click", async () => {
  modalHapusSantri.style.display = "flex";
  listSantriHapus.innerHTML = "<li>Loading...</li>";

  const kelas = kelasSelect.value; // Ambil kelas dari select
  try {
    const res = await fetch(`/api/ambilSantri?kelas=${kelas}`);
    const santriData = await res.json();

    if (!Array.isArray(santriData)) {
      console.error("Santri data bukan array:", santriData);
      listSantriHapus.innerHTML = "<li>Gagal load data</li>";
      return;
    }

    listSantriHapus.innerHTML = "";
    if (santriData.length === 0) {
      listSantriHapus.innerHTML = "<li>Tidak ada santri di kelas ini</li>";
      return;
    }

    santriData.forEach(s => {
      const li = document.createElement("li");
      li.style.marginBottom = "5px";
      li.innerHTML = `<label>
        <input type="checkbox" value="${s.id || s.nis}"> ${s.nama} (${s.id || s.nis})
      </label>`;
      listSantriHapus.appendChild(li);
    });
  } catch (err) {
    console.error(err);
    listSantriHapus.innerHTML = "<li>Gagal load data</li>";
  }
});

// Tombol hapus terpilih
btnHapusTerpilih.addEventListener("click", async () => {
  const checked = listSantriHapus.querySelectorAll("input:checked");
  if (checked.length === 0) return alert("Pilih santri terlebih dahulu");

  const kelas = kelasSelect.value;
  for (let c of checked) {
    const identifier = c.value;
    try {
      const res = await fetch(`/api/hapusSantri`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ kelas, identifier })
      });
      const result = await res.json();
      console.log("Hasil hapus:", result);
    } catch (err) {
      console.error("Gagal hapus:", err);
    }
  }

  modalHapusSantri.style.display = "none";

  // Refresh tabel utama
  if (typeof loadSantriData === "function") {
    loadSantriData();
  }
});
</script>


<script>
(() => {
  const elBtnOpen   = document.getElementById('btnPindahKelas');
  const elModal     = document.getElementById('modalPindahKelas');
  const elClose     = document.getElementById('closePindah');
  const elSantriSel = document.getElementById('selectSantriPindah');
  const elKelasWrap = document.getElementById('listKelasTujuan');
  const elDo        = document.getElementById('doPindah');
  const elStatus    = document.getElementById('statusPindah');

  const normKelas = (k) => (k?.startsWith('kelas_') ? k : `kelas_${k}`);

  async function ensureAbsensiAda(kelas, tanggal) {
    try {
      const url = `/api/getAbsensi?kelas=${encodeURIComponent(kelas)}&tanggal=${encodeURIComponent(tanggal)}&t=${Date.now()}`;
      const r = await fetch(url);
      return (r.status === 200 || r.status === 404);
    } catch { return false; }
  }

  let elStart = document.getElementById('startDateMove');
  function ensureStartDateInput() {
    if (!elStart) {
      const holder = document.createElement('div');
      holder.style.margin = '8px 0';
      holder.innerHTML = `
        <label><b>Mulai dari tanggal (opsional):</b></label><br/>
        <input type="date" id="startDateMove" style="width:100%;max-width:260px;">
      `;
      elDo.parentElement.insertBefore(holder, elDo);
      elStart = holder.querySelector('#startDateMove');
    }
  }

  elBtnOpen.addEventListener('click', openModal);
  elClose.addEventListener('click', () => elModal.style.display = 'none');

  async function openModal() {
    elModal.style.display = 'flex';
    elStatus.textContent = '';
    elDo.disabled = false;
    ensureStartDateInput();

    const kelasAsal = normKelas(kelasSelect.value);

    // 1) load santri
    try {
      const r = await fetch(`/api/ambilSantri?kelas=${encodeURIComponent(kelasAsal)}&t=${Date.now()}`);
      const data = await r.json();
      elSantriSel.innerHTML = (Array.isArray(data) ? data : []).map(s => {
        const id   = s.id   ?? '';
        const nis  = s.nis  ?? '';
        const nama = s.nama ?? '';
        return `<option value="${String(nis || id || '')}"
                        data-id="${String(id)}"
                        data-nis="${String(nis)}"
                        data-nama="${String(nama)}">
          ${nama} (${nis || id || '-'})
        </option>`;
      }).join('');
    } catch {
      elSantriSel.innerHTML = '';
    }

    // 2) load kelas tujuan
    try {
      const rK = await fetch(`/api/ambilKelas?t=${Date.now()}`);
      const kelasList = await rK.json();
      elKelasWrap.innerHTML = (Array.isArray(kelasList) ? kelasList : [])
        .map(normKelas)
        .filter(k => k !== kelasAsal)
        .map(k => `<label style="display:block;margin:4px 0;">
            <input type="radio" name="kelasTujuan" value="${k}"> ${k}
          </label>`).join('');
    } catch {
      elKelasWrap.innerHTML = '<em>Gagal memuat daftar kelas.</em>';
    }
  }

  async function postJSON(url, payload) {
    const res = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    let out = {};
    try { out = await res.json(); } catch {}
    return { res, out };
  }

  elDo.addEventListener('click', async () => {
    const kelasAsal   = normKelas(kelasSelect.value);
    const kelasTujuan = normKelas(document.querySelector('input[name="kelasTujuan"]:checked')?.value || '');
    const selected    = Array.from(elSantriSel.selectedOptions);

    if (!selected.length) { alert('Pilih minimal satu santri.'); return; }
    if (!kelasTujuan)     { alert('Pilih kelas tujuan.'); return; }

    const ids   = [...new Set(selected.map(o => (o.dataset.id  || '').trim()).filter(Boolean))];
    const nises = [...new Set(selected.map(o => (o.dataset.nis || '').trim()).filter(Boolean))];
    const names = [...new Set(selected.map(o => (o.dataset.nama || '').trim().toLowerCase()).filter(Boolean))];
    const identifiers = Array.from(new Set([...ids, ...nises, ...names])); // untuk roster

    const startDate = (elStart?.value || '').trim();

    elDo.disabled = true;
    elStatus.style.color = '#333';
    elStatus.textContent = startDate ? `Memproses mulai ${startDate}‚Ä¶` : 'Memproses semua tanggal‚Ä¶';

    try {
      // 1) Pindah ROSTER (dapat idMap untuk remap absensi)
      const { res: r1, out: o1 } = await postJSON('/api/pindahRosterKelas', {
        kelasAsal, kelasTujuan, identifiers
      });
      if (!r1.ok || !o1.success) {
        elStatus.style.color = 'red';
        elStatus.textContent = (o1.error || `HTTP ${r1.status}`) + (o1.detail ? `: ${o1.detail}` : '');
        elDo.disabled = false;
        return;
      }
      const idMap = Array.isArray(o1.idMap) ? o1.idMap : [];
      const payloadCommon = { kelasAsal, kelasTujuan, ids, nises, idMap };

      // 2) Pindah ABSENSI
      let r2, o2 = {};
      if (startDate) {
        r2 = await fetch('/api/pindahKelasMulaiTanggal', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ ...payloadCommon, startDate })
        });
        if (r2.status === 404) {
          // fallback: semua tanggal
          r2 = await fetch('/api/pindahKelasSemuaTanggal', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payloadCommon)
          });
        }
      } else {
        r2 = await fetch('/api/pindahKelasSemuaTanggal', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payloadCommon)
        });
      }
      try { o2 = await r2.json(); } catch {}
      if (!r2.ok || !o2.success) {
        elStatus.style.color = 'red';
        elStatus.textContent = (o2.error || `HTTP ${r2.status}`) + (o2.detail ? `: ${o2.detail}` : '');
        elDo.disabled = false;
        return;
      }

      // sukses
      elStatus.style.color = 'green';
      elStatus.textContent = `Selesai. Roster & absensi (${o2.totalMoved ?? 'n/a'} entri) dipindahkan${startDate ? ' sejak ' + startDate : ''}.`;

      // Sinkronkan UI
      if (window.tanggalFilterAkhir) {
        tanggalFilterAkhir.value = "";
        try { localStorage.removeItem("tanggalFilterAkhirTerakhir"); } catch(_){}
      }
      kelasSelect.value = kelasTujuan;
      try { localStorage.setItem("kelasTerakhir", kelasTujuan); } catch(_){}
      const today = new Date().toLocaleDateString('sv-SE');
      const tanggalAktif = (tanggalInput?.value || today);
      await ensureAbsensiAda(kelasTujuan, tanggalAktif);

      if (typeof loadSantriData === 'function') await loadSantriData();
      setTimeout(() => { elModal.style.display = 'none'; }, 800);

    } catch (e) {
      console.error(e);
      elStatus.style.color = 'red';
      elStatus.textContent = 'Kesalahan jaringan/servis.';
      elDo.disabled = false;
    }
  });
})();
</script>

  

  <script>
  function tutupModal(id) {
    const modal = document.getElementById(id);
    if (modal) {
      modal.style.display = "none";
    }
  }

    function tutupModal(id) {
  if (!id) return; // jika tidak ada ID, keluar saja
  const modal = document.getElementById(id);
  if (modal) {
    modal.style.display = "none";
  }
}
</script>

	  <script>
document.getElementById("login-form").addEventListener("submit", (e) => {
  e.preventDefault();
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  console.log("Login:", username, password);
  // proses login
});
</script>



<script>
// 1. Fungsi untuk memberi warna hanya huruf predikat
function bgHuruf(huruf, predikatText = "") {
  const warna = { A: "green", A: "green", B: "blue", C: "orange", D: "red" };
  // huruf diberi background, predikatText normal
  return `${predikatText} <span style="background-color:${warna[huruf]}; color:white; padding:0 4px; border-radius:3px;">${huruf}</span>`;
}

// 2. Data dari server / dataSantri
let dataSantri = []; // nanti diisi fetch atau data.push

// 3. Fungsi render tabel
function renderTabelPredikat() {
  dataSantri.forEach(data => {
    const cell = document.querySelector(`#row-${data.id} .nilai-ringkas`);
    if (!cell) return;
    cell.innerHTML = `<strong>${data.buttonCell.nilai.toFixed(1)}</strong> - ${bgHuruf(data.buttonCell.predikatHuruf, data.buttonCell.predikatText)}`;
  });
}
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const eye = document.getElementById("toggle-password");
  const input = document.getElementById("password");
  if (eye && input) {
    eye.addEventListener("click", () => {
      input.type = (input.type === "password") ? "text" : "password";
    });
  }
});
</script>

		
		
<script>
// ================================
// Soft-lock dropdown JENJANG/SEMESTER/KETERANGAN (warna normal)
// ================================
(function () {
  let nisObserver = null;

  function getTbody() {
    return document.querySelector("#tabelSantri tbody")
        || document.querySelector("table#data-santri tbody")
        || document.querySelector("tbody");
  }

  function getTargets(scope=document) {
    // HANYA 3 ini; tidak termasuk .absensi
    return Array.from(scope.querySelectorAll(
      "select.jenjang, select.semester, select.keterangan"
    ));
  }

  // ---- soft-lock: blok interaksi tanpa set disabled (warna tetap normal)
  function attachBlockers(sel){
    if (sel._nisBlockerAttached) return;

    // keluarkan dari tab order, tapi simpan nilai lama
    if (sel.dataset._tab_bak === undefined)
      sel.dataset._tab_bak = sel.getAttribute("tabindex") || "";
    sel.setAttribute("tabindex","-1");
    sel.setAttribute("aria-disabled","true"); // aksesibel; tidak mengubah warna

    const block = (e)=>{ e.preventDefault(); e.stopImmediatePropagation(); return false; };
    const events = ["mousedown","click","input","change","keydown","wheel","touchstart","pointerdown","contextmenu"];
    events.forEach(ev => sel.addEventListener(ev, block, true));

    sel._nisBlocker = { block, events };
    sel._nisBlockerAttached = true;
  }

  function detachBlockers(sel){
    if (!sel._nisBlockerAttached) return;
    const { block, events } = sel._nisBlocker || {};
    if (block) events.forEach(ev => sel.removeEventListener(ev, block, true));
    sel._nisBlocker = null;
    sel._nisBlockerAttached = false;

    // pulihkan tab order
    if (sel.dataset._tab_bak !== undefined){
      const v = sel.dataset._tab_bak;
      delete sel.dataset._tab_bak;
      if (v) sel.setAttribute("tabindex", v); else sel.removeAttribute("tabindex");
    }
    sel.removeAttribute("aria-disabled");
  }

  function applySoftLock(disabled){
    const tbody = getTbody();
    const list = tbody ? getTargets(tbody) : getTargets(document);
    list.forEach(sel => disabled ? attachBlockers(sel) : detachBlockers(sel));
  }

  // Fungsi publik: panggil true/false
  window.setNISDropdownDisabled = function(disabled){
    // hentikan observer lama
    if (nisObserver) { nisObserver.disconnect(); nisObserver = null; }

    applySoftLock(!!disabled);

    // kunci ulang bila tabel dirender ulang
    if (disabled) {
      const tbody = getTbody();
      if (!tbody) return;
      nisObserver = new MutationObserver(() => applySoftLock(true));
      nisObserver.observe(tbody, { childList: true, subtree: true });
    }
  };
})();
</script>


<script>
// ========================================
// Soft-lock tombol Recording (warna normal)
// ========================================
(function () {
  function getTargets() {
    const list = new Set();
    const byId1 = document.getElementById("record-start");  // id yang kamu sebut
    const byId2 = document.getElementById("recordButton");  // id lama di kode kamu
    if (byId1) list.add(byId1);
    if (byId2) list.add(byId2);
    document.querySelectorAll("button.rec-btn").forEach(b => list.add(b)); // jaga-jaga
    return Array.from(list);
  }

  function attachBlockers(btn){
    if (!btn || btn._nisBlockerAttached) return;

    // backup dan keluarkan dari tab order
    if (btn.dataset._tab_bak === undefined)
      btn.dataset._tab_bak = btn.getAttribute("tabindex") || "";
    btn.setAttribute("tabindex","-1");
    btn.setAttribute("aria-disabled","true"); // tidak ubah warna

    // kalau ada onclick inline, backup dan lepas
    if (btn.dataset._onclick_bak === undefined)
      btn.dataset._onclick_bak = btn.getAttribute("onclick") || "";
    if (btn.dataset._onclick_bak) btn.removeAttribute("onclick");

    const block = (e)=>{ e.preventDefault(); e.stopImmediatePropagation(); return false; };
    const events = ["click","mousedown","keydown","keyup","keypress","touchstart","pointerdown","contextmenu"];
    events.forEach(ev => btn.addEventListener(ev, block, true));

    btn._nisBlocker = { block, events };
    btn._nisBlockerAttached = true;
  }

  function detachBlockers(btn){
    if (!btn || !btn._nisBlockerAttached) return;
    const { block, events } = btn._nisBlocker || {};
    if (block) events.forEach(ev => btn.removeEventListener(ev, block, true));
    btn._nisBlocker = null;
    btn._nisBlockerAttached = false;

    // pulihkan tabindex & aria
    if (btn.dataset._tab_bak !== undefined){
      const v = btn.dataset._tab_bak;
      delete btn.dataset._tab_bak;
      if (v) btn.setAttribute("tabindex", v); else btn.removeAttribute("tabindex");
    }
    btn.removeAttribute("aria-disabled");

    // pulihkan onclick inline jika ada
    if (btn.dataset._onclick_bak !== undefined){
      if (btn.dataset._onclick_bak) btn.setAttribute("onclick", btn.dataset._onclick_bak);
      else btn.removeAttribute("onclick");
      delete btn.dataset._onclick_bak;
    }
  }

  function applyRecordSoftLock(disabled){
    getTargets().forEach(btn => disabled ? attachBlockers(btn) : detachBlockers(btn));
  }

  // expose
  window.setNISRecordDisabled = applyRecordSoftLock;
})();
</script>


<script>
// ===========================================
// Soft-lock + SAMARKAN tombol rekap
//   -> kecuali: download-pdf-santri & okSantriSelect (tetap aktif)
// ===========================================
(function () {
  let rekapObserver = null;

  // üü¢ ID yang DIIZINKAN klik walau mode NIS
  const ALLOW = new Set(["download-pdf-santri", "okSantriSelect", "cancelSantriSelect"]);

  function getRekapButtons() {
    const ids = [
      "download-pdf-rekap",
      "download-xls-rekap",
      "download-pdf-santri",   // dikecualikan
      "download-pdf-allkelas",
      "okSantriSelect",        // dikecualikan (tombol OK modal)
    ];
    const set = new Set();
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) set.add(el);
    });
    // jaring tambahan via class umum
    document.querySelectorAll("button.rekap-btn").forEach(b => set.add(b));
    return Array.from(set);
  }

  function attachBlockers(btn){
    if (!btn || btn._nisBlockerAttached) return;

    if (btn.dataset._tab_bak === undefined)
      btn.dataset._tab_bak = btn.getAttribute("tabindex") || "";
    btn.setAttribute("tabindex","-1");
    btn.setAttribute("aria-disabled","true");

    if (btn.dataset._onclick_bak === undefined)
      btn.dataset._onclick_bak = btn.getAttribute("onclick") || "";
    if (btn.dataset._onclick_bak) btn.removeAttribute("onclick");

    const block = (e)=>{ e.preventDefault(); e.stopImmediatePropagation(); return false; };
    const events = ["click","mousedown","keydown","keyup","keypress","touchstart","pointerdown","contextmenu"];
    events.forEach(ev => btn.addEventListener(ev, block, true));

    btn.classList.add("nis-masked");

    btn._nisBlocker = { block, events };
    btn._nisBlockerAttached = true;
  }

  function detachBlockers(btn){
    if (!btn) return;

    if (btn._nisBlockerAttached) {
      const { block, events } = btn._nisBlocker || {};
      if (block) events.forEach(ev => btn.removeEventListener(ev, block, true));
      btn._nisBlocker = null;
      btn._nisBlockerAttached = false;
    }

    if (btn.dataset._tab_bak !== undefined){
      const v = btn.dataset._tab_bak;
      delete btn.dataset._tab_bak;
      if (v) btn.setAttribute("tabindex", v); else btn.removeAttribute("tabindex");
    }
    btn.removeAttribute("aria-disabled");

    if (btn.dataset._onclick_bak !== undefined){
      if (btn.dataset._onclick_bak) btn.setAttribute("onclick", btn.dataset._onclick_bak);
      else btn.removeAttribute("onclick");
      delete btn.dataset._onclick_bak;
    }

    btn.classList.remove("nis-masked");
  }

  function applyRekapSoftLock(disabled){
    getRekapButtons().forEach(btn => {
      if (ALLOW.has(btn.id)) {
        // pengecualian: pastikan selalu aktif
        detachBlockers(btn);
        return;
      }
      disabled ? attachBlockers(btn) : detachBlockers(btn);
    });
  }

  // Drop-in replacement
  window.setNISRekapDisabled = function(disabled){
    if (rekapObserver) { rekapObserver.disconnect(); rekapObserver = null; }
    applyRekapSoftLock(!!disabled);
    if (disabled){
      rekapObserver = new MutationObserver(() => applyRekapSoftLock(true));
      rekapObserver.observe(document.body, { childList:true, subtree:true });
    }
  };

  // ‚úÖ Bersihkan jika "OK" sudah terlanjur tersamarkan saat skrip ini dimuat
  (function unmaskAllowedNow(){
    ALLOW.forEach(id => {
      const b = document.getElementById(id);
      if (b) detachBlockers(b);
    });
  })();
})();
</script>

<style>
/* gaya samaran untuk tombol yang dikunci */
.nis-masked {
  opacity: .5;
  filter: grayscale(70%);
  cursor: not-allowed !important;
}
</style>

<script>
(function(){
  const $ = s => document.querySelector(s);

  const modal     = $('#santriModalOverlay');
  const openBtn   = $('#download-pdf-santri');
  const selectEl  = $('#pdf-santri-select');

  // --- 1) Ambil NIS dari dashboard (paling sederhana & sinkron dengan login) ---
  function getNisFromDashboard(){
    const set = new Set();

    // 1a) Elemen yang menyimpan NIS via data-attribute
    document.querySelectorAll('[data-nis],[data-santri-nis],[data-user-nis],[data-nis-santri]').forEach(el=>{
      const v = (el.getAttribute('data-nis')
        || el.getAttribute('data-santri-nis')
        || el.getAttribute('data-user-nis')
        || el.getAttribute('data-nis-santri') || '').trim();
      if (v) set.add(v);
    });

    // 1b) Fallback: baca kolom bertitel "NIS" di tabel recent jika ada
    if (!set.size) {
      document.querySelectorAll('#recentTable, .recent-table, table').forEach(tb=>{
        const ths = tb.querySelectorAll('thead th');
        if (!ths.length) return;
        let nisIdx = -1;
        ths.forEach((th,i)=>{
          const t = (th.textContent||'').trim();
          if (/(^|\s)nis(\s|$)/i.test(t) && nisIdx === -1) nisIdx = i;
        });
        if (nisIdx >= 0) {
          tb.querySelectorAll('tbody tr').forEach(tr=>{
            const tds = tr.querySelectorAll('td');
            const raw = (tds[nisIdx]?.getAttribute('data-nis') || tds[nisIdx]?.textContent || '').trim();
            if (raw) set.add(raw);
          });
        }
      });
    }
    return [...set];
  }

  // --- 2) (Opsional) kalau dashboard belum tersedia, ambil dari login memory ---
  function getNisFromLoginMemory(){
    // Setelah login, kamu bisa set salah satu:
    // window.USER_NIS = ["c23","331"]  // array
    // localStorage.setItem('USER_NIS', '["c23","331"]')
    // sessionStorage.setItem('USER_NIS', '["c23","331"]')
    const fromWin = Array.isArray(window.USER_NIS) ? window.USER_NIS : [];
    const fromLS  = (()=>{ try{ return JSON.parse(localStorage.getItem('USER_NIS')||'[]'); }catch{return []} })();
    const fromSS  = (()=>{ try{ return JSON.parse(sessionStorage.getItem('USER_NIS')||'[]'); }catch{return []} })();
    return [...new Set([...(fromWin||[]), ...(fromLS||[]), ...(fromSS||[])].map(s=>String(s).trim()).filter(Boolean))];
  }

  // --- 3) Ambil peta Nama dari dashboard (opsional, biar labelnya "NIS ‚Äî Nama") ---
  function buildNameMapFromDashboard(){
    const map = new Map();
    document.querySelectorAll('#recentTable, .recent-table, table').forEach(tb=>{
      const ths = tb.querySelectorAll('thead th');
      if (!ths.length) return;
      let nisIdx=-1, nameIdx=-1;
      ths.forEach((th,i)=>{
        const t=(th.textContent||'').trim();
        if (/nis/i.test(t)  && nisIdx  === -1) nisIdx  = i;
        if (/nama/i.test(t) && nameIdx === -1) nameIdx = i;
      });
      if (nisIdx >= 0 && nameIdx >= 0) {
        tb.querySelectorAll('tbody tr').forEach(tr=>{
          const tds = tr.querySelectorAll('td');
          const nis  = (tds[nisIdx]?.getAttribute('data-nis') || tds[nisIdx]?.textContent || '').trim();
          const nama = (tds[nameIdx]?.textContent || '').trim();
          if (nis) map.set(nis, nama || '-');
        });
      }
    });
    return map; // Map<nis, nama>
  }

  // --- 4) Inti: populate dropdown SESEDERHANA mungkin ---
  function populateSantriFromLoginScope(){
    if (!selectEl) return;

    // Ambil dari dashboard; kalau belum ada ‚Üí fallback ke memori login
    let nisList = getNisFromDashboard();
    if (!nisList.length) nisList = getNisFromLoginMemory();

    if (!nisList.length) {
      selectEl.innerHTML = `<option value="">‚Äî Tidak ada NIS (cek login/dashboard) ‚Äî</option>`;
      return;
    }

    const nameMap = buildNameMapFromDashboard(); // boleh kosong; kita tetap tampilkan NIS saja
    const options = nisList
      .map(nis => ({ nis, nama: nameMap.get(nis) || '-' }))
      .sort((a,b) => (a.nama||'').localeCompare(b.nama||'', 'id'));

    selectEl.innerHTML = [
      `<option value="">‚Äî Pilih santri ‚Äî</option>`,
      ...options.map(o => `<option value="${o.nis}" data-nama="${o.nama.replace(/"/g,'&quot;')}">${o.nis} ‚Äî ${o.nama}</option>`)
    ].join('');
  }

  // --- 5) EXPOSE & OVERRIDE: paksa semua pemanggilan lama ikut versi sederhana ini ---
  window._populateSantriSelectSMART = populateSantriFromLoginScope;
  window._populateSantriSelect      = populateSantriFromLoginScope; // kalau ada kode lama, otomatis ikut SMART

  // --- 6) Hook tombol buka modal (kalau handler lamamu juga ada, ini tidak masalah) ---
  openBtn?.addEventListener('click', ()=>{
    if (modal) modal.style.display = 'flex';
    populateSantriFromLoginScope();
  });

  // (opsional) kalau mau refresh dropdown saat tanggal diubah, cukup panggil fungsi yang sama.
  // Tidak akan "melebar" karena sumbernya selalu dashboard/login, bukan roster penuh:
  // document.getElementById('pdf-start-date')?.addEventListener('change', populateSantriFromLoginScope);
  // document.getElementById('pdf-end-date')?.addEventListener('change',   populateSantriFromLoginScope);
})();
</script>


		

<!-- ===== Modal Editor Parsial ‚Äî Single Block ===== -->
<style>
  #editBtnIndex{
    position:fixed;right:16px;bottom:16px;z-index:9999;padding:10px 14px;border:0;border-radius:10px;
    background:#111831;color:#E6ECFF;box-shadow:0 6px 18px rgba(0,0,0,.25);cursor:pointer
  }
  #overlayEdit{display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.45);backdrop-filter:saturate(120%) blur(2px)}
  #overlayEdit, #overlayEdit * , #overlayEdit *::before, #overlayEdit *::after{box-sizing:border-box}
  #overlayEdit .panel{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    width:min(1080px,96vw);max-width:calc(100vw - 24px);
    height:min(86vh,760px);max-height:calc(100vh - 24px);
    background:#0b1020;color:#e6ecff;border:1px solid #2a3157;border-radius:20px;
    display:flex;flex-direction:column;overflow:hidden
  }
  #overlayEdit header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#1a2344;border-bottom:1px solid #2a3157}
  #overlayEdit header h3{margin:0;font-size:16px;font-weight:600}
  #overlayEdit .body{flex:1 1 auto;display:grid;gap:12px;align-items:stretch;grid-template-columns:1fr;padding:12px;min-width:0;min-height:0;overflow:hidden}
  #overlayEdit .editor{display:flex;flex-direction:column;gap:10px;min-width:0;min-height:0}
  #overlayEdit .editor textarea{
    flex:1 1 auto;min-width:0;min-height:0;width:100%;max-width:100%;height:100%;
    resize:none;overflow:auto;background:#0f152d;color:#e6ecff;border:1px solid #2a3157;border-radius:12px;
    padding:12px;font:13px ui-monospace,Consolas,Menlo,monospace;white-space:pre
  }
  #overlayEdit footer{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;border-top:1px solid #2a3157;background:#0f152d}
  #stagedBadge{font-size:12px;color:#c6ffde;background:#16321c;border:1px solid #1f5b33;padding:6px 10px;border-radius:999px}
  .btn-danger{border-color:#6b1f2d;background:#3a1a24;color:#ffd0d4}
  .btn-ok{border-color:#1f5b33;background:#16321c;color:#c6ffde}

  /* === Tombol inline (opsional) === */
  #editBtnIndex{
    position: static !important;
    right: auto !important;
    bottom: auto !important;
    z-index: auto !important;
    box-shadow: none !important;
    border-radius: 6px;
    background: #1e88e5 !important;
    color: #fff !important;
    border: 1px solid #ccc !important;
    padding: 10px 14px !important;
    cursor: pointer;
  }
  #editBtnIndex:hover{ background:#1565c0 !important; }
</style>

<div id="overlayEdit" role="dialog" aria-modal="true">
  <div class="panel">
    <header><h3>Editor Parsial (1 Blok)</h3></header>
    <div class="body">
      <section class="editor">
        <textarea id="editBox" spellcheck="false" placeholder="Memuat‚Ä¶"></textarea>
      </section>
    </div>
    <footer>
      <span id="stagedBadge">0 blok</span>
      <div style="display:flex;gap:8px">
        <button id="btnSaveAll" class="btn-ok">Save</button>
        <button id="btnReload">Reload</button>
        <button id="btnCloseModal" class="btn-danger">Close</button>
      </div>
      <span id="lockInfo" style="display:none"></span>
    </footer>
  </div>
</div>

<script>
(()=>{
  // ===== KONFIG REPO =====
  const API    = '/api/gitFile';
  const OWNER  = 'mrdickymiswardi';
  const REPO   = 'web';
  const BRANCH = 'main';
  const PATH   = 'index.html';

  // ===== STATE =====
  let fullText = '', lastSha = null;
  const STAGED = {}; // key -> view string yg DIEDIT (diambil dari single block)
  const $ = s => document.querySelector(s);

  // ===== UI =====
  const btnOpen    = $('#editBtnIndex');
  const modal      = $('#overlayEdit');
  const btnClose   = $('#btnCloseModal');
  const btnSaveAll = $('#btnSaveAll');
  const btnReload  = $('#btnReload');
  const box        = $('#editBox');
  const badge      = $('#stagedBadge');

  // ===== Admin Gate =====
  async function ensureAdmin(){
    if (sessionStorage.getItem('isAdmin') === '1') return true;
    const pass = prompt('Masukkan password admin:'); if (pass == null) return false;
    try{
      const r = await fetch('/api/cek-admin', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ password: pass })
      });
      const ct = r.headers.get('content-type') || '';
      let ok=false, msg='';
      if (ct.includes('application/json')){
        const js = await r.json();
        msg = String(js.message || js.msg || js.status || '').trim();
        const lower = msg.toLowerCase();
        ok = r.ok && (js.ok===true || js.authorized===true || js.status==='ok' ||
             lower.includes('authorized') || lower.includes('success') || lower.includes('berhasil') ||
             (lower.includes('valid') && !lower.includes('invalid')) || lower==='ok');
      } else {
        const tx=(await r.text()).trim(); const lower=tx.toLowerCase();
        msg=tx; ok = r.ok && (lower==='ok' || lower.includes('authorized') || lower.includes('success') ||
             lower.includes('berhasil') || (lower.includes('valid') && !lower.includes('invalid')));
      }
      if(!ok){ alert(msg || 'Password admin salah atau tidak diizinkan.'); return false; }
      sessionStorage.setItem('isAdmin','1'); return true;
    }catch(err){ console.error(err); alert('Gagal verifikasi admin: '+err.message); return false; }
  }

  // ===== DAFTAR ITEM (urutan tampil di 1 blok) =====
  const ITEMS = [
    {key:'LOGIN_H1',      label:'1) Judul Login (H1)',                                     editable:true,  required:true},
    {key:'DASHBOARD_H1',  label:'2) Judul Dashboard (H1)',                                 editable:true,  required:true},
    {key:'KELAS_BUNDLE',  label:'3) Kelas: semuaKelas + namaKelasCustom',                  editable:true,  required:false},
    {key:'KELOMPOK_FB',   label:'4) Fallback ‚ÄúKelompok Ust. ‚Ä¶‚Äù (untuk PDF)',               editable:true,  required:false},
    {key:'TABLE_HEADERS', label:'5) Header Tabel #santri-table',                           editable:true,  required:true},

    {key:'JENJANG_MAX',   label:'6) JENJANG_MAX (di loadSantriData)',                      editable:true,  required:true},
    {key:'JENJANG_MAX_CFG',label:'7) JENJANG_MAX (Konfigurasi Global di <script>)',        editable:true,  required:true},

    {key:'JENJANG_OPTS',  label:'8) <select class="jenjang"> (VALUE => LABEL)',            editable:true,  required:false},
    {key:'MODAL_SANTRI_JENJANG', label:'9) Modal Tambah Santri ‚Äî Jenjang (id="inputJenjang")', editable:true, required:true},

    {key:'SEMESTER_OPTS', label:'10) <select class="semester"> (VALUE => LABEL)',          editable:true,  required:false},
    {key:'KET_OPTS',      label:'11) <select class="keterangan"> (VALUE => LABEL)',        editable:true,  required:false},

    {key:'THMS_GLOBAL',   label:'12) THMS Global: const BATAS = {...}',                    editable:true,  required:true},
    {key:'THMS_PDF',      label:'13) THMS di PDF_percentCapaian()',                        editable:true,  required:true},
    {key:'THMS_FROM_T',   label:'14) THMS di hitungTotalAllJuzFromTable()',                editable:true,  required:true},
    {key:'THMS_AUTO',     label:'15) THMS di hitungTotalAllJuzOtomatis()',                 editable:true,  required:true},

    {key:'PDF_REKAP_LOK',   label:'16) PDF Rekap ‚Äî Nama Lokasi',                           editable:true,  required:true},
    {key:'PDF_ALL_LOK',     label:'17) PDF All Kelas ‚Äî Nama Lokasi',                       editable:true,  required:true},
    {key:'PDF_SANTRI_LOK',  label:'18) PDF Per Santri ‚Äî Nama Lokasi',                      editable:true,  required:true},

    {key:'PDF_REKAP_TTD',   label:'19) PDF Rekap ‚Äî Label TTD (2 baris: Mengetahui / Pengampu)', editable:true, required:true},
    {key:'PDF_ALL_TTD',     label:'20) PDF All Kelas ‚Äî Label TTD (2 baris)',               editable:true,  required:true},
    {key:'PDF_SANTRI_TTD',  label:'21) PDF Per Santri ‚Äî Label TTD (2 baris)',              editable:true,  required:true},

    {key:'THMS_JUZLIST_JUZOVERLAY', label:'22) THMS ‚Äî Juz List di #juzOverlay (isi <li>‚Ä¶)</li>', editable:true, required:true},
    {key:'THMS_JUZLIST_MURRANGE',   label:'23) THMS ‚Äî Juz List di #murRangeOverlay (isi <li>‚Ä¶)</li>', editable:true, required:true},
  ];
  const ITEM = Object.fromEntries(ITEMS.map(i=>[i.key,i]));

  // ===== OPEN/CLOSE =====
  btnOpen.onclick = async () => {
    if (!await ensureAdmin()) return;
    await ensureLoaded(true);
    box.value = buildMasterBlock();
    modal.style.display = 'block';
    parseMasterIntoStaged(); // inisialisasi badge
    updateBadge();
  };
  btnClose.onclick = () => { modal.style.display = 'none'; };

  btnReload.onclick = async () => {
    if (!confirm('Muat ulang dari file dan BUANG perubahan di editor?')) return;
    await ensureLoaded(true);
    box.value = buildMasterBlock();
    parseMasterIntoStaged();
    updateBadge();
  };

  btnSaveAll.onclick = async () => {
    parseMasterIntoStaged(); // ambil dari single block
    if (Object.keys(STAGED).length===0) return alert('Tidak ada blok terdeteksi.');
    const patch = buildPatchTasks(); if (patch.error) return alert(patch.error);

    let updated = fullText;
    for (const t of patch.tasks.sort((a,b)=>b.start-a.start)){
      updated = updated.slice(0,t.start) + t.content + updated.slice(t.end);
    }

    btnSaveAll.disabled = true; btnSaveAll.textContent = 'Menyimpan‚Ä¶';
    try{
      const r = await fetch(API,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          action:'put', owner:OWNER, repo:REPO, branch:BRANCH, path:PATH,
          content: updated, message:`bulk edit (single-block) di ${PATH}`, sha:lastSha
        })
      });
      if (!r.ok) throw new Error(await r.text());
      const js = await r.json();
      fullText = updated; if (js.commit) lastSha = js.commit;
      alert('Perubahan tersimpan.');
      // refresh tampilan editor dari sumber terbaru
      box.value = buildMasterBlock();
      parseMasterIntoStaged(); updateBadge();
    }catch(err){
      console.error(err); alert('Gagal menyimpan: '+err.message);
    }finally{
      btnSaveAll.disabled = false; btnSaveAll.textContent = 'Save';
    }
  };

  // ===== FETCH file =====
  async function ensureLoaded(force=false){
    if (fullText && !force) return;
    const r = await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'get',owner:OWNER,repo:REPO,branch:BRANCH,path:PATH})});
    if (!r.ok){ alert('Gagal GET index.html'); throw new Error(await r.text()); }
    const js = await r.json();
    fullText = js.content||''; lastSha = js.sha||null;
  }

  // ====== MARKER UTILS (single-block) ======
  const openMark = k => `/*[[${k}]]*/`;
  const closeMark= k => `/*[[/${k}]]*/`;

  function buildMasterBlock(){
    const lines = [];
    lines.push('// === Petunjuk Singkat ===');
    lines.push('// - Setiap bagian dibatasi marker: /*[[KEY]]*/ ... /*[[/KEY]]*/');
    lines.push('// - Jangan hapus marker. Ubah isi di tengahnya.');
    lines.push('');

    for (const it of ITEMS){
      const view = buildView(it.key) ?? '';
      lines.push(`// === ${it.label} ===`);
      lines.push(openMark(it.key));
      lines.push(view);
      lines.push(closeMark(it.key));
      lines.push(''); // spasi antar blok
    }
    return lines.join('\n');
  }

  function parseMasterIntoStaged(){
    // kosongkan
    for (const k of Object.keys(STAGED)) delete STAGED[k];

    const text = box.value || '';
    for (const it of ITEMS){
      const re = new RegExp(
        escapeReg(openMark(it.key)) + '([\\s\\S]*?)' + escapeReg(closeMark(it.key)),
        'i'
      );
      const m = re.exec(text);
      if (m) STAGED[it.key] = trimKeepNewlineEdges(m[1]);
    }
  }

  function updateBadge(){
    const n = Object.keys(STAGED).length;
    badge.textContent = `${n} blok`;
  }

  function trimKeepNewlineEdges(s){
    // buang satu newline di awal/akhir jika dobel spasi tak perlu
    return String(s).replace(/^\n+/, '').replace(/\n+$/, '');
  }
  function escapeReg(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

  // ===== Segment finders (tetap sama seperti sebelumnya) =====
  function h1InsideDiv(divId){
    const t = fullText;
    const reDiv = new RegExp(`<div[^>]*id=["']${divId}["'][^>]*>`, 'i');
    const d = t.search(reDiv); if (d<0) return null;
    const after = t.slice(d);
    const mOpen = after.match(/<h1[^>]*>/i); if (!mOpen) return null;
    const startTag = d + mOpen.index; const innerStart = startTag + mOpen[0].length;
    const closeRel = t.slice(innerStart).search(/<\/h1>/i); if (closeRel<0) return null;
    const innerEnd = innerStart + closeRel;
    return {start:innerStart, end:innerEnd, text:t.slice(innerStart,innerEnd)};
  }
  function byRegex(re){
    re.lastIndex=0; const t=fullText; const m=re.exec(t); if (!m) return null;
    const inner=m[1]??''; const innerStart=m.index + m[0].indexOf(inner); const innerEnd=innerStart+inner.length;
    return {start:innerStart, end:innerEnd, text:inner};
  }
  function findTheadThCells(){
    const seg = byRegex(/<table[^>]*id=["']santri-table["'][^>]*>[\s\S]{0,3000}?<thead>([\s\S]*?)<\/thead>/i);
    if (!seg) return null;
    const html = seg.text; const base = seg.start;
    const re = /<th\b[^>]*>([\s\S]*?)<\/th>/gi;
    const cells=[]; let m;
    while((m=re.exec(html))){
      const inner = m[1]||'';
      const innerStart = base + m.index + m[0].indexOf(inner);
      const innerEnd   = innerStart + inner.length;
      cells.push({start:innerStart,end:innerEnd,text:inner});
    }
    return {cells, count:cells.length};
  }
  function findOptionsInSelect(cls){
    const seg = byRegex(new RegExp(`<select[^>]*class=["']${cls}["'][^>]*>([\\s\\S]*?)<\\/select>`,'i'));
    if (!seg) return null;
    const html = seg.text, base = seg.start;
    const re = /<option\b[^>]*value=["']([^"']*)["'][^>]*>([\s\S]*?)<\/option>/gi;
    const items=[]; let m;
    while((m=re.exec(html))){
      const value = m[1]; const label = m[2]||'';
      const whole = m[0];
      const wholeStart = base + m.index;
      const wholeEnd   = wholeStart + whole.length;
      const labelStart = base + m.index + whole.indexOf(label);
      const labelEnd   = labelStart + label.length;
      items.push({value, label, wholeStart, wholeEnd, labelStart, labelEnd});
    }
    return {items, innerStart: seg.start, innerEnd: seg.end, innerText: seg.text};
  }
  function findOptionsInSelectById(id){
    const seg = byRegex(new RegExp(`<select[^>]*id=["']${id}["'][^>]*>([\\s\\S]*?)<\\/select>`,'i'));
    if (!seg) return null;
    const html = seg.text, base = seg.start;
    const re = /<option\b[^>]*value=["']([^"']*)["'][^>]*>([\s\S]*?)<\/option>/gi;
    const items=[]; let m;
    while((m=re.exec(html))){
      const value = m[1];
      const label = (m[2]||'').trim();
      const whole = m[0];
      const wholeStart = base + m.index;
      const wholeEnd   = wholeStart + whole.length;
      const labelStart = base + m.index + whole.indexOf(label);
      const labelEnd   = labelStart + label.length;
      items.push({value, label, wholeStart, wholeEnd, labelStart, labelEnd});
    }
    return {items, innerStart: seg.start, innerEnd: seg.end, innerText: seg.text};
  }
  function findUlJuzInnerIn(containerId){
    const t = fullText;
    const reContainer = new RegExp(`<div[^>]*id=["']${containerId}["'][^>]*>`, 'i');
    const pos = t.search(reContainer);
    if (pos < 0) return null;
    const after = t.slice(pos);
    const mUl = after.match(/<ul[^>]*class=["']juz-list["'][^>]*>([\s\S]*?)<\/ul>/i);
    if (!mUl) return null;
    const inner = mUl[1] || '';
    const innerStart = pos + mUl.index + mUl[0].indexOf(inner);
    const innerEnd   = innerStart + inner.length;
    return {start: innerStart, end: innerEnd, text: inner};
  }
  function findJenjangMax(){
    return byRegex(/function\s+loadSantriData\s*\([^)]*\)\s*{[\s\S]{0,4000}?const\s+JENJANG_MAX\s*=\s*Number\(\s*window\.JENJANG_MAX\s*\?\?\s*(\d+)\s*\)/i);
  }
  function findJenjangMaxConfig(){
    return byRegex(/\/\/\s*=+\s*KONFIG[^\n]*\n[\s\S]{0,500}?const\s+JENJANG_MAX\s*=\s*Number\(\s*window\.JENJANG_MAX\s*\?\?\s*(\d+)\s*\)/i);
  }
  function findPdfLok(funcName){
    const re = new RegExp(
      `function\\s+${funcName}\\s*\\([^)]*\\)\\s*{[\\s\\S]{0,80000}?doc\\.text\\(\\s*\\\`([^\\\`]*?),\\s*\\$\\{ttdDate\\}\\\`\\s*,\\s*margin\\.left\\s*\\+\\s*totalW\\s*,\\s*y\\s*,\\s*\\{[^}]*align\\s*:\\s*'right'[^}]*\\}[^)]*\\)`,
      'i'
    );
    return byRegex(re);
  }
  function findPdfTtd(funcName){
    const re = new RegExp(
      `function\\s+${funcName}\\s*\\([^)]*\\)\\s*{[\\s\\S]{0,80000}?doc\\.text\\(\\s*['"]([^'"]*)['"]\\s*,\\s*leftX\\s*,\\s*headY\\s*\\)\\s*;\\s*doc\\.text\\(\\s*['"]([^'"]*)['"]\\s*,\\s*rightX\\s*,\\s*headY\\s*\\)`,
      'i'
    );
    const t = fullText; const m = re.exec(t);
    if (!m) return null;
    const whole = m[0];
    const wholeStart = m.index;
    const offset1 = whole.indexOf(m[1]);
    const offset2 = whole.lastIndexOf(m[2]);
    return {
      left:  { start: wholeStart + offset1, end: wholeStart + offset1 + m[1].length,  text: m[1] },
      right: { start: wholeStart + offset2, end: wholeStart + offset2 + m[2].length,  text: m[2] }
    };
  }

  // ===== buildView (ambil isi sekarang untuk tiap key) =====
  function buildView(key){
    const seg = getSegment(key); if (!seg) return '';
    if (key==='LOGIN_H1' || key==='DASHBOARD_H1') return seg.text.trim();

    if (key==='TABLE_HEADERS'){
      const {cells} = seg; return cells.map(c=>c.text.trim()).join('\n');
    }
    if (key==='JENJANG_OPTS' || key==='SEMESTER_OPTS' || key==='KET_OPTS'){
      return seg.items.map(it=>`${it.value} => ${decodeEntities((it.label||'').trim())}`).join('\n');
    }
    if (key==='KELAS_BUNDLE'){
      const arrNums = (seg.arr.text.match(/"kelas_(\d+)"/g)||[]).map(s=>s.replace(/[^0-9]/g,''));
      const objPairs = [];
      (seg.obj.text.match(/kelas_(\d+)\s*:\s*"([^"]*)"/g)||[]).forEach(s=>{
        const m = s.match(/kelas_(\d+)\s*:\s*"([^"]*)"/); if (m) objPairs.push([m[1], m[2]]);
      });
      return [
        '/* === semuaKelas (ISIKAN ANGKA, koma-berpisah) === */',
        arrNums.join(','),
        '',
        '/* === namaKelasCustom (format: ANGKA = Nama) === */',
        ...objPairs.map(([num, nama])=>`${num} = ${nama}`)
      ].join('\n');
    }
    if (key==='KELOMPOK_FB'){
      const lines=[]; (seg.text.match(/kelas_(\d+)\s*:\s*"([^"]*)"/g)||[]).forEach(s=>{
        const m=s.match(/kelas_(\d+)\s*:\s*"([^"]*)"/); if (m) lines.push(`${m[1]} = ${m[2]}`);
      }); return lines.join('\n');
    }
    if (key==='THMS_GLOBAL' || key==='THMS_PDF' || key==='THMS_FROM_T' || key==='THMS_AUTO'){
      const pairs = parseObjectPairs(seg.text);
      const ks = Object.keys(pairs).map(Number).sort((a,b)=>a-b);
      return ks.map(k => `${k}=${pairs[k]}`).join('\n');
    }
    if (key==='JENJANG_MAX' || key==='JENJANG_MAX_CFG') return String(seg.text).trim();

    if (key==='PDF_REKAP_LOK' || key==='PDF_ALL_LOK' || key==='PDF_SANTRI_LOK'){
      return String(seg.text).trim();
    }
    if (key==='PDF_REKAP_TTD' || key==='PDF_ALL_TTD' || key==='PDF_SANTRI_TTD'){
      return `${seg.left.text}\n${seg.right.text}`;
    }
    if (key==='MODAL_SANTRI_JENJANG'){
      return seg.items.map(it=>`${it.value} => ${decodeEntities(it.label)}`).join('\n');
    }
    if (key==='THMS_JUZLIST_JUZOVERLAY' || key==='THMS_JUZLIST_MURRANGE'){
      return seg.text.trim();
    }
    return (seg.text||'').trim();
  }

  function getSegment(key){
    switch(key){
      case 'LOGIN_H1':      return h1InsideDiv('login-card');
      case 'DASHBOARD_H1':  return h1InsideDiv('dashboard-card');
      case 'KELAS_BUNDLE': {
        const arr = byRegex(/function\s+aturDropdownKelas\s*\([^)]*\)\s*{[\s\S]{0,4000}?const\s+semuaKelas\s*=\s*\[([\s\S]*?)\];/i);
        const obj = byRegex(/const\s+namaKelasCustom\s*=\s*{([\s\S]*?)}\s*;/i);
        if (!arr || !obj) return null; return {bundle:true, arr, obj};
      }
      case 'KELOMPOK_FB':  return byRegex(/custom\s*=\s*window\.namaKelasCustom\s*\|\|\s*window\.NAMA_KELAS_CUSTOM\s*\|\|\s*{([\s\S]*?)}\s*;/i);
      case 'TABLE_HEADERS':return findTheadThCells();
      case 'JENJANG_OPTS': return findOptionsInSelect('jenjang');

      case 'JENJANG_MAX':     return findJenjangMax();
      case 'JENJANG_MAX_CFG': return findJenjangMaxConfig();

      case 'SEMESTER_OPTS': return findOptionsInSelect('semester');
      case 'KET_OPTS':      return findOptionsInSelect('keterangan');
      case 'THMS_GLOBAL':   return byRegex(/const\s+BATAS\s*=\s*{([\s\S]*?)}\s*;/i);
      case 'THMS_PDF':      return byRegex(/function\s+PDF_percentCapaian\s*\([^)]*\)\s*{[\s\S]{0,2000}?const\s+batasSemester\s*=\s*{([\s\S]*?)}\s*;/i);
      case 'THMS_FROM_T':   return byRegex(/function\s+hitungTotalAllJuzFromTable\s*\([^)]*\)\s*{[\s\S]{0,6000}?const\s+batasSemester\s*=\s*{([\s\S]*?)}\s*;/i);
      case 'THMS_AUTO':     return byRegex(/function\s+hitungTotalAllJuzOtomatis\s*\([^)]*\)\s*{[\s\S]{0,6000}?const\s+batasSemester\s*=\s*{([\s\S]*?)}\s*;/i);

      case 'PDF_REKAP_LOK':  return findPdfLok('pdfRekapDownload');
      case 'PDF_ALL_LOK':    return findPdfLok('pdfAllKelasDownload');
      case 'PDF_SANTRI_LOK': return findPdfLok('pdfSantriDownload');

      case 'PDF_REKAP_TTD':  return findPdfTtd('pdfRekapDownload');
      case 'PDF_ALL_TTD':    return findPdfTtd('pdfAllKelasDownload');
      case 'PDF_SANTRI_TTD': return findPdfTtd('pdfSantriDownload');

      case 'MODAL_SANTRI_JENJANG':     return findOptionsInSelectById('inputJenjang');
      case 'THMS_JUZLIST_JUZOVERLAY':  return findUlJuzInnerIn('juzOverlay');
      case 'THMS_JUZLIST_MURRANGE':    return findUlJuzInnerIn('murRangeOverlay');
    }
    return null;
  }

  // ===== Build patch (pakai STAGED hasil parse single block) =====
  function buildPatchTasks(){
    const tasks = [];
    const notFound = [];

    for (const key of Object.keys(STAGED)){
      const rules = ITEM[key] || {};
      const view  = STAGED[key];
      const seg   = getSegment(key);
      if (!seg){ notFound.push(key); continue; }

      // 1 & 2: H1
      if (key==='LOGIN_H1' || key==='DASHBOARD_H1'){
        const val = (view||'').trim();
        if (rules.required && !val) return {error:`${rules.label||key}: tidak boleh kosong.`};
        tasks.push({start:seg.start, end:seg.end, content:escapeHtml(val)});
        continue;
      }

      // 5: <th>
      if (key==='TABLE_HEADERS'){
        const lines = (view||'').split('\n'); const {cells}=seg;
        if (lines.length!==cells.length) return {error:`${rules.label||key}: jumlah baris (${lines.length}) harus = jumlah <th> (${cells.length}).`};
        for (let i=0;i<cells.length;i++){
          const txt=(lines[i]??'').trim();
          if (!txt) return {error:`${rules.label||key}: header ke-${i+1} tidak boleh kosong.`};
          tasks.push({start:cells[i].start, end:cells[i].end, content:escapeHtml(txt)});
        }
        continue;
      }

      // 7‚Äì9 dll: <select> options by class
      if (key==='JENJANG_OPTS' || key==='SEMESTER_OPTS' || key==='KET_OPTS'){
        const selCls = (key==='JENJANG_OPTS' ? 'jenjang' : key==='SEMESTER_OPTS' ? 'semester' : 'keterangan');
        const segSel = getSegment(key);

        const lines=(view||'').split('\n').map(s=>s.trim()).filter(Boolean);
        const pairs=[];
        for (const line of lines){
          const mm=line.match(/^([^=]*)=>(.*)$/);
          if (!mm) return {error:`${rules.label||key}: format baris invalid: "${line}". Contoh: A15 => 2A`};
          const value=(mm[1]||'').trim();
          const label=(mm[2]||'').trim();
          if (selCls!=='keterangan' && value==='') return {error:`${rules.label||key}: VALUE tidak boleh kosong.`};
          pairs.push({value,label});
        }
        function optLine(cls, value, label){
          const v = value.replace(/"/g,'&quot;');
          const lbl = escapeHtml(label);
          if (cls==='jenjang')  return `    <option value="${v}" \${jenNow === '${v}' ? 'selected' : ''}>${lbl}</option>`;
          if (cls==='semester') return `    <option value="${v}" \${String(semNow) === '${v}' ? 'selected' : ''}>${lbl}</option>`;
          if (v==='') return `    <option value="" \${!ketNow ? 'selected' : ''}></option>`;
          return `    <option value="${v}" \${ketNow === '${v}' ? 'selected' : ''}>${lbl}</option>`;
        }
        const inner=(pairs.length?pairs.map(p=>optLine(selCls,p.value,p.label)).join('\n'):'');
        const newInner=(inner?'\n'+inner+'\n  ':'');
        tasks.push({ start: segSel.innerStart, end: segSel.innerEnd, content: newInner });
        continue;
      }

      // 3: KELAS_BUNDLE
      if (key==='KELAS_BUNDLE'){
        const mArr = view.match(/\/\*\s*===\s*semuaKelas.*?\*\/\s*([\s\S]*?)\n\s*\/\*/i);
        const mObj = view.match(/\/\*\s*===\s*namaKelasCustom.*?\*\/\s*([\s\S]*)$/i);
        if(!mArr || !mObj) return {error:`${rules.label||key}: format tidak valid. Jangan hapus marker komentar di dalam blok.`};

        const nums=mArr[1].replace(/\s+/g,'').split(',').filter(Boolean);
        const badNum=nums.find(n=>!/^\d+$/.test(n)); if (badNum) return {error:`${rules.label||key}: angka kelas tidak valid: ${badNum}`};

        const arrContent=nums.map((n,i)=>(i%6===0?'\n    ':'')+`"kelas_${n}"`).join(',')+(nums.length?'\n  ':'');
        const newArrInner=arrContent.trim()?('  '+arrContent.trim()+'\n'):'';

        const objPairs=mObj[1].split('\n').map(s=>s.trim()).filter(Boolean).map(line=>{
          const mm=line.match(/^(\d+)\s*=\s*(.*)$/); return mm?[mm[1],mm[2]]:null;
        }).filter(Boolean);
        const newObjInner=objPairs.map(([n,nama])=>`  kelas_${n}: "${nama}"`).join(',\n');

        tasks.push({start:seg.arr.start, end:seg.arr.end, content:newArrInner.replace(/\s+$/,'')});
        tasks.push({start:seg.obj.start, end:seg.obj.end, content:newObjInner});
        continue;
      }

      // 4: Fallback Kelompok
      if (key==='KELOMPOK_FB'){
        const lines=(view||'').split('\n').map(s=>s.trim()).filter(Boolean);
        const entries=[];
        for (const line of lines){
          const m=line.match(/^(\d+)\s*=\s*(.*)$/);
          if(!m) return {error:`${rules.label||key}: baris tidak valid: "${line}" (pakai format: ANGKA = Nama)`};
          entries.push({num:m[1], name:m[2]});
        }
        const content=entries.map(e=>`  kelas_${e.num}: "${e.name}"`).join(',\n');
        tasks.push({start:seg.start, end:seg.end, content});
        continue;
      }

      // 10‚Äì13: THMS maps
      if (key==='THMS_GLOBAL' || key==='THMS_PDF' || key==='THMS_FROM_T' || key==='THMS_AUTO'){
        const map=parseLinesKeyVal(view); const ks=Object.keys(map);
        if(ks.length===0) return {error:`${rules.label||key}: isi minimal satu pasangan k:v (mis. 1: 5)`};
        const content=Object.keys(map).sort((a,b)=>Number(a)-Number(b)).map(k=>`${k}: ${map[k]}`).join(', ');
        tasks.push({start:seg.start, end:seg.end, content});
        continue;
      }

      // 6: JENJANG_MAX (loadSantriData) harus >0
      if (key==='JENJANG_MAX'){
        const trimmed=String(view||'').trim();
        if (!trimmed) return {error:`${rules.label||key}: tidak boleh kosong.`};
        const num=Number(trimmed);
        if(!Number.isInteger(num) || num<=0) return {error:`${rules.label||key}: harus bilangan bulat > 0.`};
        tasks.push({start:seg.start, end:seg.end, content:String(num)});
        continue;
      }
      // 7: JENJANG_MAX_CFG (global) >=0
      if (key==='JENJANG_MAX_CFG'){
        const trimmed=String(view||'').trim();
        if (trimmed==='') return {error:`${rules.label||key}: tidak boleh kosong.`};
        const num=Number(trimmed);
        if(!Number.isInteger(num) || num<0) return {error:`${rules.label||key}: harus bilangan bulat ‚â• 0 (0 = tanpa batas).`};
        tasks.push({start:seg.start, end:seg.end, content:String(num)});
        continue;
      }

      // Lokasi
      if (key==='PDF_REKAP_LOK' || key==='PDF_ALL_LOK' || key==='PDF_SANTRI_LOK'){
        const val=(view||'').trim(); if(!val) return {error:`${rules.label||key}: tidak boleh kosong.`};
        tasks.push({start:seg.start, end:seg.end, content:escapeHtml(val)});
        continue;
      }

      // TTD (2 baris)
      if (key==='PDF_REKAP_TTD' || key==='PDF_ALL_TTD' || key==='PDF_SANTRI_TTD'){
        const lines=String(view||'').split('\n');
        const left=(lines[0]||'').trim(); const right=(lines[1]||'').trim();
        if(!left || !right) return {error:`${rules.label||key}: isi 2 baris: baris-1 label kiri, baris-2 label kanan.`};
        tasks.push({start:seg.left.start, end:seg.left.end, content:escapeHtml(left)});
        tasks.push({start:seg.right.start, end:seg.right.end, content:escapeHtml(right)});
        continue;
      }

      // Modal Tambah Santri ‚Äî Jenjang (id="inputJenjang")
      if (key==='MODAL_SANTRI_JENJANG'){
        const lines=(view||'').split('\n').map(s=>s.trim());
        const pairs=[];
        for (const line of lines){
          if (!line) continue;
          const mm=line.match(/^([^=]*)=>(.*)$/);
          if(!mm) return {error:`${rules.label||key}: format baris invalid: "${line}". Contoh: A1 => A1`};
          pairs.push({value:(mm[1]||'').trim(), label:(mm[2]||'').trim()});
        }
        function optLine(value,label){
          const v=String(value).replace(/"/g,'&quot;'); const lbl=escapeHtml(label);
          if (v==='') return `  <option value=""></option>`;
          return `  <option value="${v}">${lbl}</option>`;
        }
        const inner=pairs.map(p=>optLine(p.value,p.label)).join('\n');
        const newInner=(inner?'\n'+inner+'\n  ':'');
        tasks.push({start:seg.innerStart, end:seg.innerEnd, content:newInner});
        continue;
      }

      // Dua UL THMS (isi <li>‚Ä¶)
      if (key==='THMS_JUZLIST_JUZOVERLAY' || key==='THMS_JUZLIST_MURRANGE'){
        const html=String(view||'').trim();
        tasks.push({start:seg.start, end:seg.end, content:html});
        continue;
      }
    }

    if (notFound.length) return {error:`Bagian tidak ditemukan: ${notFound.join(', ')}`};
    return {tasks};
  }

  // ===== Helpers =====
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function decodeEntities(s){ return s.replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&').replace(/&quot;/g,'"').replace(/&#39;/g,"'"); }
  function parseObjectPairs(inner){
    const out={}; (inner.match(/(\d+)\s*:\s*(\d+)/g)||[]).forEach(x=>{ const m=x.match(/(\d+)\s*:\s*(\d+)/); if(m) out[m[1]]=Number(m[2]); });
    return out;
  }
  function parseLinesKeyVal(view){
    const out={}; String(view||'').split('\n').forEach(line=>{
      const m=line.trim().match(/^(\d+)\s*[:=]\s*(\d+)\s*$/); if (m) out[m[1]]=Number(m[2]);
    }); return out;
  }
})();
</script>
<!-- ===== /Modal Editor Parsial ‚Äî Single Block ===== -->



</body>
</html>
